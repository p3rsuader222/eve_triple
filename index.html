<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MUNKE</title>
    <link rel="icon" type="image/png" sizes="32x32" href="images/favicon_munke.png">
    <link rel="shortcut icon" type="image/png" href="images/favicon_munke.png">
    <style>
        :root {
            --primary: #007AFF;
            /* Apple Blue */
            --primary-dark: #0062cc;
            --secondary: #5856D6;
            /* Indigo */
            --success: #34C759;
            --bg-glass: rgba(255, 255, 255, 0.85);
            /* Slightly more transparent for blur */
            --surface-glass: rgba(255, 255, 255, 0.6);
            --text-main: #1D1D1F;
            /* Apple Black */
            --text-secondary: #86868B;
            --border-light: rgba(60, 60, 67, 0.12);
            /* Apple Separator Color */
            --shadow-lg: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
            /* Softer, deeper shadow */
            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --radius-lg: 30px;
            /* Larger, smoother rounded corners */
            --radius-md: 20px;
            --radius-sm: 12px;
            --font-stack: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --bg-solid: #F5F5F7;
            /* Apple Soft Neutral Gray */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: var(--font-stack);
        }

        html {
            scrollbar-gutter: stable;
            /* FIX: Prevents layout shift when scrollbar appears */
        }

        body {
            background-color: var(--bg-solid);
            min-height: 100vh;
            padding: 40px 20px;
            color: var(--text-main);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            position: relative;
            transition: background-color 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Layered background for smooth transitions */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('images/background.png');
            background-size: auto;
            background-position: top left;
            background-repeat: repeat;
            background-attachment: fixed;
            z-index: -1;
            transition: opacity 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 1;
        }

        body.no-bg::before {
            opacity: 0;
        }

        body.no-bg {
            background-color: var(--bg-solid);
        }

        .container {
            width: 100%;
            max-width: 950px;
            background: var(--bg-glass);
            backdrop-filter: blur(40px);
            /* Deep premium blur */
            -webkit-backdrop-filter: blur(40px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            animation: fadeIn 0.6s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header {
            padding: 40px 40px 10px 40px;
            /* More padding top */
            text-align: center;
            background: transparent;
            /* Clean header */
        }

        .header h1 {
            font-size: 36px;
            font-weight: 800;
            margin-bottom: 8px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -1px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .header-mascot {
            height: 120px;
            /* Large premium size */
            width: auto;
            -webkit-text-fill-color: initial;
            filter: drop-shadow(0 8px 16px rgba(0, 0, 0, 0.1));
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            margin-bottom: 10px;
            /* No blend mode needed as the PNG is truly transparent */
        }

        .title-icon {
            height: 120px;
            /* Match main mascot height */
            width: auto;
            vertical-align: middle;
            margin-right: 15px;
            margin-top: -10px;
            -webkit-text-fill-color: initial;
            filter: drop-shadow(0 8px 16px rgba(0, 0, 0, 0.1));
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .header h1:hover .title-icon {
            transform: scale(1.1) rotate(-5deg);
            /* Rotates opposite to the mascot for a "blooming" effect */
        }

        .header h1:hover .header-mascot {
            transform: scale(1.1) rotate(5deg);
        }

        .bg-toggle-container {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 100;
        }

        .bg-toggle-btn {
            background: var(--surface-glass);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--border-light);
            padding: 8px 14px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-sm);
        }

        .bg-toggle-btn:hover {
            background: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .bg-toggle-btn:active {
            transform: translateY(1px) scale(0.96);
            box-shadow: var(--shadow-sm);
            background: rgba(255, 255, 255, 0.8);
        }

        .bg-toggle-btn .icon {
            width: 24px;
            height: 24px;
            object-fit: contain;
            transition: transform 0.3s ease;
        }

        /* Compensate for the extra padding in the prohibition sign image */
        .bg-toggle-btn .icon.large-scale {
            transform: scale(1.3);
        }

        .header p {
            color: var(--text-secondary);
            font-size: 16px;
            font-weight: 500;
        }

        /* iOS Style Segmented Control - REFINED & SCALED UP */
        .tabs {
            display: inline-flex;
            justify-content: center;
            background: rgba(118, 118, 128, 0.12);
            /* Standard Apple Track */
            padding: 5px;
            /* Increased padding */
            border-radius: 14px;
            /* Larger radius */
            margin: 0 auto 35px auto;
            position: relative;
            border-bottom: none;
            width: fit-content;
            /* Allow to grow */
            min-width: 60%;
            /* Ensure it takes up space like a main nav */
            left: 50%;
            transform: translateX(-50%);
            box-shadow: inset 0 0 2px rgba(0, 0, 0, 0.05);
        }

        .tab {
            padding: 12px 24px;
            /* Substantial padding */
            cursor: pointer;
            font-weight: 500;
            color: var(--text-main);
            border-radius: 11px;
            /* Matches track radius minus padding */
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 16px;
            /* Larger text for "Application Section" feel */
            border: none;
            background: transparent;
            margin: 0;
            text-align: center;
            min-width: unset;
            flex: 1;
            /* Distribute space */
            white-space: nowrap;
            display: flex;
            /* Centering */
            align-items: center;
            justify-content: center;
            gap: 8px;
            /* Gap for icon if present (it is in HTML text) */
        }

        .tab:hover {
            opacity: 1;
            /* Reset opacity */
            color: var(--primary);
            background: rgba(255, 255, 255, 0.5);
            /* Subtle hover bg */
            transform: none;
            box-shadow: none;
        }

        .tab.active {
            background: white;
            color: black;
            font-weight: 700;
            /* Bold active */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12), 0 2px 4px rgba(0, 0, 0, 0.05);
            /* Stronger shadow */
            transform: scale(1.02);
            /* Slight pop */
        }

        .content {
            padding: 40px;
            background: white;
            /* Inner content solid or very opaque */
        }

        .tab-content {
            display: none;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .tab-content.active {
            display: block;
        }

        /* Upload Area */
        .upload-area {
            border: 2px dashed #cbd5e1;
            border-radius: var(--radius-md);
            padding: 40px 50px 30px 50px;
            /* FIX: Reduced bottom padding to balance */
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s ease;
            cursor: pointer;
            background: #f8fafc;
        }

        .upload-area:hover {
            border-color: var(--primary);
            background: #eef2ff;
            transform: scale(1.01);
        }

        .upload-area.dragover {
            border-color: var(--primary);
            background: #e0e7ff;
        }

        .upload-icon {
            font-size: 42px;
            /* Slightly smaller, more elegant */
            margin-bottom: 15px;
            display: block;
            filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.1));
        }

        input[type="file"] {
            display: none;
        }

        /* Modern Inputs */
        label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-main);
            font-weight: 600;
            font-size: 14px;
            letter-spacing: -0.3px;
        }

        select,
        input[type="text"],
        input[type="email"],
        textarea {
            width: 100%;
            padding: 16px;
            border: 1px solid transparent;
            /* No border initially, handled by bg */
            background: rgba(118, 118, 128, 0.08);
            /* Apple-like filled input */
            border-radius: var(--radius-sm);
            font-size: 16px;
            /* Prevents zoom on iOS, good read on desktop */
            margin-bottom: 20px;
            font-family: inherit;
            transition: all 0.2s;
            color: var(--text-main);
            outline: none;
        }

        select:focus,
        input[type="text"]:focus,
        input[type="email"]:focus,
        textarea:focus {
            background: white;
            /* White on focus */
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.2);
            /* Soft blue glow */
            border-color: var(--primary);
        }

        textarea {
            min-height: 120px;
            resize: vertical;
        }

        .checkbox-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 6px 0 20px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .checkbox-row input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        /* Buttons */
        /* Buttons - Premium Apple Style */
        .btn {
            background: var(--primary);
            /* Flat Apple Blue */
            color: white;
            border: none;
            padding: 16px 30px;
            /* Larger touch target */
            border-radius: 14px;
            /* Slightly softer than standard, "Continuous Curve" feel */
            font-size: 17px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 600;
            width: 100%;
            margin-bottom: 12px;
            letter-spacing: -0.4px;
            /* Tighter letter spacing like OS */
            box-shadow: 0 4px 6px rgba(0, 122, 255, 0.2);
        }

        .btn:hover:not(:disabled) {
            transform: scale(1.02);
            /* Subtle scale for "airy" feel, stable */
            background: var(--primary-dark);
            box-shadow: 0 10px 20px rgba(0, 122, 255, 0.2);
            /* Deeper, softer shadow */
        }

        .btn:active:not(:disabled) {
            transform: scale(0.98);
            /* Satisfying click press */
            box-shadow: 0 2px 4px rgba(0, 122, 255, 0.2);
        }

        .btn:disabled {
            background: #94a3b8;
            cursor: not-allowed;
            opacity: 0.7;
            transform: none !important;
            box-shadow: none !important;
        }

        .btn.secondary {
            background: #64748b;
        }

        .btn.secondary:hover:not(:disabled) {
            background: #475569;
            box-shadow: 0 10px 20px rgba(100, 116, 139, 0.25);
        }

        .btn.success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .btn.success:hover:not(:disabled) {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            /* Consistent gradient shift */
            box-shadow: 0 10px 20px rgba(16, 185, 129, 0.3);
        }

        /* Sections & Status */
        .section {
            background: #f8fafc;
            padding: 25px;
            border-radius: var(--radius-md);
            margin-bottom: 25px;
            border: 1px solid #f1f5f9;
        }

        .section-title {
            font-weight: 700;
            color: var(--text-main);
            margin-bottom: 20px;
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status {
            padding: 16px;
            border-radius: var(--radius-sm);
            margin-top: 25px;
            display: none;
            font-size: 14px;
            line-height: 1.5;
            animation: fadeIn 0.3s;
        }

        .status.show {
            display: block;
        }

        .status.success {
            background: #ecfdf5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .status.error {
            background: #fef2f2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .status.info {
            background: #eff6ff;
            color: #1e40af;
            border: 1px solid #bfdbfe;
        }
        .status.warning {
            background: #fffbeb;
            color: #92400e;
            border: 1px solid #fde68a;
        }

        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 10px;
            background: #e2e8f0;
            border-radius: 20px;
            overflow: hidden;
            margin-top: 20px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            width: 0%;
            transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 20px;
        }

        .progress-text {
            text-align: right;
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        /* File Info Cards */
        .file-info {
            background: white;
            padding: 20px;
            border-radius: var(--radius-md);
            margin-bottom: 25px;
            display: none;
            box-shadow: var(--shadow-sm);
            border: 1px solid #e2e8f0;
        }

        .file-info.show {
            display: block;
        }

        .file-list {
            max-height: 200px;
            overflow-y: auto;
            background: #f8fafc;
            padding: 10px;
            border-radius: var(--radius-sm);
            margin-top: 15px;
            border: 1px solid #e2e8f0;
        }

        .file-item {
            padding: 8px 12px;
            font-size: 13px;
            color: var(--text-main);
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .file-item:last-child {
            border-bottom: none;
        }

        /* Knowledge Base */
        /* Knowledge Base - IOS List Style */
        .kb-topic {
            background: rgba(255, 255, 255, 0.7);
            /* Translucent */
            border: none;
            /* Remove border for cleaner look */
            border-bottom: 1px solid var(--border-light);
            /* Separator line */
            border-radius: 0;
            /* List style */
            margin-bottom: 0;
            overflow: hidden;
            transition: background 0.2s;
        }

        .kb-topic:first-child {
            border-top-left-radius: var(--radius-md);
            border-top-right-radius: var(--radius-md);
        }

        .kb-topic:last-child {
            border-bottom-left-radius: var(--radius-md);
            border-bottom-right-radius: var(--radius-md);
            border-bottom: none;
        }

        .kb-topic:hover {
            background: rgba(255, 255, 255, 0.9);
            border-color: transparent;
            /* No border change */
            box-shadow: none;
            cursor: pointer;
            /* FIX: Visual feedback */
        }

        .kb-topic-header {
            padding: 18px 25px;
        }

        .kb-topic-title {
            color: var(--text-main);
            font-weight: 500;
            font-size: 16px;
        }

        /* FIX: Modern Chevron Integration */
        .kb-topic-header {
            position: relative;
        }

        .kb-topic-header::after {
            content: '';
            position: absolute;
            right: 25px;
            top: 50%;
            width: 8px;
            height: 8px;
            border-right: 2px solid #cbd5e1;
            /* border-light */
            border-bottom: 2px solid #cbd5e1;
            transform: translateY(-50%) rotate(-45deg);
            /* Point left/neutral initially? or Down? Let's say closed = right? */
            /* Current arrow was right arrow ‚ñ∂. Let's make it a chevron pointing right. */
            /* Rotate -45deg makes it point Right if borders are right/bottom */
            transition: transform 0.3s ease;
        }

        .kb-topic.open .kb-topic-header::after {
            transform: translateY(-50%) rotate(45deg);
            /* Point Down */
            border-color: var(--primary);
        }

        /* FIX: Restore KB Content Animation */
        .kb-topic-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out;
            background: white;
        }

        .kb-topic.open .kb-topic-content {
            max-height: 5000px;
            /* arbitrary large value to allow full expansion */
            transition: max-height 0.5s ease-in;
        }

        /* --- MISSING STYLES RESTORED & FIXED --- */

        /* 1. Add Mapping Button */
        .add-mapping-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-weight: 600;
            margin-top: 10px;
            transition: all 0.3s;
            font-size: 14px;
            display: inline-block;
            box-shadow: 0 4px 6px rgba(16, 185, 129, 0.2);
        }

        .add-mapping-btn:hover {
            box-shadow: 0 8px 12px rgba(16, 185, 129, 0.3);
            transform: translateY(-2px);
        }

        /* 2. Fix Progress Bar Text Visibility */
        .progress-bar {
            height: 24px;
            /* Increased height to fit text */
            background: #e2e8f0;
            border-radius: 12px;
            overflow: hidden;
            margin-top: 20px;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            width: 0%;
            transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            color: white;
            font-size: 13px;
            display: flex;
            /* Restored flex to center text */
            align-items: center;
            justify-content: center;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        /* 3. Knowledge Base Content Styles */
        .kb-topic-body {
            padding: 20px;
            color: var(--text-secondary);
            line-height: 1.6;
            border-top: 1px solid #f1f5f9;
            background: #fafbfc;
        }

        .kb-topic-body h3 {
            color: var(--primary);
            margin-top: 10px;
            margin-bottom: 12px;
            font-size: 16px;
            font-weight: 700;
        }

        .kb-topic-body ul,
        .kb-topic-body ol {
            margin-left: 20px;
            margin-bottom: 15px;
        }

        .kb-topic-body li {
            margin-bottom: 6px;
        }

        .kb-topic-body code {
            background: rgba(99, 102, 241, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            color: var(--primary-dark);
            font-family: 'Consolas', monospace;
            font-size: 13px;
            border: 1px solid rgba(99, 102, 241, 0.1);
        }

        .kb-topic-arrow {
            transition: transform 0.3s;
            font-size: 14px;
            opacity: 0.5;
            margin-right: 10px;
        }

        .kb-topic.open .kb-topic-arrow {
            transform: rotate(90deg);
        }

        /* 4. Column Mapping & General Layout Fixes */
        .column-mapping-container {
            background: rgba(255, 255, 255, 0.5);
            /* translucent */
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            padding: 20px;
            margin-top: 15px;
        }

        /* GRID LAYOUT FOR MAPPING */
        .mapping-header,
        .mapping-row {
            display: grid;
            grid-template-columns: 3fr 30px 100px 40px;
            /* Excel | Arrow | Sheet Col | Trash */
            gap: 12px;
            align-items: center;
        }

        .mapping-header {
            margin-bottom: 15px;
            padding: 0 10px;
            /* Align with row padding */
        }

        .mapping-header span {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            font-weight: 700;
        }

        .mapping-row {
            padding: 10px;
            background: white;
            border-radius: var(--radius-sm);
            margin-bottom: 10px;
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow-sm);
            transition: all 0.2s ease;
        }

        .mapping-row:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        /* Inputs in Row */
        .mapping-row .excel-col {
            /* Now handled by grid */
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--text-main);
        }

        /* Arrow */
        .mapping-row .arrow {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.04);
            color: var(--text-secondary);
            font-size: 14px;
            margin: 0 auto;
            /* Center in grid cell */
            font-family: system-ui, -apple-system, sans-serif;
            /* Ensure clean arrow rendering */
            line-height: 1;
            padding-bottom: 2px;
            /* Visual Optical adjustment for arrow text */
        }

        /* Excel Dropdown - Match Sheets Input */
        .mapping-row select.excel-select {
            width: 100%;
            padding: 8px;
            margin-bottom: 0;
            font-size: 14px;
            border: 1px solid var(--border-light);
            border-radius: 6px;
            /* Match standard inputs or smaller radius */
            background-color: #fff;
            color: var(--text-main);
        }

        .mapping-row select.excel-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.15);
            outline: none;
        }

        /* Sheets Input */
        .mapping-row .sheets-input {
            width: 100%;
            /* Fill grid cell */
            text-align: center;
            padding: 8px;
            font-weight: 600;
            color: var(--primary);
            background: rgba(0, 122, 255, 0.05);
            border: 1px solid rgba(0, 122, 255, 0.1);
            margin-bottom: 0;
            /* Override generic input margin */
            text-transform: uppercase;
        }

        .mapping-row .sheets-input:focus {
            background: white;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.15);
        }


        /* Remove Button refined */
        .mapping-row .remove-mapping {
            background: rgba(239, 68, 68, 0.1);
            /* Soft red bg */
            color: #ef4444;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            /* Circle */
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: auto;
            /* Push to end if in flex, but in grid it's fixed col */
        }

        .mapping-row .remove-mapping:hover {
            background: #ef4444;
            color: white;
            transform: scale(1.1);
        }

        .mapping-row .remove-mapping:active {
            transform: scale(0.9);
        }

        /* 5. Help/Instructions Styling */
        .info-box ul {
            margin-left: 20px;
            margin-top: 10px;
        }

        .info-box li {
            margin-bottom: 5px;
        }

        /* Import Mode Card Styles */
        /* Import Mode Card Styles - Overhaul */
        .mode-selection-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            /* Tighter gap */
            margin-bottom: 15px;
        }

        .mode-card {
            background: rgba(255, 255, 255, 0.6);
            /* Translucent base */
            border: 2px solid transparent;
            /* Hidden border by default */
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            /* Vertically center icon and text block */
            gap: 12px;
            position: relative;
        }

        .mode-card:hover {
            background: rgba(255, 255, 255, 0.9);
            transform: scale(1.02);
        }

        .mode-card.selected {
            border-color: var(--primary);
            /* Focused border */
            background: white;
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.15);
            /* Soft blue shadow */
        }

        .mode-card input[type="radio"] {
            display: none;
        }

        .mode-icon {
            font-size: 22px;
            background: var(--primary);
            /* Primary bg for icon area? Or keep gray? Apple uses color icons often. */
            color: white;
            /* Let's try white on blue for pop */
            width: 40px;
            height: 40px;
            border-radius: 10px;
            /* Squircle */
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            /* Don't shrink icon */
        }

        /* Alternate icon color for overwrite? */
        .mode-card:nth-child(2) .mode-icon {
            background: var(--secondary);
            /* Differentiate overwrite */
        }

        .mode-details {
            display: flex;
            flex-direction: column;
            justify-content: center;
            /* Center text vertically */
            text-align: left;
            /* Ensure left align */
            flex: 1;
            /* Fill available space */
            height: 100%;
            /* Force height */
        }

        .mode-title {
            font-weight: 600;
            color: var(--text-main);
            font-size: 15px;
            line-height: 1.2;
            margin-bottom: 2px;
        }

        .mode-desc {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 400;
            line-height: 1.3;
        }

        /* Compact Upload Area for Tab 4 */
        /* We can target by ID or new class. Let's add a class in HTML below */
        .upload-area.compact {
            padding: 15px 20px;
            min-height: auto;
            display: flex;
            /* Horizontal Layout */
            flex-direction: row;
            align-items: center;
            justify-content: flex-start;
            gap: 15px;
            text-align: left;
        }

        .upload-area.compact .upload-icon {
            font-size: 24px;
            margin-bottom: 0;
        }

        .upload-area.compact p {
            margin: 0 !important;
        }

        /* Specific Sync Tab Spacing Tweak */
        #gsync .section {
            padding: 20px;
            margin-bottom: 15px;
            /* Tighter vertical spacing */
        }

        /* Integrated Start Row Input */
        .integrated-input-wrapper {
            margin-top: 10px;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
            padding-top: 10px;
            width: 100%;
        }

        .integrated-input-wrapper label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .integrated-input-wrapper input {
            padding: 8px 12px;
            font-size: 13px;
            margin-bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid #e2e8f0;
        }

        .mode-card.selected .mode-icon {
            background: white;
            color: var(--primary);
        }

        .mode-details {
            display: flex;
            flex-direction: column;
        }

        .mode-title {
            font-weight: 700;
            color: var(--text-main);
            font-size: 16px;
        }

        .mode-desc {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        /* Removed legacy flex rules */

        button,
        input,
        select,
        textarea {
            font-family: inherit;
        }
    </style>
</head>

<body>
    <div class="container" style="position: relative;">
        <div class="bg-toggle-container">
            <button class="bg-toggle-btn" id="bgToggle" title="Toggle Background">
                <img src="images/no_monkey_icon.png" alt="Toggle" class="icon large-scale">
                <span class="text">Hide monkeys!</span>
            </button>
        </div>
        <div class="header">
            <h1>
                <span><img src="images/leftie_removed_bg.png" alt="Icon" class="title-icon">Evelinos Suite v4</span>
                <img src="images/clean_monkey-removebg-preview.png" alt="Mascot" class="header-mascot">
            </h1>
            <p>Split Excel files by criteria and generate email drafts</p>
        </div>

        <div class="tabs">
            <div class="tab active" data-tab="splitter">
                üîÄ Split by Criteria
            </div>
            <div class="tab" data-tab="emailer">
                üìß Generate Emails
            </div>
            <div class="tab" data-tab="gsync">
                üîÑ Sheets Sync
            </div>
            <div class="tab" data-tab="knowledge">
                üìö Knowledge Base
            </div>
        </div>

        <div class="content">
            <!-- Tab 1: Excel Splitter -->
            <div class="tab-content active" id="splitter">
                <div class="info-box">
                    <strong>Step 1:</strong> Upload your Excel file and split it based on unique values in any column
                </div>

                <div class="upload-area" id="uploadArea1">
                    <div class="upload-icon">üìÇ</div>
                    <p style="margin-bottom: 10px; color: #666;"><strong>Click to upload</strong> or drag and drop</p>
                    <p style="font-size: 14px; color: #999;">Excel files (.xlsx) or CSV in CSV mode</p>
                    <input type="file" id="fileInput1" accept=".xlsx,.XLSX">
                </div>
                <div class="checkbox-row">
                    <input type="checkbox" id="csvMode1">
                    <label for="csvMode1">Use CSV mode for very large files (single sheet only)</label>
                </div>
                <div class="checkbox-row">
                    <label for="csvDelimiter1">CSV delimiter:</label>
                    <select id="csvDelimiter1" style="max-width: 220px;">
                        <option value=",">Comma (,)</option>
                        <option value=";">Semicolon (;)</option>
                        <option value="\t">Tab</option>
                    </select>
                </div>

                <div class="file-info" id="fileInfo1">
                    <div class="file-name" id="fileName1"></div>
                    <div class="file-details" id="fileDetails1"></div>
                </div>

                <div class="section hidden" id="sheetSelector1Container">
                    <div class="section-title">üìë Select Excel Sheet</div>
                    <label for="excelSheetSelect1">Choose the worksheet to split:</label>
                    <select id="excelSheetSelect1">
                        <!-- Options populated by JS -->
                    </select>
                </div>

                <div class="section hidden" id="columnSection1">
                    <label for="splitColumn1">Select the column to split by (each unique value will create a separate
                        file):</label>
                    <select id="splitColumn1">
                        <option value="">-- Select a column --</option>
                    </select>
                </div>

                <div class="section hidden" id="outputSection1">
                    <label>üìÇ Output Location:</label>
                    <p style="font-size: 14px; color: #666; margin-bottom: 10px;">Choose where to save the split files
                    </p>
                    <button class="btn secondary" id="selectFolder1">Select Output Folder</button>
                    <div class="folder-info" id="folderName1"></div>
                    <div class="checkbox-row">
                        <input type="checkbox" id="csvOutput1">
                        <label for="csvOutput1">Output as CSV instead of XLSX</label>
                    </div>
                </div>

                <div class="hidden" id="buttonGroup1">
                    <button class="btn" id="processFolder1" style="display:none;">Save to Selected Folder</button>
                    <button class="btn secondary" id="processZip1" style="display:none;">Download as ZIP File</button>
                </div>

                <div class="progress" id="progress1">
                    <p style="margin-bottom: 10px; color: #666;">Processing files...</p>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill1">0%</div>
                    </div>
                </div>

                <div class="status" id="status1"></div>

                <div class="note">
                    <strong>üí° Next Step:</strong> After splitting, switch to the "Generate Emails" tab to create drafts for each file.
                </div>
            </div>

            <!-- Tab 2: Email Generator -->
            <div class="tab-content" id="emailer">
                <div class="info-box">
                    <strong>Step 2:</strong> Generate email draft files directly from your split Excel files
                </div>

                <div class="section">
                    <div class="section-title">üìÅ Select Excel Files Folder</div>
                    <button class="btn" id="selectInput2">Select Folder with Excel Files</button>
                    <button class="btn secondary" id="fallbackBtn2">Choose Files (Fallback)</button>
                    <!-- Fallback file input -->
                    <input type="file" id="fallbackInput2" multiple accept=".xlsx,.XLSX" style="display: none;">
                    <div class="folder-info" id="inputFolder2"></div>
                    <div class="file-list" id="fileList2"></div>
                </div>

                <div class="section hidden" id="emailConfig2">
                    <div class="section-title">‚úâÔ∏è Configure Email Template</div>

                    <label for="emailSubject2">Subject Line:</label>
                    <input type="text" id="emailSubject2" placeholder="e.g., Company Report - {{filename}}"
                        value="Company Report - {{filename}}">

                    <label for="emailBody2">Email Body:</label>
                    <textarea id="emailBody2" placeholder="Enter your email message here...">Dear Team,

Please find the attached report.

Best regards</textarea>
                    <label for="ccEmail2">CC (optional):</label>
                    <input type="email" id="ccEmail2" placeholder="cc@example.com">

                    <div class="hidden" id="columnSection2">
                        <label for="emailColumn2">Select Column with Email Addresses:</label>
                        <select id="emailColumn2">
                            <option value="">-- Select a column --</option>
                        </select>
                    </div>
                </div>

                <div class="section hidden" id="outputSection2">
                    <div class="section-title">üíæ Select Output Folder</div>
                    <button class="btn secondary" id="selectOutput2">Select Output Folder for Drafts</button>
                    <div class="folder-info" id="outputFolder2"></div>
                </div>

                <button class="btn success hidden" id="generate2">Generate Email Drafts</button>

                <div class="progress" id="progress2">
                    <p style="margin-bottom: 10px; color: #666;">Creating draft files...</p>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill2">0%</div>
                    </div>
                </div>

                <div class="status" id="status2"></div>

                <div class="note">
                    <strong>üí° Tips:</strong><br>
                    ‚Ä¢ Use {{filename}} in subject to include the Excel filename<br>
                    ‚Ä¢ Each source file produces one draft (.eml) with attachment<br>
                    ‚Ä¢ You will confirm the full batch once before generation starts
                </div>
            </div>

            <!-- Tab 4: Google Sheets Sync -->
            <div class="tab-content" id="gsync">
                <div class="info-box">
                    <strong>üîÑ Excel to Google Sheets Sync:</strong> Import specific columns from Excel to your Google
                    Sheet with custom column mapping
                </div>

                <!-- Web App URL Section -->
                <div class="section"
                    style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 20px; border-radius: 8px;">
                    <div class="section-title" style="color: white;">‚öôÔ∏è Google Apps Script Web App URL</div>
                    <p style="margin-bottom: 15px; opacity: 0.95; font-size: 14px; line-height: 1.5;">
                        This app uses a simple Google Apps Script to write to your sheets.
                        <strong style="color: white;">Need Setup Help?</strong>
                        <span style="text-decoration: underline; cursor: pointer; font-weight: 600;"
                            onclick="document.querySelector('.tab[data-tab=\'knowledge\']').click()">Check the Knowledge
                            Base</span>
                        for the "Google Sheets Sync ‚Äî Complete Setup Guide".
                    </p>
                    <input type="text" id="webAppUrl4" placeholder="Paste your Google Apps Script Web App URL here"
                        style="width: 100%; padding: 12px; border-radius: 6px; border: none; font-size: 14px;">
                    <p style="font-size: 12px; margin-top: 8px; opacity: 0.9;">
                        The URL looks like: <code
                            style="background: rgba(255,255,255,0.25); padding: 4px 8px; border-radius: 4px; font-family: 'Consolas', monospace; user-select: all;">https://script.google.com/macros/s/AKfycbwLdXzVaj.../exec</code>
                    </p>
                </div>

                <!-- Google Sheets Configuration -->
                <div class="section">
                    <div class="section-title">üìä Google Sheets Configuration</div>

                    <label for="sheetsUrl4">Google Sheets URL or ID:</label>
                    <input type="text" id="sheetsUrl4"
                        placeholder="Paste the full Google Sheets URL or just the spreadsheet ID">

                    <label for="sheetName4">Sheet Name (tab name within the spreadsheet):</label>
                    <input type="text" id="sheetName4" placeholder="e.g., My Data, Sheet1, Import Data" value="Sheet1">
                </div>

                <!-- Excel File Upload (Compact) -->
                <div class="section">
                    <div class="upload-area compact" id="uploadArea4">
                        <div class="upload-icon">üìÇ</div>
                        <div style="flex-grow: 1;">
                            <p style="color: #334155; font-weight: 500;"><strong>Click to upload Excel file</strong></p>
                            <p style="font-size: 13px; color: #64748b;">.xlsx files or CSV in CSV mode</p>
                        </div>
                        <input type="file" id="fileInput4" accept=".xlsx,.XLSX">
                    </div>
                    <div class="checkbox-row">
                        <input type="checkbox" id="csvMode4">
                        <label for="csvMode4">Use CSV mode for very large files (single sheet only)</label>
                    </div>
                    <div class="checkbox-row">
                        <label for="csvDelimiter4">CSV delimiter:</label>
                        <select id="csvDelimiter4" style="max-width: 220px;">
                            <option value=",">Comma (,)</option>
                            <option value=";">Semicolon (;)</option>
                            <option value="\t">Tab</option>
                        </select>
                    </div>

                    <div class="file-info" id="fileInfo4" style="margin-top: 10px; margin-bottom: 0;">
                        <div class="file-name" id="fileName4"></div>
                        <div class="file-details" id="fileDetails4"></div>
                    </div>

                    <div id="sheetSelector4Container" class="hidden"
                        style="margin-top: 15px; border-top: 1px dashed var(--border-light); padding-top: 15px;">
                        <label for="excelSheetSelect4"
                            style="font-weight: 600; font-size: 14px; margin-bottom: 8px; display: block;">üìë Select
                            Excel Sheet</label>
                        <select id="excelSheetSelect4"
                            style="width: 100%; padding: 10px; font-size: 14px; margin-bottom: 0;">
                            <!-- Options populated by JS -->
                        </select>
                        <p style="font-size: 11px; color: var(--text-secondary); margin-top: 5px;">Choose the sheet from
                            your workbook that contains the data you wish to sync.</p>
                    </div>
                </div>

                <!-- Sync Mode & Options -->
                <div class="section hidden" id="modeSection4">
                    <div class="section-title">‚úèÔ∏è Import Configuration</div>

                    <div class="mode-selection-grid" style="margin-bottom: 20px;">
                        <label class="mode-card selected">
                            <input type="radio" name="importMode4" id="modeAppend4" value="append" checked>
                            <div class="mode-icon">‚ûï</div>
                            <div class="mode-details">
                                <span class="mode-title">Append</span>
                                <span class="mode-desc">Add after existing data</span>
                            </div>
                        </label>

                        <label class="mode-card">
                            <input type="radio" name="importMode4" id="modeOverwrite4" value="overwrite">
                            <div class="mode-icon">üîÑ</div>
                            <div class="mode-details">
                                <span class="mode-title">Overwrite</span>
                                <span class="mode-desc">Replace existing data</span>
                            </div>
                        </label>
                    </div>

                    <div
                        style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; background: rgba(0,0,0,0.02); padding: 15px; border-radius: 12px; border: 1px solid var(--border-light);">
                        <div>
                            <label for="startRow4"
                                style="font-weight: 600; font-size: 14px; margin-bottom: 8px; display: block;">üìç Start
                                Row (Optional)</label>
                            <input type="number" id="startRow4" placeholder="Auto-detect" min="1"
                                style="margin-bottom: 0; padding: 10px;">
                            <p style="font-size: 11px; color: var(--text-secondary); margin-top: 5px;">Leave empty to
                                append at bottom or overwrite from top.</p>
                        </div>
                        <div style="display: flex; flex-direction: column; justify-content: flex-start;">
                            <label style="font-weight: 600; font-size: 14px; margin-bottom: 12px; display: block;">üìÑ
                                Data Handling</label>
                            <label
                                style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 14px;">
                                <input type="checkbox" id="includeHeaders4" checked
                                    style="width: 18px; height: 18px; margin: 0;">
                                Include Excel Headers?
                            </label>
                            <p style="font-size: 11px; color: var(--text-secondary); margin-top: 5px;">Uncheck to sync
                                data only (skips row 1 of Excel).</p>
                        </div>
                    </div>
                </div>

                <!-- Column Mapping -->
                <div class="section hidden" id="mappingSection4">
                    <div class="section-title">üîó Column Mapping</div>
                    <p style="color: #666; margin-bottom: 15px;">Map Excel columns to Google Sheets columns. Use column
                        letters (A, B, C...) for Google Sheets destination.</p>

                    <div class="column-mapping-container">
                        <div class="mapping-header">
                            <span>üìó Excel Column</span>
                            <span></span>
                            <span>üìä Google Sheets Column</span>
                            <span></span>
                        </div>
                        <div id="mappingRows4">
                            <!-- Mapping rows will be added here -->
                        </div>
                        <button class="add-mapping-btn" id="addMapping4">+ Add Column Mapping</button>
                    </div>
                </div>

                <!-- Sync Button -->
                <button class="btn success hidden" id="syncBtn4">üöÄ Sync to Google Sheets</button>

                <div class="progress" id="progress4">
                    <p style="margin-bottom: 10px; color: #666;">Syncing data...</p>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill4">0%</div>
                    </div>
                </div>

                <div class="status" id="status4"></div>

                <div class="note">
                    <strong>üí° Need Setup Help?</strong> check the <strong>Knowledge Base</strong> (Tab 4) for the
                    "Google Sheets Sync ‚Äî Complete Setup Guide".
                </div>
            </div>

            <!-- Tab 4: Knowledge Base -->
            <div class="tab-content" id="knowledge">
                <div class="info-box">
                    <strong>üìö Knowledge Base:</strong> Browse guides and documentation for using this app
                </div>

                <div class="kb-search">
                    <input type="text" id="kbSearch" placeholder="üîç Search topics...">
                </div>

                <div id="kbTopics">
                    <!-- Topics will be generated here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============= KNOWLEDGE BASE DATA =============
        // To add a new topic, simply copy one of the objects below and modify it
        const knowledgeBaseTopics = [
            {
                icon: "‚úÇÔ∏è",
                title: "Excel Splitter ‚Äî User Guide",
                content: `
                    <h3>üìã Overview</h3>
                    <p>The <strong>Excel Splitter</strong> (Tab 1) takes a large "Master File" and breaks it into smaller, separate Excel files based on a column you choose (e.g., splitting a Sales Report by "Manager" or "Region").</p>

                    <h3>üìù Step-by-Step Instructions</h3>
                    <ol>
                        <li><strong>Select Master File:</strong> Click the folder icon to choose your main Excel file.</li>
                        <li><strong>Choose Split Column:</strong> The app will read your headers. Select the specific column you want to group by (e.g., "Department").
                            <ul>
                                <li><em>Example:</em> If you choose "Department", you will get files like <code>Department_HR.xlsx</code>, <code>Department_IT.xlsx</code>.</li>
                            </ul>
                        </li>
                        <li><strong>Select Output Folder:</strong> Click to choose where to save the new files.
                            <ul>
                                <li><em>Note:</em> Using the Folder Picker requires permission. If your computer blocks it, the app may default to a generic download or ZIP mode.</li>
                            </ul>
                        </li>
                        <li><strong>Generate:</strong> Click <strong>Split Files</strong>. The progress bar will show the status.</li>
                    </ol>

                    <h3>üí° Pro Tips</h3>
                    <ul>
                        <li><strong>Formatted Tables:</strong> The app tries to preserve your original table styles and headers.</li>
                        <li><strong>Large Files:</strong> For very large files, give the app a moment to process. It handles thousands of rows in seconds.</li>
                    </ul>
                `
            },
            {
                icon: "üìß",
                title: "Excel Emailer ‚Äî User Guide",
                content: `
                    <h3>üìã Overview</h3>
                    <p>The <strong>Excel Emailer</strong> (Tab 2) now generates ready-to-open <code>.eml</code> draft files directly from each Excel file, with the original workbook attached.</p>

                    <h3>üìù Step-by-Step Instructions</h3>
                    <ol>
                        <li><strong>Select Input Files:</strong>
                            <ul>
                                <li><strong>Option A (Folder):</strong> Click "Select Input Folder" to load all Excel files from a directory.</li>
                                <li><strong>Option B (Legacy/Files):</strong> Use the "Or select individual files" option if you can't select a folder (common on work PCs).</li>
                            </ul>
                        </li>
                        <li><strong>Choose Email Column:</strong> Select the column inside your Excel files that contains the recipient's email address.
                            <ul>
                                <li>The app looks inside <em>each file</em> to find who to send it to.</li>
                            </ul>
                        </li>
                        <li><strong>Configure Template:</b>
                            <ul>
                                <li><strong>Subject:</strong> Enter your email subject line. Use <code>{{filename}}</code> to automatically insert the file's name.</li>
                                <li><strong>Body:</strong> Type your message.</li>
                                <li><strong>CC:</strong> Optional. Add a CC address for all emails.</li>
                            </ul>
                        </li>
                        <li><strong>Select Output:</strong> Choose a folder to save drafts.
                            <ul>
                                <li><strong>‚ö†Ô∏è Fallback Mode:</strong> If you don't select a folder (or can't), the app will automatically zip all generated drafts into an <code>email_drafts.zip</code> file for you to download.</li>
                            </ul>
                        </li>
                        <li><strong>Generate:</strong> Click <strong>Generate Email Drafts</strong>.</li>
                    </ol>

                    <h3>üí° Key Features</h3>
                    <ul>
                        <li><strong>Attachments:</strong> The Excel file itself is automatically attached to the email.</li>
                        <li><strong>Multiple Recipients:</strong> If a file contains multiple unique email addresses in the column, the email will be sent to all of them.</li>
                    </ul>
                `
            },
            {
                icon: "‚ö°",
                title: "Ultimate Excel Power Query Guide ‚Äî Fully Detailed & Commercial Ready",
                content: `
                    <h3>1Ô∏è‚É£ Open a new workbook</h3>
                    <ol>
                        <li>Open <strong>Excel</strong></li>
                        <li>Click <strong>Blank Workbook</strong></li>
                    </ol>
                    
                    <h3>2Ô∏è‚É£ Load all files from a folder</h3>
                    <ol>
                        <li>Top menu ‚Üí <strong>Data</strong> tab</li>
                        <li>Click <strong>Get Data ‚Üí From File ‚Üí From Folder</strong></li>
                        <li>In the popup ‚Üí <strong>Browse</strong>, select your folder ‚Üí <strong>OK</strong></li>
                        <li>Folder dialog shows all files ‚Üí click <strong>Combine ‚Üí Combine & Transform Data</strong></li>
                        <li>Power Query Editor opens automatically</li>
                    </ol>
                    <p><em>You now have your "sample file" and the "combined query" (<code>Export</code>) in the left panel.</em></p>
                    
                    <h3>3Ô∏è‚É£ Stop automatic type guessing</h3>
                    <ol>
                        <li>Left panel ‚Üí click <strong>Export</strong> (final combined query)</li>
                        <li>Right panel ‚Üí <strong>Applied Steps ‚Üí find "Changed Type" ‚Üí click ‚ùå</strong></li>
                    </ol>
                    <p><em>This prevents decimals from being corrupted (e.g., <code>0,1</code> ‚Üí <code>1</code>).</em></p>
                    
                    <h3>4Ô∏è‚É£ Fix decimal numbers (optional)</h3>
                    <ol>
                        <li>Click the header of columns you want to fix (e.g., <code>m</code> and <code>n</code>)</li>
                        <li>Top menu ‚Üí <strong>Transform tab ‚Üí Replace Values</strong>
                            <ul>
                                <li>Value to Find: <code>,</code></li>
                                <li>Replace With: <code>.</code></li>
                                <li>Click <strong>OK</strong></li>
                            </ul>
                        </li>
                        <li>With the same columns selected ‚Üí <strong>Transform tab ‚Üí Data Type ‚Üí Decimal Number</strong></li>
                    </ol>
                    <p><em>Numbers like <code>0,1</code> ‚Üí <code>0.1</code> and <code>0,13</code> ‚Üí <code>0.13</code>.</em></p>
                    
                    <h3>5Ô∏è‚É£ Add calculated/validation columns</h3>
                    <p><strong>A) Check if N &lt; M</strong></p>
                    <ol>
                        <li>Top menu ‚Üí <strong>Add Column tab ‚Üí Custom Column</strong></li>
                        <li>Popup opens:
                            <ul>
                                <li><strong>New column name:</strong> <code>Check_N_lt_M</code></li>
                                <li><strong>Custom column formula:</strong><br>
                                <code>if [N] = null or [M] = null then "Missing" else if [N] &lt; [M] then "Yes" else "No"</code></li>
                            </ul>
                        </li>
                        <li>Click <strong>OK</strong></li>
                        <li>Drag column <strong>after N</strong> (or right-click ‚Üí Move ‚Üí Left/Right)</li>
                    </ol>
                    
                    <p><strong>B) Sum of E + F</strong></p>
                    <ol>
                        <li>Add Column tab ‚Üí <strong>Custom Column</strong></li>
                        <li>Name: <code>Sum_EF</code></li>
                        <li>Formula:<br>
                        <code>(if [E] = null then 0 else [E]) + (if [F] = null then 0 else [F])</code></li>
                        <li>Click <strong>OK</strong></li>
                        <li>Drag the column <strong>after F</strong></li>
                    </ol>
                    <p><em>Formulas now handle blanks safely.</em></p>
                    
                    <h3>6Ô∏è‚É£ Grouping / Aggregation ‚Äî Average Price per Seller</h3>
                    <ol>
                        <li>Ensure your <strong>Price column</strong> is numeric: select ‚Üí <strong>Transform tab ‚Üí Data Type ‚Üí Decimal Number</strong></li>
                        <li>Select the column identifying the seller (e.g., <code>Seller</code>)</li>
                        <li>Top menu ‚Üí <strong>Transform tab ‚Üí Group By</strong></li>
                        <li>In the <strong>Group By</strong> dialog:
                            <ul>
                                <li><strong>Group by:</strong> <code>Seller</code></li>
                                <li><strong>Operation:</strong> <strong>Average</strong></li>
                                <li><strong>Column:</strong> <code>Price</code></li>
                                <li><strong>New column name:</strong> <code>AveragePrice</code></li>
                            </ul>
                        </li>
                        <li>Click <strong>OK</strong></li>
                        <li>Optional: add other aggregates like <strong>Count of Products</strong>, <strong>Max/Min Price</strong></li>
                    </ol>
                    <p><em>PQ creates one row per seller with the average price of all their products.</em></p>
                    
                    <h3>7Ô∏è‚É£ Arrange columns visually</h3>
                    <ul>
                        <li>Drag-and-drop headers in the main table to reorder</li>
                        <li>OR Home tab ‚Üí <strong>Manage Columns ‚Üí Choose Columns</strong> ‚Üí drag to reorder ‚Üí <strong>OK</strong></li>
                        <li>Formulas remain intact because PQ references <strong>column names</strong>, not positions.</li>
                    </ul>
                    
                    <h3>8Ô∏è‚É£ Load final table into Excel</h3>
                    <ol>
                        <li>Top menu ‚Üí <strong>Home tab ‚Üí Close & Load ‚Üí Close & Load To‚Ä¶</strong></li>
                        <li>Choose where to place your table (e.g., existing worksheet or new worksheet) ‚Üí <strong>OK</strong></li>
                        <li>Excel now shows:
                            <ul>
                                <li>Original columns with decimals preserved</li>
                                <li><code>Check_N_lt_M</code> after <code>N</code></li>
                                <li><code>Sum_EF</code> after <code>F</code></li>
                                <li>Optional grouped summary per seller</li>
                            </ul>
                        </li>
                    </ol>
                    
                    <h3>9Ô∏è‚É£ Set up a reusable "template" query</h3>
                    <ol>
                        <li>Keep this workbook saved as a template</li>
                        <li>Optional: rename query ‚Üí <code>Combined_Files_Template</code></li>
                        <li>When adding new files:
                            <ul>
                                <li>Save new Excel files <strong>in the same folder</strong></li>
                                <li>Open template workbook ‚Üí click anywhere in the table ‚Üí <strong>Right-click ‚Üí Refresh</strong></li>
                            </ul>
                        </li>
                        <li>PQ automatically:
                            <ul>
                                <li>Includes new files</li>
                                <li>Applies decimal fixes</li>
                                <li>Adds <code>Check_N_lt_M</code> and <code>Sum_EF</code></li>
                                <li>Maintains column order</li>
                                <li>Recalculates grouped averages</li>
                            </ul>
                        </li>
                    </ol>
                `
            },

            {
                icon: "‚ö°",
                title: "Power Query ‚Äî Automating Combined Reports",
                content: `
                    <h3>üìã Overview</h3>
                    <p>Learn how to combine multiple Excel files (from the Splitter) into one master report using Power Query. This setup updates automatically when you add new files!</p>
                `
            },

            {
                icon: "üîÑ",
                title: "Google Sheets Sync ‚Äî Complete Setup Guide",
                content: `
                    <h3>üìã Overview</h3>
                    <p>The <strong>Sheets Sync</strong> feature allows you to import specific columns from Excel files directly into your Google Sheets. You can map individual columns to different positions, choose to append or overwrite data, and work with shared spreadsheets.</p>
                    
                    <h3>üîß Part 1: Setting Up Google Apps Script (One-Time Setup)</h3>
                    <p>To bypass complex authentication, we'll create a tiny "helper script" attached to your Google Sheet. this takes about 2 minutes.</p>
                    
                    <h3>Step 1: Open Your Google Sheet</h3>
                    <ol>
                        <li>Open the Google Sheet you want to write to.</li>
                        <li>In the top menu, click <strong>Extensions</strong> > <strong>Apps Script</strong>.</li>
                        <li>A new tab will open with a code editor.</li>
                    </ol>
                    
                    <h3>Step 2: Paste the Helper Script</h3>
                    <ol>
                        <li>Delete any code currently in the editor (like <code>function myFunction()...</code>).</li>
                        <li>Copy and paste the following code exactly:</li>
                    </ol>
                    <pre style="background: #f4f4f4; padding: 10px; font-size: 11px; overflow-x: auto; border-radius: 4px;"><code>/**
 * v5.0 - Ultimate Intelligent Sync Script
 * 1. Find last row based only on columns being mapped.
 * 2. Comply with manual Start Row if provided.
 * 3. Preserve existing Sheet headers.
 */
function doPost(e) {
  try {
    const params = JSON.parse(e.postData.contents);
    const ss = SpreadsheetApp.openById(params.spreadsheetId);
    let sheet = ss.getSheetByName(params.sheetName);
    
    if (!sheet) throw new Error("Sheet '" + params.sheetName + "' not found. Check for spaces!");

    const mappings = params.mappings;
    const dataRows = params.data; 
    const mode = params.mode;
    let startRow = params.startRow; 

    // Helper: Column Letter to Index (A=1)
    const colToIndex = (char) => {
      let code = 0;
      for (let i = 0; i < char.length; i++) {
        code = code * 26 + char.charCodeAt(i) - 64;
      }
      return code;
    };

    // INTELLIGENT ROW FINDER
    // If no startRow provided, find the real bottom of the data in the target columns
    if (!startRow || startRow < 1) {
      if (mode === 'overwrite') {
        startRow = 1;
      } else {
        // Append mode: Find last row by checking the first mapped column
        const firstColIndex = colToIndex(mappings[0].sheetsCol);
        const lastRowInCol = sheet.getRange(1, firstColIndex).getNextDataCell(SpreadsheetApp.Direction.DOWN).getRow();
        
        // Safety: If column is empty or getNextDataCell fails (returns sheet limit/1)
        if (lastRowInCol === sheet.getMaxRows() || lastRowInCol === 1) {
           // Fallback to standard getLastRow
           startRow = sheet.getLastRow() + 1;
        } else {
           startRow = lastRowInCol + 1;
        }
        
        if (startRow <= 1) startRow = 2; // Usually skip row 1 (headers)
      }
    }

    const numRows = dataRows.length;
    if (numRows === 0) return reply({ result: 'success', info: 'No data to write' });

    // Write column by column
    mappings.forEach(m => {
      const targetCol = colToIndex(m.sheetsCol);
      const colValues = dataRows.map(row => [row[m.excelCol] !== undefined ? row[m.excelCol] : ""]);
      
      // If Overwrite, clear existing column data from startRow down to prevent "leftover" data
      if (mode === 'overwrite') {
        const lastPossibleRow = sheet.getMaxRows();
        if (lastPossibleRow >= startRow) {
          sheet.getRange(startRow, targetCol, lastPossibleRow - startRow + 1, 1).clearContent();
        }
      }
      
      sheet.getRange(startRow, targetCol, colValues.length, 1).setValues(colValues);
    });

    SpreadsheetApp.flush();
    return reply({ result: 'success', startRowUsed: startRow, rowsSent: numRows });

  } catch (err) {
    return reply({ result: 'error', message: err.message });
  }
}

function reply(obj) {
  return ContentService.createTextOutput(JSON.stringify(obj)).setMimeType(ContentService.MimeType.JSON);
}

</code></pre>
                    <p><em>(Copy the code above. Note: Use the "Copy" button if available or select all and copy)</em></p>

                    <h3>Step 3: Deploy as Web App</h3>
                    <ol>
                        <li>Click the blue <strong>Deploy</strong> button (top right) > <strong>New deployment</strong>.</li>
                        <li>Click the "Select type" gear icon > <strong>Web app</strong>.</li>
                        <li>Description: "Excel Sync".</li>
                        <li>Execute as: <strong>Me</strong> (your email).</li>
                        <li>Who has access: <strong>Anyone</strong> (IMPORTANT! This allows the app to send data without login).</li>
                        <li>Click <strong>Deploy</strong>.</li>
                        <li>Authorize access if prompted (Click Review permissions > Select account > Advanced > Go to (unsafe) > Allow).</li>
                    </ol>

                    <h3>Step 4: Get Your Web App URL</h3>
                    <ol>
                        <li>Copy the <strong>Web App URL</strong> provided (ends in <code>/exec</code>).</li>
                        <li>Keep this URL safe!</li>
                    </ol>

                    <h3>üöÄ Part 2: Using the Sheets Sync Feature</h3>
                    
                    <h3>Step 1: Enter Web App URL</h3>
                    <ol>
                        <li>In the app, paste the URL into the green "Google Apps Script Web App URL" box.</li>
                    </ol>
                    
                    <h3>Step 2: Configure & Sync</h3>
                    <ol>
                        <li>Enter your Google Sheet URL/ID and Tab Name.</li>
                        <li>Upload Excel file.</li>
                        <li>Map columns and click Sync!</li>
                    </ol>
                    
                    <h3>üìä Part 2: Prepare Your Google Sheet</h3>
                    
                    <h3>Step 1: Open or Create Your Google Sheet</h3>
                    <ol>
                        <li>Go to <a href="https://sheets.google.com" target="_blank"><strong>sheets.google.com</strong></a></li>
                        <li>Open your existing spreadsheet or create a new one</li>
                        <li>Note the <strong>sheet tab name</strong> at the bottom (e.g., "Sheet1", "My Data", "Import")</li>
                    </ol>
                    
                    <h3>Step 2: Get the Spreadsheet URL or ID</h3>
                    <ol>
                        <li>Look at your browser's address bar</li>
                        <li>The URL looks like: <code>https://docs.google.com/spreadsheets/d/ABC123xyz789/edit</code></li>
                        <li>The part between <code>/d/</code> and <code>/edit</code> is your <strong>Spreadsheet ID</strong></li>
                        <li>You can copy either the full URL or just the ID ‚Äî the app accepts both!</li>
                    </ol>
                    <p><em>Note: With this Web App method, your sheet remains private! Only the script (running as you) can access it.</em></p>
                    
                    <h3>üöÄ Part 3: Using the Sheets Sync Feature</h3>
                    
                    <h3>Step 1: Enter Web App URL</h3>
                    <ol>
                        <li>Go to the <strong>"Sheets Sync"</strong> tab in this app.</li>
                        <li>Paste your <strong>Google Apps Script Web App URL</strong> into the green input box.</li>
                    </ol>
                    
                    <h3>Step 2: Configure & Sync</h3>
                    <ol>
                        <li>Enter your <strong>Google Sheets URL or ID</strong> in the next field.</li>
                        <li>Enter the <strong>Sheet Name</strong> (tab name) exactly as it appears.</li>
                        <li>Upload your Excel file and map the columns.</li>
                        <li>Click <strong>"üöÄ Sync to Google Sheets"</strong>.</li>
                    </ol>
                    
                    <h3>‚ùì Troubleshooting Common Issues</h3>
                    
                    <p><strong>Error: "Invalid URL" or Sync fails immediately</strong></p>
                    <ul>
                        <li>Make sure the URL starts with <code>https://script.google.com/macros/s/...</code></li>
                        <li>Ensure it ends with <code>/exec</code> (not /dev).</li>
                        <li>Did you deploy as "Who has access: <strong>Anyone</strong>"? This is required.</li>
                    </ul>
                    
                    <p><strong>Error: "Sheet not found"</strong></p>
                    <ul>
                        <li>Verify the sheet tab name matches exactly (case-sensitive!).</li>
                        <li>Check for extra spaces in the name (e.g., "Sheet1 " vs "Sheet1").</li>
                    </ul>
                    
                    <p><strong>Data not appearing?</strong></p>
                    <ul>
                        <li>Check if you have "Overwrite" selected (this clears previous data).</li>
                        <li>If "Append", scroll down to find the new rows.</li>
                    </ul>
                    
                    <p><strong>Data appears in wrong columns</strong></p>
                    <ul>
                        <li>Double-check your column letter mappings</li>
                        <li>Remember: A=1, B=2, C=3, etc.</li>
                        <li>Column letters are case-insensitive (a = A)</li>
                    </ul>
                    
                    <h3>üí° Pro Tips</h3>
                    <ul>
                        <li>Save your Web App URL in a secure place ‚Äî you'll need it each time</li>
                        <li>The Web App URL acts like a password for writing to your sheet, so don't share it publicly</li>
                        <li>Test with a small Excel file first before syncing large datasets</li>
                        <li>The app skips the first row of Excel (assumes it's a header row)</li>
                        <li>Empty cells in Excel are transferred as empty cells in Google Sheets</li>
                        <li>You can sync to any column position ‚Äî they don't need to be consecutive</li>
                    </ul>
                `
            },

            // TO ADD A NEW TOPIC: Copy the template below, uncomment it, and fill in your content
            /*
            {
                icon: "üéØ",  // Choose an emoji icon
                title: "Your Topic Title Here",
                content: `
                    <h3>Section Heading</h3>
                    <p>Your paragraph text here.</p>
                    
                    <h3>Another Section</h3>
                    <ul>
                        <li>List item 1</li>
                        <li>List item 2</li>
                    </ul>
                    
                    <p>Use <code>code tags</code> for technical terms.</p>
                `
            },
            */
        ];

        // ============= KNOWLEDGE BASE FUNCTIONS =============
        function renderKnowledgeBase() {
            const container = document.getElementById('kbTopics');
            container.innerHTML = '';

            knowledgeBaseTopics.forEach((topic, index) => {
                const topicDiv = document.createElement('div');
                topicDiv.className = 'kb-topic';
                topicDiv.dataset.index = index;

                topicDiv.innerHTML = `
                    <div class="kb-topic-header">
                        <div class="kb-topic-title">
                            <span class="kb-topic-icon">${topic.icon}</span>
                            <span>${topic.title}</span>
                        </div>
                        <!-- Arrow removed, handled by CSS ::after -->
                    </div>
                    <div class="kb-topic-content">
                        <div class="kb-topic-body">
                            ${topic.content}
                        </div>
                    </div>
                `;

                topicDiv.querySelector('.kb-topic-header').addEventListener('click', () => {
                    topicDiv.classList.toggle('open');
                });

                container.appendChild(topicDiv);
            });
        }

        // Background Toggle Logic
        function toggleBackground() {
            const isHidden = document.body.classList.toggle('no-bg');
            safeStorage.setItem('eve_bg_hidden', isHidden);
            updateToggleUI(isHidden);
        }

        function updateToggleUI(isHidden) {
            const btn = document.getElementById('bgToggle');
            const icon = btn.querySelector('.icon');
            const text = btn.querySelector('.text');

            if (isHidden) {
                icon.src = 'images/favicon_munke.png';
                icon.classList.remove('large-scale');
                text.textContent = 'Show monkeys!';
            } else {
                icon.src = 'images/no_monkey_icon.png';
                icon.classList.add('large-scale');
                text.textContent = 'Hide monkeys!';
            }
        }

        const XLSX_URLS = [
            'vendor/xlsx.full.min.js',
            'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js'
        ];
        const JSZIP_URLS = [
            'vendor/jszip.min.js',
            'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js'
        ];

        function loadScript(url) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = url;
                script.async = true;
                script.onload = () => resolve(url);
                script.onerror = () => reject(new Error(`Failed to load ${url}`));
                document.head.appendChild(script);
            });
        }

        async function loadDependency(urls, globalName) {
            if (window[globalName]) {
                return true;
            }
            for (const url of urls) {
                try {
                    await loadScript(url);
                    if (window[globalName]) {
                        return true;
                    }
                } catch (error) {
                    // Try next URL
                }
            }
            throw new Error(`${globalName} failed to load. This network may block CDNs. Ask IT or add local vendor files.`);
        }

        let xlsxReady = null;
        let jszipReady = null;

        function ensureXlsx() {
            if (!xlsxReady) {
                xlsxReady = loadDependency(XLSX_URLS, 'XLSX');
            }
            return xlsxReady;
        }

        function ensureJsZip() {
            if (!jszipReady) {
                jszipReady = loadDependency(JSZIP_URLS, 'JSZip');
            }
            return jszipReady;
        }

        function yieldToUI() {
            return new Promise(resolve => setTimeout(resolve, 0));
        }

        function isXlsxFile(fileName) {
            return !!fileName && fileName.toLowerCase().endsWith('.xlsx');
        }

        function isCsvFile(fileName) {
            return !!fileName && fileName.toLowerCase().endsWith('.csv');
        }

        function stripXlsxExtension(fileName) {
            return fileName ? fileName.replace(/\.xlsx$/i, '') : '';
        }

        function formatFileSize(bytes) {
            if (!Number.isFinite(bytes)) return '0 MB';
            return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
        }

        function normalizeHeaders(headers, colCount) {
            const normalized = [];
            for (let i = 0; i < colCount; i++) {
                const header = headers && headers[i] !== undefined && headers[i] !== '' ? headers[i] : `(Column ${getColumnLetter(i)})`;
                normalized[i] = header;
            }
            return normalized;
        }

        function escapeCsvField(value, delimiter) {
            const text = value === null || value === undefined ? '' : String(value);
            const needsQuotes = text.includes('"') || text.includes('\n') || text.includes('\r') || text.includes(delimiter);
            if (!needsQuotes) return text;
            return `"${text.replace(/"/g, '""')}"`;
        }

        function rowsToCsv(rows, delimiter) {
            const delim = delimiter || ',';
            const lines = rows.map(row => row.map(cell => escapeCsvField(cell, delim)).join(delim));
            return lines.join('\r\n');
        }

        const HARD_LIMITS = {
            splitterXlsx: { maxSizeMB: 80, maxRows: 1000000, maxCols: 50 },
            splitterCsv: { maxSizeMB: 200, maxRows: 1000000, maxCols: 50 },
            syncXlsx: { maxSizeMB: 80, maxRows: 1000000, maxCols: 50 },
            syncCsv: { maxSizeMB: 200, maxRows: 1000000, maxCols: 50 }
        };
        const XLSX_MEMORY_RISK_MB = 75;

        function checkHardLimits(kind, file, info) {
            const limits = HARD_LIMITS[kind];
            if (!limits || !file || !info) {
                return { ok: true };
            }
            const errors = [];
            const sizeMB = file.size / (1024 * 1024);
            const dataRows = Math.max((info.rowCount || 0) - 1, 0);
            const colCount = info.colCount || 0;

            if (sizeMB > limits.maxSizeMB) {
                errors.push(`File size ${sizeMB.toFixed(1)} MB exceeds ${limits.maxSizeMB} MB limit.`);
            }
            if (dataRows > limits.maxRows) {
                errors.push(`Row count ${dataRows.toLocaleString()} exceeds ${limits.maxRows.toLocaleString()} rows.`);
            }
            if (colCount > limits.maxCols) {
                errors.push(`Column count ${colCount} exceeds ${limits.maxCols} columns.`);
            }

            if (errors.length > 0) {
                return {
                    ok: false,
                    message: `This file is above the supported limits:\n${errors.join('\n')}\n\nPlease reduce the file size or rows before continuing.`
                };
            }
            return { ok: true };
        }

        function checkXlsxMemoryRisk(file, contextLabel) {
            if (!file || !isXlsxFile(file.name)) {
                return { ok: true };
            }
            const sizeMB = file.size / (1024 * 1024);
            if (sizeMB <= XLSX_MEMORY_RISK_MB) {
                return { ok: true };
            }
            return {
                ok: false,
                message:
                    `${contextLabel}: "${file.name}" is ${sizeMB.toFixed(1)} MB.\n\n` +
                    `XLSX files above ${XLSX_MEMORY_RISK_MB} MB have a high risk of browser memory failures.\n\n` +
                    'Use CSV mode (if available), split the source file, or process smaller batches.'
            };
        }

        async function parseCsvStream(file, delimiter, onRow, onProgress) {
            const decoder = new TextDecoder('utf-8');
            const delim = delimiter || ',';
            let bytesRead = 0;
            let row = [];
            let field = '';
            let inQuotes = false;
            let pendingQuote = false;

            const emitRow = async () => {
                row.push(field);
                field = '';
                const rowData = row;
                row = [];
                if (onRow) {
                    await onRow(rowData);
                }
            };

            const processText = async (text) => {
                for (let i = 0; i < text.length; i++) {
                    let char = text[i];

                    if (pendingQuote) {
                        if (char === '"') {
                            field += '"';
                            pendingQuote = false;
                            continue;
                        }
                        pendingQuote = false;
                        inQuotes = false;
                        // Reprocess this character as non-quoted
                    }

                    if (inQuotes) {
                        if (char === '"') {
                            if (i + 1 < text.length) {
                                if (text[i + 1] === '"') {
                                    field += '"';
                                    i++;
                                } else {
                                    inQuotes = false;
                                }
                            } else {
                                pendingQuote = true;
                            }
                        } else {
                            field += char;
                        }
                        continue;
                    }

                    if (char === '"') {
                        inQuotes = true;
                    } else if (char === delim) {
                        row.push(field);
                        field = '';
                    } else if (char === '\n') {
                        await emitRow();
                    } else if (char === '\r') {
                        // Ignore
                    } else {
                        field += char;
                    }
                }
            };

            let reader = null;
            if (file && typeof file.stream === 'function') {
                const stream = file.stream();
                reader = stream && stream.getReader ? stream.getReader() : null;
            }

            if (reader) {
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    bytesRead += value.length;
                    const text = decoder.decode(value, { stream: true });
                    await processText(text);
                    if (onProgress) {
                        onProgress(bytesRead, file.size);
                    }
                }
                const tail = decoder.decode();
                if (tail) {
                    await processText(tail);
                }
            } else {
                const text = await file.text();
                bytesRead = text.length;
                await processText(text);
                if (onProgress) {
                    onProgress(bytesRead, file.size);
                }
            }

            if (pendingQuote) {
                pendingQuote = false;
                inQuotes = false;
            }

            if (field.length > 0 || row.length > 0) {
                await emitRow();
            }
        }

        async function scanCsvFile(file, delimiter, onProgress) {
            let headers = [];
            let rowCount = 0;
            let colCount = 0;
            let headerSet = false;

            await parseCsvStream(
                file,
                delimiter,
                async (row) => {
                    if (!headerSet) {
                        headers = row;
                        headerSet = true;
                        colCount = Math.max(colCount, row.length);
                    } else {
                        colCount = Math.max(colCount, row.length);
                    }
                    rowCount++;
                },
                onProgress
            );

            return { headers, rowCount, colCount };
        }

        const memoryStore = {};
        const safeStorage = {
            getItem(key) {
                try {
                    return localStorage.getItem(key);
                } catch (error) {
                    return Object.prototype.hasOwnProperty.call(memoryStore, key) ? memoryStore[key] : null;
                }
            },
            setItem(key, value) {
                try {
                    localStorage.setItem(key, value);
                } catch (error) {
                    memoryStore[key] = String(value);
                }
            }
        };

        const supportsWorker = 'Worker' in window;

        class XlsxWorkerClient {
            constructor() {
                this.worker = new Worker('xlsx-worker.js');
                this.nextId = 1;
                this.pending = new Map();
                this.worker.onmessage = (e) => {
                    const { id, ok, data, error } = e.data || {};
                    const entry = this.pending.get(id);
                    if (!entry) return;
                    this.pending.delete(id);
                    if (ok) {
                        entry.resolve(data);
                    } else {
                        entry.reject(new Error(error || 'Worker error'));
                    }
                };
                this.worker.onerror = (e) => {
                    this.rejectAll(e.message || 'Worker crashed');
                };
                this.worker.onmessageerror = () => {
                    this.rejectAll('Worker message error');
                };
            }

            rejectAll(message) {
                this.pending.forEach(entry => entry.reject(new Error(message)));
                this.pending.clear();
            }

            request(type, payload, transfer) {
                return new Promise((resolve, reject) => {
                    const id = this.nextId++;
                    this.pending.set(id, { resolve, reject });
                    try {
                        this.worker.postMessage({ id, type, ...payload }, transfer || []);
                    } catch (error) {
                        this.pending.delete(id);
                        reject(error);
                    }
                });
            }

            async init(file, sheetName) {
                const buffer = await file.arrayBuffer();
                return this.request('init', { buffer, sheetName }, [buffer]);
            }

            selectSheet(sheetName) {
                return this.request('selectSheet', { sheetName });
            }

            getInfo() {
                return this.request('getInfo', {});
            }

            getRows(startRow, endRow, maxCols) {
                return this.request('getRows', { startRow, endRow, maxCols });
            }

            terminate() {
                try {
                    this.worker.terminate();
                } catch (error) {
                    // Ignore
                }
                this.pending.clear();
            }
        }

        // Initialize Everything
        document.addEventListener('DOMContentLoaded', () => {
            renderKnowledgeBase();

            // Init Background
            const bgHidden = safeStorage.getItem('eve_bg_hidden') === 'true';
            if (bgHidden) {
                document.body.classList.add('no-bg');
            }
            updateToggleUI(bgHidden);

            document.getElementById('bgToggle').addEventListener('click', toggleBackground);

            const searchInput = document.getElementById('kbSearch');
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const topics = document.querySelectorAll('.kb-topic');

                topics.forEach(topic => {
                    const title = topic.querySelector('.kb-topic-title').textContent.toLowerCase();
                    const content = topic.querySelector('.kb-topic-body').textContent.toLowerCase();

                    if (title.includes(searchTerm) || content.includes(searchTerm)) {
                        topic.style.display = 'block';
                        if (searchTerm.length > 2) {
                            topic.classList.add('open');
                        }
                    } else {
                        topic.style.display = 'none';
                    }
                });

                if (searchTerm === '') {
                    topics.forEach(topic => {
                        topic.style.display = 'block';
                        topic.classList.remove('open');
                    });
                }
            });
        });

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const targetTab = tab.dataset.tab;

                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                tab.classList.add('active');
                document.getElementById(targetTab).classList.add('active');
            });
        });

        // ============= TAB 1: EXCEL SPLITTER =============
        let workbook1 = null;
        let worksheet1 = null;
        let sheetInfo1 = null;
        let outputHandle1 = null;
        let file1 = null;
        let worker1 = null;
        const supportsFS = 'showDirectoryPicker' in window;

        const uploadArea1 = document.getElementById('uploadArea1');
        const fileInput1 = document.getElementById('fileInput1');
        const csvMode1 = document.getElementById('csvMode1');
        const csvDelimiter1 = document.getElementById('csvDelimiter1');
        const fileInfo1 = document.getElementById('fileInfo1');
        const fileName1 = document.getElementById('fileName1');
        const fileDetails1 = document.getElementById('fileDetails1');
        const columnSection1 = document.getElementById('columnSection1');
        const splitColumn1 = document.getElementById('splitColumn1');
        const outputSection1 = document.getElementById('outputSection1');
        const selectFolder1 = document.getElementById('selectFolder1');
        const folderName1 = document.getElementById('folderName1');
        const csvOutput1 = document.getElementById('csvOutput1');
        const buttonGroup1 = document.getElementById('buttonGroup1');
        const processFolder1 = document.getElementById('processFolder1');
        const processZip1 = document.getElementById('processZip1');
        const progress1 = document.getElementById('progress1');
        const progressFill1 = document.getElementById('progressFill1');
        const status1 = document.getElementById('status1');
        const sheetSelector1Container = document.getElementById('sheetSelector1Container');
        const excelSheetSelect1 = document.getElementById('excelSheetSelect1');
        let useCsv1 = false;

        uploadArea1.addEventListener('click', () => fileInput1.click());

        csvMode1.addEventListener('change', () => {
            useCsv1 = csvMode1.checked;
            fileInput1.accept = useCsv1 ? '.csv,.CSV' : '.xlsx,.XLSX';
            resetSplitterState1();
            showStatus1(useCsv1 ? 'CSV mode enabled. Upload a .csv file.' : 'Excel mode enabled. Upload a .xlsx file.', 'info');
        });

        uploadArea1.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea1.classList.add('dragover');
        });

        uploadArea1.addEventListener('dragleave', () => {
            uploadArea1.classList.remove('dragover');
        });

        uploadArea1.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea1.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                handleFile1(e.dataTransfer.files[0]);
            }
        });

        fileInput1.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile1(e.target.files[0]);
            }
        });

        splitColumn1.addEventListener('change', () => {
            if (splitColumn1.value !== '') {
                outputSection1.classList.remove('hidden');
                buttonGroup1.classList.remove('hidden');
                processZip1.style.display = 'block';
                processFolder1.style.display = supportsFS ? 'block' : 'none';
                selectFolder1.disabled = !supportsFS;
                if (!supportsFS) {
                    folderName1.textContent = 'Folder access not supported in this browser. Use ZIP instead.';
                }
            } else {
                outputSection1.classList.add('hidden');
                buttonGroup1.classList.add('hidden');
            }
        });

        selectFolder1.addEventListener('click', selectOutputFolder1);
        processFolder1.addEventListener('click', () => processSplit1('folder'));
        processZip1.addEventListener('click', () => processSplit1('zip'));

        function resetSplitterState1() {
            file1 = null;
            sheetInfo1 = null;
            workbook1 = null;
            worksheet1 = null;
            if (worker1) {
                worker1.terminate();
                worker1 = null;
            }
            fileInfo1.classList.remove('show');
            columnSection1.classList.add('hidden');
            outputSection1.classList.add('hidden');
            buttonGroup1.classList.add('hidden');
            sheetSelector1Container.classList.add('hidden');
            splitColumn1.disabled = false;
        }

        async function handleFile1(file) {
            if (useCsv1) {
                if (!isCsvFile(file.name)) {
                    showStatus1('Please select a CSV file (.csv)', 'error');
                    return;
                }
            } else if (!isXlsxFile(file.name)) {
                showStatus1('Please select an Excel file (.xlsx)', 'error');
                return;
            }

            if (!useCsv1) {
                const memoryRisk = checkXlsxMemoryRisk(file, 'Excel Splitter');
                if (!memoryRisk.ok) {
                    showStatus1(memoryRisk.message, 'error');
                    return;
                }
            }

            file1 = file;
            fileName1.textContent = file.name;
            fileInfo1.classList.add('show');
            status1.classList.remove('show');
            outputHandle1 = null;

            if (useCsv1) {
                showStatus1('Scanning CSV file...', 'info');
                sheetSelector1Container.classList.add('hidden');
                workbook1 = null;
                worksheet1 = null;
                if (worker1) {
                    worker1.terminate();
                    worker1 = null;
                }

                const info = await scanCsvFile(file, csvDelimiter1.value, (bytesRead, totalBytes) => {
                    const percent = totalBytes ? Math.round((bytesRead / totalBytes) * 100) : 0;
                    showStatus1(`Scanning CSV file... ${percent}%`, 'info');
                });
                if (!info || info.rowCount === 0 || info.colCount === 0) {
                    showStatus1('CSV appears to be empty or unreadable.', 'error');
                    return;
                }
                info.headers = normalizeHeaders(info.headers || [], info.colCount || 0);
                sheetInfo1 = info;
                const limitCheck = checkHardLimits('splitterCsv', file1, info);
                if (!limitCheck.ok) {
                    showStatus1(limitCheck.message, 'error');
                    columnSection1.classList.add('hidden');
                    outputSection1.classList.add('hidden');
                    buttonGroup1.classList.add('hidden');
                    return;
                }

                splitColumn1.disabled = false;
                const dataRowCount = Math.max(info.rowCount - 1, 0);
                fileDetails1.textContent = `${dataRowCount} rows, ${info.colCount} columns ‚Ä¢ ${formatFileSize(file.size)}`;
                splitColumn1.innerHTML = '<option value="">-- Select a column --</option>';
                info.headers.forEach((header, index) => {
                    const colLetter = getColumnLetter(index);
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = `${colLetter}: ${header || `Column ${index + 1}`}`;
                    splitColumn1.appendChild(option);
                });
                columnSection1.classList.remove('hidden');
                outputSection1.classList.add('hidden');
                buttonGroup1.classList.add('hidden');
                showStatus1(`CSV loaded! Found ${info.colCount} columns. Choose a column to split by.`, 'success');
                return;
            }

            showStatus1('Loading file...', 'info');

            if (worker1) {
                worker1.terminate();
                worker1 = null;
            }
            workbook1 = null;
            worksheet1 = null;
            sheetInfo1 = null;

            let sheetNames = [];
            if (supportsWorker) {
                try {
                    worker1 = new XlsxWorkerClient();
                    const initData = await worker1.init(file);
                    sheetNames = initData.sheetNames || [];
                } catch (error) {
                    if (worker1) {
                        worker1.terminate();
                        worker1 = null;
                    }
                }
            }

            if (!worker1) {
                try {
                    await ensureXlsx();
                    const buffer = await file.arrayBuffer();
                    workbook1 = XLSX.read(buffer, { type: 'array' });
                    sheetNames = workbook1.SheetNames || [];
                } catch (error) {
                    showStatus1('Error reading file: ' + error.message, 'error');
                    return;
                }
            }

            if (!sheetNames.length) {
                showStatus1('No sheets found in this file.', 'error');
                return;
            }

            // Populate sheet selector
            excelSheetSelect1.innerHTML = '';
            sheetNames.forEach((name) => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                excelSheetSelect1.appendChild(option);
            });

            if (sheetNames.length > 1) {
                sheetSelector1Container.classList.remove('hidden');
            } else {
                sheetSelector1Container.classList.add('hidden');
            }

            await processWorksheet1(sheetNames[0]);
        }

        // Handle sheet change in Excel Splitter
        excelSheetSelect1.addEventListener('change', async (e) => {
            if (worker1 || workbook1) {
                await processWorksheet1(e.target.value);
            }
        });

        function getSheetInfoFromWorksheet(worksheet) {
            const range = XLSX.utils.decode_range(worksheet['!ref'] || 'A1');
            const rowCount = Math.max(0, range.e.r - range.s.r + 1);
            const colCount = Math.max(0, range.e.c - range.s.c + 1);
            const headerRows = XLSX.utils.sheet_to_json(worksheet, {
                header: 1,
                range: { s: { r: 0, c: 0 }, e: { r: 0, c: Math.max(colCount - 1, 0) } },
                defval: '',
                blankrows: false
            });
            const headers = headerRows[0] || [];
            const normalized = [];
            for (let i = 0; i < colCount; i++) {
                normalized[i] = headers[i] !== undefined && headers[i] !== '' ? headers[i] : `(Column ${getColumnLetter(i)})`;
            }
            return { rowCount, colCount, headers: normalized };
        }

        async function processWorksheet1(sheetName) {
            try {
                let info = null;
                if (worker1) {
                    info = await worker1.selectSheet(sheetName);
                } else {
                    worksheet1 = workbook1.Sheets[sheetName];
                    if (!worksheet1) return;
                    info = getSheetInfoFromWorksheet(worksheet1);
                }

                sheetInfo1 = info;

                if (!info || info.rowCount === 0) {
                    showStatus1(`The sheet "${sheetName}" is empty!`, 'warning');
                    return;
                }

                const limitCheck = checkHardLimits('splitterXlsx', file1, info);
                if (!limitCheck.ok) {
                    showStatus1(limitCheck.message, 'error');
                    columnSection1.classList.add('hidden');
                    outputSection1.classList.add('hidden');
                    buttonGroup1.classList.add('hidden');
                    return;
                }

                splitColumn1.disabled = false;
                const headers = info.headers || [];
                const dataRowCount = Math.max(info.rowCount - 1, 0);
                const sizeMb = file1 ? (file1.size / (1024 * 1024)).toFixed(1) : '0';
                fileDetails1.textContent = `${dataRowCount} rows, ${info.colCount} columns ‚Ä¢ ${sizeMb} MB`;

                splitColumn1.innerHTML = '<option value="">-- Select a column --</option>';
                headers.forEach((header, index) => {
                    const colLetter = getColumnLetter(index);
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = `${colLetter}: ${header || `Column ${index + 1}`}`;
                    splitColumn1.appendChild(option);
                });

                columnSection1.classList.remove('hidden');

                // Reset output sections if switching sheets
                outputSection1.classList.add('hidden');
                buttonGroup1.classList.add('hidden');
                folderName1.textContent = '';

                showStatus1(`Sheet "${sheetName}" loaded! Found ${headers.length} columns. Choose a column to split by.`, 'success');
            } catch (error) {
                showStatus1('Error processing sheet: ' + error.message, 'error');
            }
        }

        async function selectOutputFolder1() {
            if (!supportsFS) {
                showStatus1('Folder picker not supported. Use ZIP download instead.', 'info');
                return;
            }
            try {
                outputHandle1 = await window.showDirectoryPicker();
                folderName1.textContent = `‚úì Selected: ${outputHandle1.name}`;
                buttonGroup1.classList.remove('hidden');
                processFolder1.style.display = 'block';
                processZip1.style.display = 'block';
            } catch (error) {
                outputHandle1 = null;
                if (error.name !== 'AbortError') {
                    showStatus1('Folder picker blocked. Use ZIP download instead.', 'info');
                }
            }
        }

        function sanitizeFilename(name) {
            if (name === null || name === undefined) return null;
            let sanitized = String(name).trim();
            if (sanitized === '') return null;
            sanitized = sanitized
                .replace(/[<>:"\/\\|?*]/g, '_')
                .replace(/^[.\s]+|[.\s]+$/g, '');
            if (sanitized.length > 200) {
                sanitized = sanitized.substring(0, 200);
            }
            return sanitized || null;
        }

        async function processSplit1(mode) {
            const columnIndex = parseInt(splitColumn1.value);

            if (isNaN(columnIndex)) {
                showStatus1('Please select a split column first', 'error');
                return;
            }

            if (mode === 'folder' && !outputHandle1) {
                showStatus1('Please select an output folder first', 'error');
                return;
            }

            if (!sheetInfo1 || !file1) {
                showStatus1('Please upload an Excel file first', 'error');
                return;
            }
            if (columnIndex >= (sheetInfo1.colCount || 0)) {
                showStatus1('Selected column is out of range for this sheet', 'error');
                return;
            }

            showStatus1('Processing...', 'info');
            processFolder1.disabled = true;
            processZip1.disabled = true;
            progress1.classList.add('show');
            progressFill1.style.width = '0%';
            progressFill1.textContent = '0%';

            try {
                if (!useCsv1 || !csvOutput1.checked) {
                    await ensureXlsx();
                }
                const headers = sheetInfo1.headers || [];
                const totalRows = sheetInfo1.rowCount || 0;
                const totalCols = sheetInfo1.colCount || 0;
                const totalDataRows = Math.max(totalRows - 1, 0);

                if (file1.size > 80 * 1024 * 1024 || totalDataRows > 200000) {
                    const proceed = confirm(
                        `Large file detected (${(file1.size / (1024 * 1024)).toFixed(1)} MB, ${totalDataRows} rows).\n\n` +
                        'This can take a long time and use significant memory in the browser.\n\nContinue?'
                    );
                    if (!proceed) {
                        progress1.classList.remove('show');
                        processFolder1.disabled = false;
                        processZip1.disabled = false;
                        return;
                    }
                }

                const groups = new Map();
                let skippedRows = 0;
                let rowsProcessed = 0;
                const chunkSize = 5000;

                if (useCsv1) {
                    let rowIndex = 0;
                    await parseCsvStream(
                        file1,
                        csvDelimiter1.value,
                        async (row) => {
                            if (rowIndex === 0) {
                                rowIndex++;
                                return;
                            }
                            const criteriaValue = row[columnIndex];
                            const sanitized = sanitizeFilename(criteriaValue);
                            if (!sanitized) {
                                skippedRows++;
                                rowIndex++;
                                return;
                            }
                            if (!groups.has(sanitized)) {
                                groups.set(sanitized, []);
                            }
                            groups.get(sanitized).push(row);
                            rowIndex++;
                            rowsProcessed++;
                            if (rowsProcessed % (chunkSize * 2) === 0) {
                                await yieldToUI();
                            }
                        },
                        (bytesRead, totalBytes) => {
                            const percent = totalBytes ? Math.round((bytesRead / totalBytes) * 60) : 0;
                            progressFill1.style.width = percent + '%';
                            progressFill1.textContent = percent + '%';
                        }
                    );
                } else {
                    for (let startRow = 1; startRow < totalRows; startRow += chunkSize) {
                        const endRow = Math.min(totalRows - 1, startRow + chunkSize - 1);
                        let rows = [];

                        if (worker1) {
                            rows = await worker1.getRows(startRow, endRow, totalCols);
                        } else {
                            const range = { s: { r: startRow, c: 0 }, e: { r: endRow, c: Math.max(totalCols - 1, 0) } };
                            rows = XLSX.utils.sheet_to_json(worksheet1, {
                                header: 1,
                                range,
                                defval: '',
                                blankrows: true
                            });
                        }

                        for (const row of rows) {
                            const criteriaValue = row[columnIndex];
                            const sanitized = sanitizeFilename(criteriaValue);
                            if (!sanitized) {
                                skippedRows++;
                                continue;
                            }
                            if (!groups.has(sanitized)) {
                                groups.set(sanitized, []);
                            }
                            groups.get(sanitized).push(row);
                        }

                        rowsProcessed += rows.length;
                        const percent = totalDataRows > 0 ? Math.round((rowsProcessed / totalDataRows) * 60) : 60;
                        progressFill1.style.width = percent + '%';
                        progressFill1.textContent = percent + '%';

                        if (rowsProcessed % (chunkSize * 2) === 0) {
                            await yieldToUI();
                        }
                    }
                }

                const uniqueValues = Array.from(groups.keys());

                if (uniqueValues.length === 0) {
                    showStatus1('No rows found for the selected column.', 'error');
                    progress1.classList.remove('show');
                    processFolder1.disabled = false;
                    processZip1.disabled = false;
                    return;
                }

                if (mode === 'zip' && uniqueValues.length > 500) {
                    const proceedZip = confirm(
                        `This will create ${uniqueValues.length} files inside one ZIP.\n` +
                        'Large ZIPs can be slow to build in a browser.\n\nContinue?'
                    );
                    if (!proceedZip) {
                        progress1.classList.remove('show');
                        processFolder1.disabled = false;
                        processZip1.disabled = false;
                        return;
                    }
                }

                const useCsvOutput = csvOutput1.checked;
                const outputDelimiter = csvDelimiter1.value;

                if (mode === 'folder') {
                    await processToFolder1(uniqueValues, groups, headers, 60, useCsvOutput, outputDelimiter);
                } else {
                    await processToZip1(uniqueValues, groups, headers, 60, useCsvOutput, outputDelimiter);
                }

                let message = `‚úì Successfully created ${uniqueValues.length} file(s)`;
                if (skippedRows > 0) {
                    message += ` (${skippedRows} rows with empty values were skipped)`;
                }

                showStatus1(message, 'success');
                progress1.classList.remove('show');
            } catch (error) {
                showStatus1('Error processing file: ' + error.message, 'error');
                progress1.classList.remove('show');
            }

            processFolder1.disabled = false;
            processZip1.disabled = false;
        }

        async function processToFolder1(uniqueValues, groups, headers, progressStart, useCsvOutput, outputDelimiter) {
            let processed = 0;
            const total = uniqueValues.length || 1;

            for (const value of uniqueValues) {
                const valueRows = groups.get(value) || [];
                const rowCount = valueRows.length;
                const newData = [headers, ...valueRows];
                const filename = useCsvOutput ? `${value}_${rowCount}.csv` : `${value}_${rowCount}.xlsx`;

                const fileHandle = await outputHandle1.getFileHandle(filename, { create: true });
                const writable = await fileHandle.createWritable();

                if (useCsvOutput) {
                    const csvText = rowsToCsv(newData, outputDelimiter);
                    await writable.write(csvText);
                } else {
                    const newWorksheet = XLSX.utils.aoa_to_sheet(newData);
                    const newWorkbook = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(newWorkbook, newWorksheet, 'Sheet1');
                    const wbout = XLSX.write(newWorkbook, { bookType: 'xlsx', type: 'array' });
                    await writable.write(wbout);
                }
                await writable.close();

                processed++;
                const percent = progressStart + Math.round((processed / total) * (100 - progressStart));
                progressFill1.style.width = percent + '%';
                progressFill1.textContent = percent + '%';

                if (processed % 25 === 0) {
                    await yieldToUI();
                }
            }
        }

        async function processToZip1(uniqueValues, groups, headers, progressStart, useCsvOutput, outputDelimiter) {
            await ensureJsZip();
            const zip = new JSZip();
            let processed = 0;
            const total = uniqueValues.length || 1;

            for (const value of uniqueValues) {
                const valueRows = groups.get(value) || [];
                const rowCount = valueRows.length;
                const newData = [headers, ...valueRows];
                const filename = useCsvOutput ? `${value}_${rowCount}.csv` : `${value}_${rowCount}.xlsx`;

                if (useCsvOutput) {
                    const csvText = rowsToCsv(newData, outputDelimiter);
                    zip.file(filename, csvText);
                } else {
                    const newWorksheet = XLSX.utils.aoa_to_sheet(newData);
                    const newWorkbook = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(newWorkbook, newWorksheet, 'Sheet1');
                    const wbout = XLSX.write(newWorkbook, { bookType: 'xlsx', type: 'array' });
                    zip.file(filename, wbout);
                }

                processed++;
                const percent = progressStart + Math.round((processed / total) * (100 - progressStart));
                progressFill1.style.width = percent + '%';
                progressFill1.textContent = percent + '%';

                if (processed % 25 === 0) {
                    await yieldToUI();
                }
            }

            const zipBlob = await zip.generateAsync({ type: 'blob', streamFiles: true });
            const link = document.createElement('a');
            const url = URL.createObjectURL(zipBlob);
            link.href = url;
            link.download = 'split_files.zip';
            link.click();
            setTimeout(() => URL.revokeObjectURL(url), 10000);
        }

        function showStatus1(message, type) {
            status1.textContent = message;
            status1.className = 'status show ' + type;
        }

        // ============= TAB 2: EMAIL GENERATOR =============
        let inputHandle2 = null;
        let outputHandle2 = null;
        let excelFiles2 = [];
        let useFallbackMode2 = false; // Tracks if we are using the fallback (no FS API)

        const selectInput2 = document.getElementById('selectInput2');
        const fallbackBtn2 = document.getElementById('fallbackBtn2');
        const fallbackInput2 = document.getElementById('fallbackInput2');
        const inputFolder2 = document.getElementById('inputFolder2');
        const fileList2 = document.getElementById('fileList2');
        const emailConfig2 = document.getElementById('emailConfig2');
        const columnSection2 = document.getElementById('columnSection2');
        const emailColumn2 = document.getElementById('emailColumn2');
        const outputSection2 = document.getElementById('outputSection2');
        const selectOutput2 = document.getElementById('selectOutput2');
        const outputFolder2 = document.getElementById('outputFolder2');
        const generate2 = document.getElementById('generate2');
        const progress2 = document.getElementById('progress2');
        const progressFill2 = document.getElementById('progressFill2');
        const status2 = document.getElementById('status2');

        selectInput2.addEventListener('click', selectInputFolder2);
        fallbackBtn2.addEventListener('click', () => fallbackInput2.click());
        fallbackInput2.addEventListener('change', handleFallbackFiles2);
        selectOutput2.addEventListener('click', selectOutputFolder2);
        generate2.addEventListener('click', generateEmails2);

        emailColumn2.addEventListener('change', () => {
            updateGenerateState2();
        });

        function updateGenerateState2() {
            const hasFiles = excelFiles2.length > 0;
            const hasColumn = emailColumn2.value !== '';
            generate2.disabled = !(hasFiles && hasColumn);
        }

        async function selectInputFolder2() {
            // Reset fallback mode
            useFallbackMode2 = false;

            if ('showDirectoryPicker' in window) {
                try {
                    inputHandle2 = await window.showDirectoryPicker();
                    inputFolder2.textContent = `‚úì Selected: ${inputHandle2.name}`;
                    await loadExcelFiles2();
                } catch (error) {
                    if (error.name === 'AbortError') return;
                    // If some other error or user cancels, or restricted?
                    // Fallback to input click if it seems like a permission/support issue?
                    // Usually AbortError is just cancel. 
                    // Let's assume explicit error means "try fallback" or show error.
                    // For now, if showDirectoryPicker fails/user denies, we could suggest fallback.
                    // But simpler: just try-catch and if error is not abort, maybe fallback?
                    // Actually, safest is: if API exists, try it. If it throws "SecurityError" etc, try fallback.
                    console.warn("Directory Picker failed/cancelled, checking legacy input...", error);
                    // Force fallback if error was not abort? 
                    // Let's just encourage user to use the fallback if they prefer.
                    // Actually, improving robustness: prompt user? 
                    // No, let's keep it simple: If API calls fail, we can't easily auto-switch to file input click (trusted event).
                    // We'll rely on the user. 
                    // WAIT: User said "work pc where there might be some permission issues".
                    // Code below handles the flow where we switch to fallback if desired.
                    showStatus2('Folder picker blocked. Please use the fallback file picker below.', 'info');
                    fallbackInput2.click();
                }
            } else {
                // API not supported
                showStatus2('Folder picker not supported. Please use the fallback file picker below.', 'info');
                fallbackInput2.click();
            }
        }

        function handleFallbackFiles2(e) {
            const files = Array.from(e.target.files).filter(f => isXlsxFile(f.name));
            if (files.length > 0) {
                useFallbackMode2 = true;
                inputFolder2.textContent = `‚úì Selected: ${files.length} file(s)`;

                // Wrap files to look like handles
                excelFiles2 = files.map(f => ({
                    kind: 'file',
                    name: f.name,
                    getFile: async () => f
                }));

                processLoadedFiles2();
            } else {
                showStatus2('No Excel (.xlsx) files selected', 'error');
            }
        }

        async function loadExcelFiles2() {
            excelFiles2 = [];
            fileList2.innerHTML = '';

            try {
                for await (const entry of inputHandle2.values()) {
                    if (entry.kind === 'file' && isXlsxFile(entry.name)) {
                        excelFiles2.push(entry);
                    }
                }
                processLoadedFiles2();
            } catch (error) {
                showStatus2('Error reading folder: ' + error.message, 'error');
                showStatus2('If this keeps failing, use the fallback file picker below.', 'info');
            }
        }

        async function processLoadedFiles2() {
            fileList2.innerHTML = '';

            // Sort alphabetically
            excelFiles2.sort((a, b) => a.name.localeCompare(b.name));

            if (excelFiles2.length === 0) {
                showStatus2('No Excel files found', 'error');
                return;
            }

            const maxList = 200;
            excelFiles2.slice(0, maxList).forEach(entry => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.textContent = `üìÑ ${entry.name}`;
                fileList2.appendChild(fileItem);
            });
            if (excelFiles2.length > maxList) {
                const moreItem = document.createElement('div');
                moreItem.className = 'file-item';
                moreItem.textContent = `‚Ä¶and ${excelFiles2.length - maxList} more`;
                fileList2.appendChild(moreItem);
            }

            showStatus2(`Found ${excelFiles2.length} Excel file(s)`, 'success');
            await loadColumnNames2();
            emailConfig2.classList.remove('hidden');
            outputSection2.classList.remove('hidden');
            generate2.classList.remove('hidden');
            updateGenerateState2();

            // Adjust UI for fallback
            if (useFallbackMode2) {
                const outBtn = document.getElementById('selectOutput2');
                outBtn.textContent = "(Optional) Select Output Folder";
                // Update help text
                document.getElementById('outputFolder2').innerHTML = "<em>If no folder selected, files will download as ZIP.</em>";
            }
        }

        async function getSheetInfoFromFile2(file) {
            const memoryRisk = checkXlsxMemoryRisk(file, 'Email Jobs');
            if (!memoryRisk.ok) {
                throw new Error(memoryRisk.message);
            }

            if (supportsWorker) {
                const worker = new XlsxWorkerClient();
                try {
                    await worker.init(file);
                    const info = await worker.getInfo();
                    worker.terminate();
                    return info;
                } catch (error) {
                    worker.terminate();
                }
            }

            await ensureXlsx();
            const arrayBuffer = await file.arrayBuffer();
            const workbook = XLSX.read(arrayBuffer, { type: 'array' });
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            return getSheetInfoFromWorksheet(firstSheet);
        }

        async function loadColumnNames2() {
            try {
                const firstFile = excelFiles2[0];
                const file = await firstFile.getFile();
                const info = await getSheetInfoFromFile2(file);
                const headers = (info && info.headers) ? info.headers : [];
                if (headers.length > 0) {
                    emailColumn2.innerHTML = '<option value="">-- Select a column --</option>';
                    headers.forEach((header, index) => {
                        const option = document.createElement('option');
                        option.value = index;
                        option.textContent = header || `Column ${index + 1}`;
                        emailColumn2.appendChild(option);
                    });
                    columnSection2.classList.remove('hidden');
                    updateGenerateState2();
                } else {
                    showStatus2('Could not read headers from the first file', 'error');
                }
            } catch (error) {
                showStatus2('Error reading Excel file: ' + error.message, 'error');
            }
        }

        async function selectOutputFolder2() {
            if (!('showDirectoryPicker' in window)) {
                showStatus2('Folder picker not supported. ZIP download will be used instead.', 'info');
                updateGenerateState2();
                return;
            }
            try {
                outputHandle2 = await window.showDirectoryPicker();
                outputFolder2.textContent = `‚úì Selected: ${outputHandle2.name}`;
                updateGenerateState2();
            } catch (error) {
                if (error.name !== 'AbortError') {
                    showStatus2('Error selecting output folder: ' + error.message, 'error');
                }
                // If fallback mode, we can proceed without output folder (Zip mode)
                updateGenerateState2();
            }
        }

        async function extractEmailsFromFile(file, emailColumnIndex, onProgress) {
            const memoryRisk = checkXlsxMemoryRisk(file, 'Email Jobs');
            if (!memoryRisk.ok) {
                throw new Error(memoryRisk.message);
            }

            const emails = new Set();
            const chunkSize = 5000;

            if (supportsWorker) {
                const worker = new XlsxWorkerClient();
                try {
                    await worker.init(file);
                    const info = await worker.getInfo();
                    const totalRows = info.rowCount || 0;
                    const totalCols = info.colCount || 0;

                    if (emailColumnIndex >= totalCols) {
                        worker.terminate();
                        return { emails: [], totalRows };
                    }

                    let rowsProcessed = 0;
                    for (let startRow = 1; startRow < totalRows; startRow += chunkSize) {
                        const endRow = Math.min(totalRows - 1, startRow + chunkSize - 1);
                        const rows = await worker.getRows(startRow, endRow, totalCols);
                        for (const row of rows) {
                            const email = row[emailColumnIndex];
                            const parsed = parseEmailList2(email);
                            for (const addr of parsed) {
                                emails.add(addr);
                            }
                        }
                        rowsProcessed += rows.length;
                        if (typeof onProgress === 'function' && totalRows > 1) {
                            onProgress(rowsProcessed / Math.max(totalRows - 1, 1));
                        }
                        if (rowsProcessed % (chunkSize * 2) === 0) {
                            await yieldToUI();
                        }
                    }

                    worker.terminate();
                    return { emails: Array.from(emails), totalRows };
                } catch (error) {
                    worker.terminate();
                }
            }

            await ensureXlsx();
            const arrayBuffer = await file.arrayBuffer();
            const workbook = XLSX.read(arrayBuffer, { type: 'array' });
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const info = getSheetInfoFromWorksheet(firstSheet);
            const totalRows = info.rowCount || 0;
            const totalCols = info.colCount || 0;

            if (emailColumnIndex >= totalCols) {
                return { emails: [], totalRows };
            }

            let rowsProcessed = 0;
            for (let startRow = 1; startRow < totalRows; startRow += chunkSize) {
                const endRow = Math.min(totalRows - 1, startRow + chunkSize - 1);
                const range = { s: { r: startRow, c: 0 }, e: { r: endRow, c: Math.max(totalCols - 1, 0) } };
                const rows = XLSX.utils.sheet_to_json(firstSheet, {
                    header: 1,
                    range,
                    defval: '',
                    blankrows: true
                });
                for (const row of rows) {
                    const email = row[emailColumnIndex];
                    const parsed = parseEmailList2(email);
                    for (const addr of parsed) {
                        emails.add(addr);
                    }
                }
                rowsProcessed += rows.length;
                if (typeof onProgress === 'function' && totalRows > 1) {
                    onProgress(rowsProcessed / Math.max(totalRows - 1, 1));
                }
                if (rowsProcessed % (chunkSize * 2) === 0) {
                    await yieldToUI();
                }
            }

            return { emails: Array.from(emails), totalRows };
        }

                async function generateEmails2() {
            const emailColumnIndex = parseInt(emailColumn2.value, 10);

            if (isNaN(emailColumnIndex)) {
                showStatus2('Please select an email column', 'error');
                return;
            }

            if (excelFiles2.length === 0) {
                showStatus2('No Excel files loaded.', 'error');
                return;
            }

            const isZipMode = !outputHandle2;
            const subjectTemplate = document.getElementById('emailSubject2').value || 'Report';
            const bodyTemplate = document.getElementById('emailBody2').value || '';
            const cc = (document.getElementById('ccEmail2').value || '').trim();

            const batchConfirm = confirm(
                `Create draft emails for ${excelFiles2.length} file(s)?\n\n` +
                `Output: ${isZipMode ? 'ZIP download' : 'Selected folder'}\n` +
                `Each draft will include the source Excel file as attachment.`
            );
            if (!batchConfirm) {
                showStatus2('Draft generation cancelled by user.', 'warning');
                return;
            }

            if (excelFiles2.length >= 75) {
                const largeBatchConfirm = confirm(
                    `Large batch detected (${excelFiles2.length} files). Continue generating all drafts now?`
                );
                if (!largeBatchConfirm) {
                    showStatus2('Draft generation cancelled by user.', 'warning');
                    return;
                }
            }

            generate2.disabled = true;
            progress2.classList.add('show');
            progressFill2.style.width = '0%';
            progressFill2.textContent = '0%';
            showStatus2(isZipMode ? 'Generating draft ZIP...' : 'Generating draft files...', 'info');

            try {
                const createdAt = new Date().toISOString();
                let created = 0;
                let skipped = 0;
                const report = [];

                let zip = null;
                if (isZipMode) {
                    await ensureJsZip();
                    zip = new JSZip();
                }

                for (let fileIndex = 0; fileIndex < excelFiles2.length; fileIndex++) {
                    const fileEntry = excelFiles2[fileIndex];
                    const file = await fileEntry.getFile();
                    const progressBase = fileIndex / excelFiles2.length;
                    const progressSpan = 1 / excelFiles2.length;

                    let uniqueEmails = [];
                    try {
                        const extracted = await extractEmailsFromFile(file, emailColumnIndex, (fileProgress) => {
                            const overall = Math.round((progressBase + (fileProgress * progressSpan)) * 100);
                            progressFill2.style.width = overall + '%';
                            progressFill2.textContent = overall + '%';
                        });
                        uniqueEmails = extracted.emails || [];
                    } catch (error) {
                        skipped++;
                        report.push({ sourceFile: file.name, status: 'error', reason: error.message });
                        continue;
                    }

                    if (uniqueEmails.length === 0) {
                        skipped++;
                        report.push({ sourceFile: file.name, status: 'skipped', reason: 'No valid recipient emails found in selected column.' });
                        continue;
                    }

                    const baseName = stripXlsxExtension(file.name);
                    const draftFileName = `${baseName}.draft.eml`;
                    const emailSubject = subjectTemplate.replace(/\{\{filename\}\}/g, baseName);
                    const bodyText = bodyTemplate.replace(/\{\{filename\}\}/g, baseName);

                    const emailJob = {
                        sourceFile: {
                            name: file.name,
                            sizeBytes: file.size
                        },
                        message: {
                            to: uniqueEmails,
                            cc: cc ? [cc] : [],
                            subject: emailSubject,
                            bodyText
                        }
                    };

                    const attachmentBuffer = await file.arrayBuffer();
                    const emlContent = buildEmlDraftFromJob2(emailJob, file.name, attachmentBuffer);

                    if (isZipMode) {
                        zip.file(draftFileName, emlContent);
                    } else {
                        const fileHandle = await outputHandle2.getFileHandle(draftFileName, { create: true });
                        const writable = await fileHandle.createWritable();
                        await writable.write(emlContent);
                        await writable.close();
                    }

                    created++;
                    report.push({
                        sourceFile: file.name,
                        status: 'created',
                        draftFile: draftFileName,
                        recipients: uniqueEmails.length
                    });

                    const percent = Math.round(((fileIndex + 1) / excelFiles2.length) * 100);
                    progressFill2.style.width = percent + '%';
                    progressFill2.textContent = percent + '%';
                    await yieldToUI();
                }

                const reportJson = JSON.stringify({
                    schemaVersion: '1.0',
                    generatedAt: createdAt,
                    totalFiles: excelFiles2.length,
                    created,
                    skipped,
                    report
                }, null, 2);

                if (isZipMode) {
                    zip.file('email-drafts-report.json', reportJson);
                    const zipBlob = await zip.generateAsync({ type: 'blob', streamFiles: true });
                    const link = document.createElement('a');
                    const url = URL.createObjectURL(zipBlob);
                    link.href = url;
                    link.download = 'email_drafts.zip';
                    link.click();
                    setTimeout(() => URL.revokeObjectURL(url), 10000);
                } else {
                    const reportHandle = await outputHandle2.getFileHandle('email-drafts-report.json', { create: true });
                    const reportWritable = await reportHandle.createWritable();
                    await reportWritable.write(reportJson);
                    await reportWritable.close();
                }

                showStatus2(`Created ${created} draft(s), skipped ${skipped}.`, created > 0 ? 'success' : 'warning');
            } catch (error) {
                showStatus2('Error generating drafts: ' + error.message, 'error');
            }

            progress2.classList.remove('show');
            generate2.disabled = false;
        }

        function showStatus2(message, type) {
            status2.textContent = message;
            status2.className = 'status show ' + type;
        }

        function parseEmailList2(rawValue) {
            if (rawValue === null || rawValue === undefined) return [];
            const parts = String(rawValue)
                .split(/[;,\n\r\t ]+/)
                .map(v => v.trim())
                .filter(Boolean);

            const valid = [];
            for (const p of parts) {
                const normalized = p.replace(/^<|>$/g, '');
                if (/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(normalized)) {
                    valid.push(normalized);
                }
            }
            return valid;
        }

        function getAttachmentMimeType2(fileName) {
            const lower = (fileName || '').toLowerCase();
            if (lower.endsWith('.xlsx')) return 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';
            if (lower.endsWith('.xls')) return 'application/vnd.ms-excel';
            if (lower.endsWith('.csv')) return 'text/csv';
            return 'application/octet-stream';
        }

        function sanitizeHeaderValue2(value) {
            return String(value || '').replace(/[\r\n]+/g, ' ').trim();
        }

        function sanitizeAsciiFileName2(fileName) {
            const clean = sanitizeHeaderValue2(fileName || 'attachment.bin');
            const ascii = clean.replace(/[^\x20-\x7E]/g, '_').replace(/["\\]/g, '_');
            return ascii || 'attachment.bin';
        }

        function foldHeader2(headerName, values) {
            const list = Array.isArray(values) ? values : (values ? [values] : []);
            if (list.length === 0) return '';

            let line = `${headerName}: `;
            const lines = [];
            const maxLen = 78;

            for (let i = 0; i < list.length; i++) {
                const token = String(list[i]);
                const suffix = i < list.length - 1 ? ', ' : '';
                if ((line + token + suffix).length > maxLen && line !== `${headerName}: `) {
                    lines.push(line);
                    line = ` ${token}${suffix}`;
                } else {
                    line += `${token}${suffix}`;
                }
            }
            lines.push(line);
            return lines.join('\r\n') + '\r\n';
        }

        function bufferToBase64Lines2(buffer) {
            const bytes = new Uint8Array(buffer);
            const chunkSize = 0x8000;
            let binary = '';
            for (let i = 0; i < bytes.length; i += chunkSize) {
                binary += String.fromCharCode.apply(null, bytes.subarray(i, i + chunkSize));
            }
            const base64 = btoa(binary);
            return (base64.match(/.{1,76}/g) || []).join('\r\n');
        }

        function buildEmlDraftFromJob2(job, attachmentName, attachmentBuffer) {
            const boundary = '----=_Part_' + Date.now() + '_' + Math.random().toString(36).slice(2);
            const toList = Array.isArray(job.message?.to) ? job.message.to : [];
            const ccList = Array.isArray(job.message?.cc) ? job.message.cc : [];
            const subject = sanitizeHeaderValue2(job.message?.subject || '');
            const body = String(job.message?.bodyText || '').replace(/\r?\n/g, '\r\n');
            const mimeType = getAttachmentMimeType2(attachmentName);
            const attachmentBase64 = bufferToBase64Lines2(attachmentBuffer);
            const safeAttachmentName = sanitizeAsciiFileName2(attachmentName);
            const now = new Date().toUTCString();
            const messageId = `<${Date.now()}.${Math.random().toString(36).slice(2)}@local.invalid>`;

            let eml = '';
            eml += 'From: Draft Generator <no-reply@local.invalid>\r\n';
            eml += foldHeader2('To', toList);
            if (ccList.length > 0) eml += foldHeader2('Cc', ccList);
            eml += `Subject: ${subject}\r\n`;
            eml += `Date: ${now}\r\n`;
            eml += `Message-ID: ${messageId}\r\n`;
            eml += 'X-Unsent: 1\r\n';
            eml += 'MIME-Version: 1.0\r\n';
            eml += `Content-Type: multipart/mixed; boundary="${boundary}"\r\n`;
            eml += '\r\n';
            eml += `--${boundary}\r\n`;
            eml += 'Content-Type: text/plain; charset="UTF-8"\r\n';
            eml += 'Content-Transfer-Encoding: 7bit\r\n';
            eml += '\r\n';
            eml += body + '\r\n';
            eml += `--${boundary}\r\n`;
            eml += `Content-Type: ${mimeType}; name="${safeAttachmentName}"\r\n`;
            eml += 'Content-Transfer-Encoding: base64\r\n';
            eml += `Content-Disposition: attachment; filename="${safeAttachmentName}"\r\n`;
            eml += '\r\n';
            eml += attachmentBase64 + '\r\n';
            eml += `--${boundary}--\r\n`;
            return eml;
        }
        // ============= TAB 4: GOOGLE SHEETS SYNC =============
        let workbook4 = null;
        let worksheet4 = null;
        let sheetInfo4 = null;
        let headers4 = [];
        let columnMappings4 = [];
        let file4 = null;
        let worker4 = null;

        // DOM Elements
        const uploadArea4 = document.getElementById('uploadArea4');
        const fileInput4 = document.getElementById('fileInput4');
        const csvMode4 = document.getElementById('csvMode4');
        const csvDelimiter4 = document.getElementById('csvDelimiter4');
        const fileInfo4 = document.getElementById('fileInfo4');
        const fileName4 = document.getElementById('fileName4');
        const fileDetails4 = document.getElementById('fileDetails4');
        const modeSection4 = document.getElementById('modeSection4');
        const mappingSection4 = document.getElementById('mappingSection4');
        const mappingRows4 = document.getElementById('mappingRows4');
        const addMapping4 = document.getElementById('addMapping4');
        const syncBtn4 = document.getElementById('syncBtn4');
        const progress4 = document.getElementById('progress4');
        const progressFill4 = document.getElementById('progressFill4');
        const status4 = document.getElementById('status4');
        const webAppUrl4 = document.getElementById('webAppUrl4');
        const sheetsUrl4 = document.getElementById('sheetsUrl4');
        const sheetName4 = document.getElementById('sheetName4');
        const startRow4 = document.getElementById('startRow4');
        const sheetSelector4Container = document.getElementById('sheetSelector4Container');
        const excelSheetSelect4 = document.getElementById('excelSheetSelect4');
        let useCsv4 = false;

        // Radio button styling (Updated for Card UI)
        document.querySelectorAll('input[name="importMode4"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                document.querySelectorAll('.mode-card').forEach(opt => opt.classList.remove('selected'));
                e.target.closest('.mode-card').classList.add('selected');
            });
        });

        // Load saved settings from storage (may be restricted in some environments)
        window.addEventListener('load', () => {
            const savedWebAppUrl = safeStorage.getItem('eve_webAppUrl');
            const savedSheetsUrl = safeStorage.getItem('eve_sheetsUrl');
            const savedSheetName = safeStorage.getItem('eve_sheetName');

            if (savedWebAppUrl) webAppUrl4.value = savedWebAppUrl;
            if (savedSheetsUrl) sheetsUrl4.value = savedSheetsUrl;
            if (savedSheetName) sheetName4.value = savedSheetName;
        });

        // File upload handlers
        csvMode4.addEventListener('change', () => {
            useCsv4 = csvMode4.checked;
            fileInput4.accept = useCsv4 ? '.csv,.CSV' : '.xlsx,.XLSX';
            resetSyncState4();
            showStatus4(useCsv4 ? 'CSV mode enabled. Upload a .csv file.' : 'Excel mode enabled. Upload a .xlsx file.', 'info');
        });

        function resetSyncState4() {
            file4 = null;
            sheetInfo4 = null;
            workbook4 = null;
            worksheet4 = null;
            headers4 = [];
            columnMappings4 = [];
            if (worker4) {
                worker4.terminate();
                worker4 = null;
            }
            fileInfo4.classList.remove('show');
            mappingSection4.classList.add('hidden');
            modeSection4.classList.add('hidden');
            syncBtn4.classList.add('hidden');
            sheetSelector4Container.classList.add('hidden');
        }
        uploadArea4.addEventListener('click', () => fileInput4.click());

        uploadArea4.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea4.classList.add('dragover');
        });

        uploadArea4.addEventListener('dragleave', () => {
            uploadArea4.classList.remove('dragover');
        });

        uploadArea4.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea4.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                handleFile4(e.dataTransfer.files[0]);
            }
        });

        fileInput4.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile4(e.target.files[0]);
            }
        });

        async function handleFile4(file) {
            if (useCsv4) {
                if (!isCsvFile(file.name)) {
                    showStatus4('Please select a CSV file (.csv)', 'error');
                    return;
                }
            } else if (!isXlsxFile(file.name)) {
                showStatus4('Please select an Excel file (.xlsx)', 'error');
                return;
            }

            if (!useCsv4) {
                const memoryRisk = checkXlsxMemoryRisk(file, 'Google Sheets Sync');
                if (!memoryRisk.ok) {
                    showStatus4(memoryRisk.message, 'error');
                    return;
                }
            }

            file4 = file;
            fileName4.textContent = file.name;
            fileInfo4.classList.add('show');

            if (useCsv4) {
                showStatus4('Scanning CSV file...', 'info');
                sheetSelector4Container.classList.add('hidden');
                if (worker4) {
                    worker4.terminate();
                    worker4 = null;
                }
                workbook4 = null;
                worksheet4 = null;
                sheetInfo4 = null;

                const info = await scanCsvFile(file, csvDelimiter4.value, (bytesRead, totalBytes) => {
                    const percent = totalBytes ? Math.round((bytesRead / totalBytes) * 100) : 0;
                    showStatus4(`Scanning CSV file... ${percent}%`, 'info');
                });
                if (!info || info.rowCount === 0 || info.colCount === 0) {
                    showStatus4('CSV appears to be empty or unreadable.', 'error');
                    return;
                }
                info.headers = normalizeHeaders(info.headers || [], info.colCount || 0);
                sheetInfo4 = info;
                const limitCheck = checkHardLimits('syncCsv', file4, info);
                if (!limitCheck.ok) {
                    showStatus4(limitCheck.message, 'error');
                    mappingSection4.classList.add('hidden');
                    modeSection4.classList.add('hidden');
                    syncBtn4.classList.add('hidden');
                    return;
                }

                headers4 = info.headers || [];
                const totalColumns = info.colCount || headers4.length;
                const dataRowCount = Math.max(info.rowCount - 1, 0);
                const lastColLabel = totalColumns > 0 ? getColumnLetter(totalColumns - 1) : 'A';
                fileDetails4.textContent = `${dataRowCount} rows, ${totalColumns} columns (A to ${lastColLabel}) ‚Ä¢ ${formatFileSize(file.size)}`;

                mappingRows4.innerHTML = '';
                columnMappings4 = [];
                addMappingRow4();

                modeSection4.classList.remove('hidden');
                mappingSection4.classList.remove('hidden');
                syncBtn4.classList.remove('hidden');
                showStatus4(`CSV loaded! Found ${totalColumns} columns. Configure column mappings below.`, 'success');
                return;
            }

            showStatus4('Loading file...', 'info');

            if (worker4) {
                worker4.terminate();
                worker4 = null;
            }
            workbook4 = null;
            worksheet4 = null;
            sheetInfo4 = null;

            let sheetNames = [];
            if (supportsWorker) {
                try {
                    worker4 = new XlsxWorkerClient();
                    const initData = await worker4.init(file);
                    sheetNames = initData.sheetNames || [];
                } catch (error) {
                    if (worker4) {
                        worker4.terminate();
                        worker4 = null;
                    }
                }
            }

            if (!worker4) {
                try {
                    await ensureXlsx();
                    const buffer = await file.arrayBuffer();
                    workbook4 = XLSX.read(buffer, { type: 'array' });
                    sheetNames = workbook4.SheetNames || [];
                } catch (error) {
                    showStatus4('Error reading file: ' + error.message, 'error');
                    return;
                }
            }

            if (!sheetNames.length) {
                showStatus4('No sheets found in this file.', 'error');
                return;
            }

            // Populate sheet selector
            excelSheetSelect4.innerHTML = '';
            sheetNames.forEach((name) => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                excelSheetSelect4.appendChild(option);
            });

            if (sheetNames.length > 1) {
                sheetSelector4Container.classList.remove('hidden');
            } else {
                sheetSelector4Container.classList.add('hidden');
            }

            await processWorksheet4(sheetNames[0]);

            // Show configuration sections
            modeSection4.classList.remove('hidden');
            mappingSection4.classList.remove('hidden');
            syncBtn4.classList.remove('hidden');
        }

        // Handle sheet change in Excel
        excelSheetSelect4.addEventListener('change', async (e) => {
            if (worker4 || workbook4) {
                await processWorksheet4(e.target.value);
            }
        });

        async function processWorksheet4(sheetName) {
            try {
                let info = null;
                if (worker4) {
                    info = await worker4.selectSheet(sheetName);
                } else {
                    worksheet4 = workbook4.Sheets[sheetName];
                    if (!worksheet4) return;
                    info = getSheetInfoFromWorksheet(worksheet4);
                }

                sheetInfo4 = info;

                if (!info || info.rowCount === 0) {
                    showStatus4(`The sheet "${sheetName}" is empty!`, 'warning');
                    return;
                }

                const limitCheck = checkHardLimits('syncXlsx', file4, info);
                if (!limitCheck.ok) {
                    showStatus4(limitCheck.message, 'error');
                    mappingSection4.classList.add('hidden');
                    modeSection4.classList.add('hidden');
                    syncBtn4.classList.add('hidden');
                    return;
                }

                headers4 = info.headers || [];
                const totalColumns = info.colCount || headers4.length;
                const dataRowCount = Math.max(info.rowCount - 1, 0);
                const sizeMb = file4 ? (file4.size / (1024 * 1024)).toFixed(1) : '0';
                const lastColLabel = totalColumns > 0 ? getColumnLetter(totalColumns - 1) : 'A';
                fileDetails4.textContent = `${dataRowCount} rows, ${totalColumns} columns (A to ${lastColLabel}) ‚Ä¢ ${sizeMb} MB`;

                // Clear previous mappings and add one default mapping
                mappingRows4.innerHTML = '';
                columnMappings4 = [];
                addMappingRow4();

                showStatus4(`Sheet "${sheetName}" loaded! Found ${totalColumns} columns. Configure column mappings below.`, 'success');
            } catch (error) {
                showStatus4('Error processing sheet: ' + error.message, 'error');
            }
        }

        // Add mapping button handler
        addMapping4.addEventListener('click', addMappingRow4);

        function addMappingRow4() {
            const rowIndex = columnMappings4.length;
            const mappingId = 'mapping_' + Date.now() + '_' + rowIndex;

            columnMappings4.push({ excelCol: 0, sheetsCol: 'A' });

            const row = document.createElement('div');
            row.className = 'mapping-row';
            row.id = mappingId;

            // Build options using DOM to properly escape text
            const selectEl = document.createElement('select');
            selectEl.className = 'excel-select';
            selectEl.onchange = function () { updateMapping4(mappingId, 'excel', this.value); };

            headers4.forEach((header, index) => {
                const colLetter = getColumnLetter(index);
                const option = document.createElement('option');
                option.value = index;
                // Sanitize header: convert to string, trim, remove newlines/special chars
                let headerText = String(header || '').trim();
                headerText = headerText.replace(/[\r\n\t]+/g, ' '); // Replace newlines/tabs with space
                headerText = headerText.replace(/\s+/g, ' '); // Collapse multiple spaces
                if (!headerText) {
                    headerText = '(empty)';
                }
                option.textContent = `${colLetter}: ${headerText}`;
                selectEl.appendChild(option);
            });

            // Build the row structure using DOM manipulation
            const excelColDiv = document.createElement('div');
            excelColDiv.className = 'excel-col';
            excelColDiv.appendChild(selectEl);

            const arrowDiv = document.createElement('div');
            arrowDiv.className = 'arrow';
            arrowDiv.textContent = '‚Üí';

            const sheetsInput = document.createElement('input');
            sheetsInput.type = 'text';
            sheetsInput.className = 'column-letter-input sheets-input';
            sheetsInput.value = getColumnLetter(rowIndex);
            sheetsInput.placeholder = 'A';
            sheetsInput.maxLength = 3;
            sheetsInput.onchange = function () { updateMapping4(mappingId, 'sheets', this.value); };

            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-mapping';
            removeBtn.textContent = '‚úï';
            removeBtn.onclick = function () { removeMappingRow4(mappingId); };

            row.appendChild(excelColDiv);
            row.appendChild(arrowDiv);
            row.appendChild(sheetsInput);
            row.appendChild(removeBtn);

            mappingRows4.appendChild(row);
            columnMappings4[columnMappings4.length - 1].sheetsCol = getColumnLetter(rowIndex);
        }

        function updateMapping4(mappingId, type, value) {
            const rows = Array.from(mappingRows4.children);
            const index = rows.findIndex(r => r.id === mappingId);
            if (index !== -1) {
                if (type === 'excel') {
                    columnMappings4[index].excelCol = parseInt(value);
                } else {
                    columnMappings4[index].sheetsCol = value.toUpperCase();
                }
            }
        }

        function removeMappingRow4(mappingId) {
            const rows = Array.from(mappingRows4.children);
            const index = rows.findIndex(r => r.id === mappingId);
            if (index !== -1) {
                rows[index].remove();
                columnMappings4.splice(index, 1);
            }
        }

        function getColumnLetter(index) {
            let letter = '';
            while (index >= 0) {
                letter = String.fromCharCode((index % 26) + 65) + letter;
                index = Math.floor(index / 26) - 1;
            }
            return letter;
        }

        function columnLetterToIndex(letter) {
            let index = 0;
            for (let i = 0; i < letter.length; i++) {
                index = index * 26 + letter.charCodeAt(i) - 64;
            }
            return index - 1;
        }

        function extractSpreadsheetId(input) {
            // Handle full URLs
            const urlMatch = input.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
            if (urlMatch) {
                return urlMatch[1];
            }
            const idMatch = input.match(/[?&]id=([a-zA-Z0-9-_]+)/);
            if (idMatch) {
                return idMatch[1];
            }
            // Assume it's already an ID
            return input.trim();
        }

        // Sync button handler
        syncBtn4.addEventListener('click', syncToGoogleSheets);

        async function syncToGoogleSheets() {
            const webAppUrl = webAppUrl4.value.trim();
            const sheetsInput = sheetsUrl4.value.trim();
            const targetSheetName = sheetName4.value.trim() || 'Sheet1';

            // Robust Configuration Detection
            const isAppend = document.getElementById('modeAppend4').checked;
            const importMode = isAppend ? 'append' : 'overwrite';
            const includeHeaders = document.getElementById('includeHeaders4').checked;
            const customStartRow = startRow4.value.trim();

            if (!file4 || !sheetInfo4) {
                showStatus4('Please upload an Excel file first', 'error');
                return;
            }

            // Validation
            if (!webAppUrl) {
                showStatus4('Please enter your Google Apps Script Web App URL', 'error');
                return;
            }

            if (!webAppUrl.includes('script.google.com')) {
                showStatus4('Invalid URL. The URL should start with https://script.google.com/...', 'error');
                return;
            }

            if (!sheetsInput) {
                showStatus4('Please enter the Google Sheets URL or ID', 'error');
                return;
            }

            if (columnMappings4.length === 0) {
                showStatus4('Please add at least one column mapping', 'error');
                return;
            }

            let finalStartRow = null;
            let rowOverride = null;
            if (!isAppend && !includeHeaders && !customStartRow) {
                rowOverride = 2;
            }

            if (customStartRow) {
                const parsedStartRow = Number.parseInt(customStartRow, 10);
                if (!Number.isFinite(parsedStartRow) || parsedStartRow < 1) {
                    showStatus4('Start row must be a positive integer', 'error');
                    return;
                }
                finalStartRow = parsedStartRow;
            } else if (rowOverride) {
                finalStartRow = rowOverride;
            }

            const spreadsheetId = extractSpreadsheetId(sheetsInput);

            syncBtn4.disabled = true;
            const modeText = importMode === 'append' ? 'Appending' : 'Overwriting';
            const rowText = finalStartRow !== null ? `(starting row ${finalStartRow})` : '(auto-detect row)';

            showStatus4(`Preparing to Sync (${modeText} ${rowText})...`, 'info');
            progress4.classList.add('show');
            progressFill4.style.width = '5%';
            progressFill4.textContent = '5%';

            try {
                const totalRows = sheetInfo4.rowCount || 0;
                const totalCols = sheetInfo4.colCount || 0;
                const excelStartRow = isAppend ? 1 : (includeHeaders ? 0 : 1);
                const totalDataRows = Math.max(totalRows - excelStartRow, 0);

                if (totalDataRows === 0) {
                    showStatus4('No rows to send from the selected sheet.', 'warning');
                    progress4.classList.remove('show');
                    syncBtn4.disabled = false;
                    return;
                }

                if (totalDataRows > 5000) {
                    const proceed = confirm(
                        `‚ö†Ô∏è Large Dataset Detected (${totalDataRows} rows)\n\n` +
                        'This will be sent in batches to avoid Google Apps Script timeouts.\n\nContinue?'
                    );
                    if (!proceed) {
                        syncBtn4.disabled = false;
                        progress4.classList.remove('show');
                        return;
                    }
                }

                // Create column mapping info for the Apps Script
                const mappings = columnMappings4.map(m => ({
                    excelCol: m.excelCol,
                    sheetsCol: m.sheetsCol
                }));

                const batchSize = totalDataRows > 50000 ? 500 : 1000;
                let sentRows = 0;
                let resolvedStartRow = finalStartRow;
                let firstBatch = true;

                const sendBatch = async (batchRows) => {
                    const startRowForBatch = resolvedStartRow !== null ? resolvedStartRow + sentRows : null;
                    const modeForBatch = firstBatch ? importMode : 'append';

                    const payload = {
                        spreadsheetId: spreadsheetId,
                        sheetName: targetSheetName,
                        mode: modeForBatch,
                        startRow: startRowForBatch,
                        mappings: mappings,
                        data: batchRows
                    };

                    showStatus4(`Sending rows ${sentRows + 1}-${sentRows + batchRows.length}...`, 'info');

                    const response = await fetch(webAppUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`Server responded with ${response.status}`);
                    }

                    let responseData = null;
                    let responseText = '';
                    try {
                        responseData = await response.json();
                    } catch (error) {
                        responseText = await response.text().catch(() => '');
                    }

                    if (firstBatch && resolvedStartRow === null) {
                        if (responseData && Number.isFinite(responseData.startRowUsed)) {
                            resolvedStartRow = responseData.startRowUsed;
                        } else {
                            resolvedStartRow = 1;
                        }
                    }

                    sentRows += batchRows.length;
                    firstBatch = false;

                    const percent = Math.round((sentRows / totalDataRows) * 100);
                    progressFill4.style.width = percent + '%';
                    progressFill4.textContent = percent + '%';

                    await yieldToUI();
                };

                if (useCsv4) {
                    let rowIndex = 0;
                    let batch = [];

                    await parseCsvStream(
                        file4,
                        csvDelimiter4.value,
                        async (row) => {
                            if (rowIndex < excelStartRow) {
                                rowIndex++;
                                return;
                            }

                            batch.push(row);
                            rowIndex++;

                            if (batch.length >= batchSize) {
                                await sendBatch(batch);
                                batch = [];
                            }
                        }
                    );

                    if (batch.length > 0) {
                        await sendBatch(batch);
                    }
                } else {
                    while (sentRows < totalDataRows) {
                        const batchStartRow = excelStartRow + sentRows;
                        const batchEndRow = Math.min(totalRows - 1, batchStartRow + batchSize - 1);

                        let batchRows = [];
                        if (worker4) {
                            batchRows = await worker4.getRows(batchStartRow, batchEndRow, totalCols);
                        } else {
                            const range = { s: { r: batchStartRow, c: 0 }, e: { r: batchEndRow, c: Math.max(totalCols - 1, 0) } };
                            batchRows = XLSX.utils.sheet_to_json(worksheet4, {
                                header: 1,
                                range,
                                defval: '',
                                blankrows: true
                            });
                        }

                        if (batchRows.length === 0) {
                            throw new Error('No rows returned for this batch. Aborting to prevent an infinite loop.');
                        }

                        await sendBatch(batchRows);
                    }
                }

                showStatus4(`‚úì Data sent to Google Sheets!\n\nMode: ${modeText}\nSheet: ${targetSheetName}\nRows sent: ${sentRows}`, 'success');

                // SAVE SETTINGS TO STORAGE ON SUCCESS
                safeStorage.setItem('eve_webAppUrl', webAppUrl);
                safeStorage.setItem('eve_sheetsUrl', sheetsInput);
                safeStorage.setItem('eve_sheetName', targetSheetName);

                setTimeout(() => {
                    progress4.classList.remove('show');
                }, 2000);

            } catch (error) {
                showStatus4('Error: ' + error.message, 'error');
                progress4.classList.remove('show');
            }

            syncBtn4.disabled = false;
        }

        function showStatus4(message, type) {
            status4.textContent = message;
            status4.className = 'status show ' + type;
            status4.style.whiteSpace = 'pre-line';
        }
    </script>
</body>

</html>


