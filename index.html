<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MUNKE</title>
    <link rel="icon" type="image/png" sizes="32x32" href="images/favicon_munke.png">
    <link rel="shortcut icon" type="image/png" href="images/favicon_munke.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <style>
        :root {
            --primary: #007AFF;
            /* Apple Blue */
            --primary-dark: #0062cc;
            --secondary: #5856D6;
            /* Indigo */
            --success: #34C759;
            --bg-glass: rgba(255, 255, 255, 0.85);
            /* Slightly more transparent for blur */
            --surface-glass: rgba(255, 255, 255, 0.6);
            --text-main: #1D1D1F;
            /* Apple Black */
            --text-secondary: #86868B;
            --border-light: rgba(60, 60, 67, 0.12);
            /* Apple Separator Color */
            --shadow-lg: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
            /* Softer, deeper shadow */
            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --radius-lg: 30px;
            /* Larger, smoother rounded corners */
            --radius-md: 20px;
            --radius-sm: 12px;
            --font-stack: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --bg-solid: #F5F5F7;
            /* Apple Soft Neutral Gray */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: var(--font-stack);
        }

        html {
            scrollbar-gutter: stable;
            /* FIX: Prevents layout shift when scrollbar appears */
        }

        body {
            background-color: var(--bg-solid);
            min-height: 100vh;
            padding: 40px 20px;
            color: var(--text-main);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            position: relative;
            transition: background-color 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Layered background for smooth transitions */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('images/background.png');
            background-size: auto;
            background-position: top left;
            background-repeat: repeat;
            background-attachment: fixed;
            z-index: -1;
            transition: opacity 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 1;
        }

        body.no-bg::before {
            opacity: 0;
        }

        body.no-bg {
            background-color: var(--bg-solid);
        }

        .container {
            width: 100%;
            max-width: 950px;
            background: var(--bg-glass);
            backdrop-filter: blur(40px);
            /* Deep premium blur */
            -webkit-backdrop-filter: blur(40px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            animation: fadeIn 0.6s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header {
            padding: 40px 40px 10px 40px;
            /* More padding top */
            text-align: center;
            background: transparent;
            /* Clean header */
        }

        .header h1 {
            font-size: 36px;
            font-weight: 800;
            margin-bottom: 8px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -1px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .header-mascot {
            height: 120px;
            /* Large premium size */
            width: auto;
            -webkit-text-fill-color: initial;
            filter: drop-shadow(0 8px 16px rgba(0, 0, 0, 0.1));
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            margin-bottom: 10px;
            /* No blend mode needed as the PNG is truly transparent */
        }

        .title-icon {
            height: 120px;
            /* Match main mascot height */
            width: auto;
            vertical-align: middle;
            margin-right: 15px;
            margin-top: -10px;
            -webkit-text-fill-color: initial;
            filter: drop-shadow(0 8px 16px rgba(0, 0, 0, 0.1));
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .header h1:hover .title-icon {
            transform: scale(1.1) rotate(-5deg);
            /* Rotates opposite to the mascot for a "blooming" effect */
        }

        .header h1:hover .header-mascot {
            transform: scale(1.1) rotate(5deg);
        }

        .bg-toggle-container {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 100;
        }

        .bg-toggle-btn {
            background: var(--surface-glass);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--border-light);
            padding: 8px 14px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-sm);
        }

        .bg-toggle-btn:hover {
            background: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .bg-toggle-btn:active {
            transform: translateY(1px) scale(0.96);
            box-shadow: var(--shadow-sm);
            background: rgba(255, 255, 255, 0.8);
        }

        .bg-toggle-btn .icon {
            width: 24px;
            height: 24px;
            object-fit: contain;
            transition: transform 0.3s ease;
        }

        /* Compensate for the extra padding in the prohibition sign image */
        .bg-toggle-btn .icon.large-scale {
            transform: scale(1.3);
        }

        .header p {
            color: var(--text-secondary);
            font-size: 16px;
            font-weight: 500;
        }

        /* iOS Style Segmented Control - REFINED & SCALED UP */
        .tabs {
            display: inline-flex;
            justify-content: center;
            background: rgba(118, 118, 128, 0.12);
            /* Standard Apple Track */
            padding: 5px;
            /* Increased padding */
            border-radius: 14px;
            /* Larger radius */
            margin: 0 auto 35px auto;
            position: relative;
            border-bottom: none;
            width: fit-content;
            /* Allow to grow */
            min-width: 60%;
            /* Ensure it takes up space like a main nav */
            left: 50%;
            transform: translateX(-50%);
            box-shadow: inset 0 0 2px rgba(0, 0, 0, 0.05);
        }

        .tab {
            padding: 12px 24px;
            /* Substantial padding */
            cursor: pointer;
            font-weight: 500;
            color: var(--text-main);
            border-radius: 11px;
            /* Matches track radius minus padding */
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 16px;
            /* Larger text for "Application Section" feel */
            border: none;
            background: transparent;
            margin: 0;
            text-align: center;
            min-width: unset;
            flex: 1;
            /* Distribute space */
            white-space: nowrap;
            display: flex;
            /* Centering */
            align-items: center;
            justify-content: center;
            gap: 8px;
            /* Gap for icon if present (it is in HTML text) */
        }

        .tab:hover {
            opacity: 1;
            /* Reset opacity */
            color: var(--primary);
            background: rgba(255, 255, 255, 0.5);
            /* Subtle hover bg */
            transform: none;
            box-shadow: none;
        }

        .tab.active {
            background: white;
            color: black;
            font-weight: 700;
            /* Bold active */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12), 0 2px 4px rgba(0, 0, 0, 0.05);
            /* Stronger shadow */
            transform: scale(1.02);
            /* Slight pop */
        }

        .content {
            padding: 40px;
            background: white;
            /* Inner content solid or very opaque */
        }

        .tab-content {
            display: none;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .tab-content.active {
            display: block;
        }

        /* Upload Area */
        .upload-area {
            border: 2px dashed #cbd5e1;
            border-radius: var(--radius-md);
            padding: 40px 50px 30px 50px;
            /* FIX: Reduced bottom padding to balance */
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s ease;
            cursor: pointer;
            background: #f8fafc;
        }

        .upload-area:hover {
            border-color: var(--primary);
            background: #eef2ff;
            transform: scale(1.01);
        }

        .upload-area.dragover {
            border-color: var(--primary);
            background: #e0e7ff;
        }

        .upload-icon {
            font-size: 42px;
            /* Slightly smaller, more elegant */
            margin-bottom: 15px;
            display: block;
            filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.1));
        }

        input[type="file"] {
            display: none;
        }

        /* Modern Inputs */
        label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-main);
            font-weight: 600;
            font-size: 14px;
            letter-spacing: -0.3px;
        }

        select,
        input[type="text"],
        input[type="email"],
        textarea {
            width: 100%;
            padding: 16px;
            border: 1px solid transparent;
            /* No border initially, handled by bg */
            background: rgba(118, 118, 128, 0.08);
            /* Apple-like filled input */
            border-radius: var(--radius-sm);
            font-size: 16px;
            /* Prevents zoom on iOS, good read on desktop */
            margin-bottom: 20px;
            font-family: inherit;
            transition: all 0.2s;
            color: var(--text-main);
            outline: none;
        }

        select:focus,
        input[type="text"]:focus,
        input[type="email"]:focus,
        textarea:focus {
            background: white;
            /* White on focus */
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.2);
            /* Soft blue glow */
            border-color: var(--primary);
        }

        textarea {
            min-height: 120px;
            resize: vertical;
        }

        /* Buttons */
        /* Buttons - Premium Apple Style */
        .btn {
            background: var(--primary);
            /* Flat Apple Blue */
            color: white;
            border: none;
            padding: 16px 30px;
            /* Larger touch target */
            border-radius: 14px;
            /* Slightly softer than standard, "Continuous Curve" feel */
            font-size: 17px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 600;
            width: 100%;
            margin-bottom: 12px;
            letter-spacing: -0.4px;
            /* Tighter letter spacing like OS */
            box-shadow: 0 4px 6px rgba(0, 122, 255, 0.2);
        }

        .btn:hover:not(:disabled) {
            transform: scale(1.02);
            /* Subtle scale for "airy" feel, stable */
            background: var(--primary-dark);
            box-shadow: 0 10px 20px rgba(0, 122, 255, 0.2);
            /* Deeper, softer shadow */
        }

        .btn:active:not(:disabled) {
            transform: scale(0.98);
            /* Satisfying click press */
            box-shadow: 0 2px 4px rgba(0, 122, 255, 0.2);
        }

        .btn:disabled {
            background: #94a3b8;
            cursor: not-allowed;
            opacity: 0.7;
            transform: none !important;
            box-shadow: none !important;
        }

        .btn.secondary {
            background: #64748b;
        }

        .btn.secondary:hover:not(:disabled) {
            background: #475569;
            box-shadow: 0 10px 20px rgba(100, 116, 139, 0.25);
        }

        .btn.success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .btn.success:hover:not(:disabled) {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            /* Consistent gradient shift */
            box-shadow: 0 10px 20px rgba(16, 185, 129, 0.3);
        }

        /* Sections & Status */
        .section {
            background: #f8fafc;
            padding: 25px;
            border-radius: var(--radius-md);
            margin-bottom: 25px;
            border: 1px solid #f1f5f9;
        }

        .section-title {
            font-weight: 700;
            color: var(--text-main);
            margin-bottom: 20px;
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status {
            padding: 16px;
            border-radius: var(--radius-sm);
            margin-top: 25px;
            display: none;
            font-size: 14px;
            line-height: 1.5;
            animation: fadeIn 0.3s;
        }

        .status.show {
            display: block;
        }

        .status.success {
            background: #ecfdf5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .status.error {
            background: #fef2f2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .status.info {
            background: #eff6ff;
            color: #1e40af;
            border: 1px solid #bfdbfe;
        }

        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 10px;
            background: #e2e8f0;
            border-radius: 20px;
            overflow: hidden;
            margin-top: 20px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            width: 0%;
            transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 20px;
        }

        .progress-text {
            text-align: right;
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        /* File Info Cards */
        .file-info {
            background: white;
            padding: 20px;
            border-radius: var(--radius-md);
            margin-bottom: 25px;
            display: none;
            box-shadow: var(--shadow-sm);
            border: 1px solid #e2e8f0;
        }

        .file-info.show {
            display: block;
        }

        .file-list {
            max-height: 200px;
            overflow-y: auto;
            background: #f8fafc;
            padding: 10px;
            border-radius: var(--radius-sm);
            margin-top: 15px;
            border: 1px solid #e2e8f0;
        }

        .file-item {
            padding: 8px 12px;
            font-size: 13px;
            color: var(--text-main);
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .file-item:last-child {
            border-bottom: none;
        }

        /* Knowledge Base */
        /* Knowledge Base - IOS List Style */
        .kb-topic {
            background: rgba(255, 255, 255, 0.7);
            /* Translucent */
            border: none;
            /* Remove border for cleaner look */
            border-bottom: 1px solid var(--border-light);
            /* Separator line */
            border-radius: 0;
            /* List style */
            margin-bottom: 0;
            overflow: hidden;
            transition: background 0.2s;
        }

        .kb-topic:first-child {
            border-top-left-radius: var(--radius-md);
            border-top-right-radius: var(--radius-md);
        }

        .kb-topic:last-child {
            border-bottom-left-radius: var(--radius-md);
            border-bottom-right-radius: var(--radius-md);
            border-bottom: none;
        }

        .kb-topic:hover {
            background: rgba(255, 255, 255, 0.9);
            border-color: transparent;
            /* No border change */
            box-shadow: none;
            cursor: pointer;
            /* FIX: Visual feedback */
        }

        .kb-topic-header {
            padding: 18px 25px;
        }

        .kb-topic-title {
            color: var(--text-main);
            font-weight: 500;
            font-size: 16px;
        }

        /* FIX: Modern Chevron Integration */
        .kb-topic-header {
            position: relative;
        }

        .kb-topic-header::after {
            content: '';
            position: absolute;
            right: 25px;
            top: 50%;
            width: 8px;
            height: 8px;
            border-right: 2px solid #cbd5e1;
            /* border-light */
            border-bottom: 2px solid #cbd5e1;
            transform: translateY(-50%) rotate(-45deg);
            /* Point left/neutral initially? or Down? Let's say closed = right? */
            /* Current arrow was right arrow ‚ñ∂. Let's make it a chevron pointing right. */
            /* Rotate -45deg makes it point Right if borders are right/bottom */
            transition: transform 0.3s ease;
        }

        .kb-topic.open .kb-topic-header::after {
            transform: translateY(-50%) rotate(45deg);
            /* Point Down */
            border-color: var(--primary);
        }

        /* FIX: Restore KB Content Animation */
        .kb-topic-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out;
            background: white;
        }

        .kb-topic.open .kb-topic-content {
            max-height: 5000px;
            /* arbitrary large value to allow full expansion */
            transition: max-height 0.5s ease-in;
        }

        /* --- MISSING STYLES RESTORED & FIXED --- */

        /* 1. Add Mapping Button */
        .add-mapping-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-weight: 600;
            margin-top: 10px;
            transition: all 0.3s;
            font-size: 14px;
            display: inline-block;
            box-shadow: 0 4px 6px rgba(16, 185, 129, 0.2);
        }

        .add-mapping-btn:hover {
            box-shadow: 0 8px 12px rgba(16, 185, 129, 0.3);
            transform: translateY(-2px);
        }

        /* 2. Fix Progress Bar Text Visibility */
        .progress-bar {
            height: 24px;
            /* Increased height to fit text */
            background: #e2e8f0;
            border-radius: 12px;
            overflow: hidden;
            margin-top: 20px;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            width: 0%;
            transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            color: white;
            font-size: 13px;
            display: flex;
            /* Restored flex to center text */
            align-items: center;
            justify-content: center;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        /* 3. Knowledge Base Content Styles */
        .kb-topic-body {
            padding: 20px;
            color: var(--text-secondary);
            line-height: 1.6;
            border-top: 1px solid #f1f5f9;
            background: #fafbfc;
        }

        .kb-topic-body h3 {
            color: var(--primary);
            margin-top: 10px;
            margin-bottom: 12px;
            font-size: 16px;
            font-weight: 700;
        }

        .kb-topic-body ul,
        .kb-topic-body ol {
            margin-left: 20px;
            margin-bottom: 15px;
        }

        .kb-topic-body li {
            margin-bottom: 6px;
        }

        .kb-topic-body code {
            background: rgba(99, 102, 241, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            color: var(--primary-dark);
            font-family: 'Consolas', monospace;
            font-size: 13px;
            border: 1px solid rgba(99, 102, 241, 0.1);
        }

        .kb-topic-arrow {
            transition: transform 0.3s;
            font-size: 14px;
            opacity: 0.5;
            margin-right: 10px;
        }

        .kb-topic.open .kb-topic-arrow {
            transform: rotate(90deg);
        }

        /* 4. Column Mapping & General Layout Fixes */
        .column-mapping-container {
            background: rgba(255, 255, 255, 0.5);
            /* translucent */
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            padding: 20px;
            margin-top: 15px;
        }

        /* GRID LAYOUT FOR MAPPING */
        .mapping-header,
        .mapping-row {
            display: grid;
            grid-template-columns: 3fr 30px 100px 40px;
            /* Excel | Arrow | Sheet Col | Trash */
            gap: 12px;
            align-items: center;
        }

        .mapping-header {
            margin-bottom: 15px;
            padding: 0 10px;
            /* Align with row padding */
        }

        .mapping-header span {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            font-weight: 700;
        }

        .mapping-row {
            padding: 10px;
            background: white;
            border-radius: var(--radius-sm);
            margin-bottom: 10px;
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow-sm);
            transition: all 0.2s ease;
        }

        .mapping-row:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        /* Inputs in Row */
        .mapping-row .excel-col {
            /* Now handled by grid */
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--text-main);
        }

        /* Arrow */
        .mapping-row .arrow {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.04);
            color: var(--text-secondary);
            font-size: 14px;
            margin: 0 auto;
            /* Center in grid cell */
            font-family: system-ui, -apple-system, sans-serif;
            /* Ensure clean arrow rendering */
            line-height: 1;
            padding-bottom: 2px;
            /* Visual Optical adjustment for arrow text */
        }

        /* Excel Dropdown - Match Sheets Input */
        .mapping-row select.excel-select {
            width: 100%;
            padding: 8px;
            margin-bottom: 0;
            font-size: 14px;
            border: 1px solid var(--border-light);
            border-radius: 6px;
            /* Match standard inputs or smaller radius */
            background-color: #fff;
            color: var(--text-main);
        }

        .mapping-row select.excel-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.15);
            outline: none;
        }

        /* Sheets Input */
        .mapping-row .sheets-input {
            width: 100%;
            /* Fill grid cell */
            text-align: center;
            padding: 8px;
            font-weight: 600;
            color: var(--primary);
            background: rgba(0, 122, 255, 0.05);
            border: 1px solid rgba(0, 122, 255, 0.1);
            margin-bottom: 0;
            /* Override generic input margin */
            text-transform: uppercase;
        }

        .mapping-row .sheets-input:focus {
            background: white;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.15);
        }


        /* Remove Button refined */
        .mapping-row .remove-mapping {
            background: rgba(239, 68, 68, 0.1);
            /* Soft red bg */
            color: #ef4444;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            /* Circle */
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: auto;
            /* Push to end if in flex, but in grid it's fixed col */
        }

        .mapping-row .remove-mapping:hover {
            background: #ef4444;
            color: white;
            transform: scale(1.1);
        }

        .mapping-row .remove-mapping:active {
            transform: scale(0.9);
        }

        /* 5. Help/Instructions Styling */
        .info-box ul {
            margin-left: 20px;
            margin-top: 10px;
        }

        .info-box li {
            margin-bottom: 5px;
        }

        /* Import Mode Card Styles */
        /* Import Mode Card Styles - Overhaul */
        .mode-selection-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            /* Tighter gap */
            margin-bottom: 15px;
        }

        .mode-card {
            background: rgba(255, 255, 255, 0.6);
            /* Translucent base */
            border: 2px solid transparent;
            /* Hidden border by default */
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            /* Vertically center icon and text block */
            gap: 12px;
            position: relative;
        }

        .mode-card:hover {
            background: rgba(255, 255, 255, 0.9);
            transform: scale(1.02);
        }

        .mode-card.selected {
            border-color: var(--primary);
            /* Focused border */
            background: white;
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.15);
            /* Soft blue shadow */
        }

        .mode-card input[type="radio"] {
            display: none;
        }

        .mode-icon {
            font-size: 22px;
            background: var(--primary);
            /* Primary bg for icon area? Or keep gray? Apple uses color icons often. */
            color: white;
            /* Let's try white on blue for pop */
            width: 40px;
            height: 40px;
            border-radius: 10px;
            /* Squircle */
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            /* Don't shrink icon */
        }

        /* Alternate icon color for overwrite? */
        .mode-card:nth-child(2) .mode-icon {
            background: var(--secondary);
            /* Differentiate overwrite */
        }

        .mode-details {
            display: flex;
            flex-direction: column;
            justify-content: center;
            /* Center text vertically */
            text-align: left;
            /* Ensure left align */
            flex: 1;
            /* Fill available space */
            height: 100%;
            /* Force height */
        }

        .mode-title {
            font-weight: 600;
            color: var(--text-main);
            font-size: 15px;
            line-height: 1.2;
            margin-bottom: 2px;
        }

        .mode-desc {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 400;
            line-height: 1.3;
        }

        /* Compact Upload Area for Tab 4 */
        /* We can target by ID or new class. Let's add a class in HTML below */
        .upload-area.compact {
            padding: 15px 20px;
            min-height: auto;
            display: flex;
            /* Horizontal Layout */
            flex-direction: row;
            align-items: center;
            justify-content: flex-start;
            gap: 15px;
            text-align: left;
        }

        .upload-area.compact .upload-icon {
            font-size: 24px;
            margin-bottom: 0;
        }

        .upload-area.compact p {
            margin: 0 !important;
        }

        /* Specific Sync Tab Spacing Tweak */
        #gsync .section {
            padding: 20px;
            margin-bottom: 15px;
            /* Tighter vertical spacing */
        }

        /* Integrated Start Row Input */
        .integrated-input-wrapper {
            margin-top: 10px;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
            padding-top: 10px;
            width: 100%;
        }

        .integrated-input-wrapper label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .integrated-input-wrapper input {
            padding: 8px 12px;
            font-size: 13px;
            margin-bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid #e2e8f0;
        }

        .mode-card.selected .mode-icon {
            background: white;
            color: var(--primary);
        }

        .mode-details {
            display: flex;
            flex-direction: column;
        }

        .mode-title {
            font-weight: 700;
            color: var(--text-main);
            font-size: 16px;
        }

        .mode-desc {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        /* Removed legacy flex rules */

        button,
        input,
        select,
        textarea {
            font-family: inherit;
        }
    </style>
</head>

<body>
    <div class="container" style="position: relative;">
        <div class="bg-toggle-container">
            <button class="bg-toggle-btn" id="bgToggle" title="Toggle Background">
                <img src="images/no_monkey_icon.png" alt="Toggle" class="icon large-scale">
                <span class="text">Hide monkeys!</span>
            </button>
        </div>
        <div class="header">
            <h1>
                <span><img src="images/leftie_removed_bg.png" alt="Icon" class="title-icon">Evelinos Suite v4</span>
                <img src="images/clean_monkey-removebg-preview.png" alt="Mascot" class="header-mascot">
            </h1>
            <p>Split Excel files by criteria and generate email drafts</p>
        </div>

        <div class="tabs">
            <div class="tab active" data-tab="splitter">
                üîÄ Split by Criteria
            </div>
            <div class="tab" data-tab="emailer">
                üìß Generate Emails
            </div>
            <div class="tab" data-tab="gsync">
                üîÑ Sheets Sync
            </div>
            <div class="tab" data-tab="knowledge">
                üìö Knowledge Base
            </div>
        </div>

        <div class="content">
            <!-- Tab 1: Excel Splitter -->
            <div class="tab-content active" id="splitter">
                <div class="info-box">
                    <strong>Step 1:</strong> Upload your Excel file and split it based on unique values in any column
                </div>

                <div class="upload-area" id="uploadArea1">
                    <div class="upload-icon">üìÇ</div>
                    <p style="margin-bottom: 10px; color: #666;"><strong>Click to upload</strong> or drag and drop</p>
                    <p style="font-size: 14px; color: #999;">Excel files (.xlsx) only</p>
                    <input type="file" id="fileInput1" accept=".xlsx">
                </div>

                <div class="file-info" id="fileInfo1">
                    <div class="file-name" id="fileName1"></div>
                    <div class="file-details" id="fileDetails1"></div>
                </div>

                <div class="section hidden" id="sheetSelector1Container">
                    <div class="section-title">üìë Select Excel Sheet</div>
                    <label for="excelSheetSelect1">Choose the worksheet to split:</label>
                    <select id="excelSheetSelect1">
                        <!-- Options populated by JS -->
                    </select>
                </div>

                <div class="section hidden" id="columnSection1">
                    <label for="splitColumn1">Select the column to split by (each unique value will create a separate
                        file):</label>
                    <select id="splitColumn1">
                        <option value="">-- Select a column --</option>
                    </select>
                </div>

                <div class="section hidden" id="outputSection1">
                    <label>üìÇ Output Location:</label>
                    <p style="font-size: 14px; color: #666; margin-bottom: 10px;">Choose where to save the split files
                    </p>
                    <button class="btn secondary" id="selectFolder1">Select Output Folder</button>
                    <div class="folder-info" id="folderName1"></div>
                </div>

                <div class="hidden" id="buttonGroup1">
                    <button class="btn" id="processFolder1" style="display:none;">Save to Selected Folder</button>
                    <button class="btn secondary" id="processZip1" style="display:none;">Download as ZIP File</button>
                </div>

                <div class="progress" id="progress1">
                    <p style="margin-bottom: 10px; color: #666;">Processing files...</p>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill1">0%</div>
                    </div>
                </div>

                <div class="status" id="status1"></div>

                <div class="note">
                    <strong>üí° Next Step:</strong> After splitting, switch to the "Generate Emails" tab to create email
                    drafts for each file.
                </div>
            </div>

            <!-- Tab 2: Email Generator -->
            <div class="tab-content" id="emailer">
                <div class="info-box">
                    <strong>Step 2:</strong> Generate Outlook email files from your split Excel files
                </div>

                <div class="section">
                    <div class="section-title">üìÅ Select Excel Files Folder</div>
                    <button class="btn" id="selectInput2">Select Folder with Excel Files</button>
                    <!-- Fallback file input -->
                    <input type="file" id="fallbackInput2" multiple accept=".xlsx" style="display: none;">
                    <div class="folder-info" id="inputFolder2"></div>
                    <div class="file-list" id="fileList2"></div>
                </div>

                <div class="section hidden" id="emailConfig2">
                    <div class="section-title">‚úâÔ∏è Configure Email Template</div>

                    <label for="emailSubject2">Subject Line:</label>
                    <input type="text" id="emailSubject2" placeholder="e.g., Company Report - {{filename}}"
                        value="Company Report - {{filename}}">

                    <label for="emailBody2">Email Body:</label>
                    <textarea id="emailBody2" placeholder="Enter your email message here...">Dear Team,

Please find the attached report.

Best regards</textarea>

                    <label for="ccEmail2">CC (optional):</label>
                    <input type="email" id="ccEmail2" placeholder="cc@example.com">

                    <div class="hidden" id="columnSection2">
                        <label for="emailColumn2">Select Column with Email Addresses:</label>
                        <select id="emailColumn2">
                            <option value="">-- Select a column --</option>
                        </select>
                    </div>
                </div>

                <div class="section hidden" id="outputSection2">
                    <div class="section-title">üíæ Select Output Folder</div>
                    <button class="btn secondary" id="selectOutput2">Select Output Folder for Email Files</button>
                    <div class="folder-info" id="outputFolder2"></div>
                </div>

                <button class="btn success hidden" id="generate2">Generate Email Files</button>

                <div class="progress" id="progress2">
                    <p style="margin-bottom: 10px; color: #666;">Creating email files...</p>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill2">0%</div>
                    </div>
                </div>

                <div class="status" id="status2"></div>

                <div class="note">
                    <strong>üí° Tips:</strong><br>
                    ‚Ä¢ Use {{filename}} in subject to include the Excel filename<br>
                    ‚Ä¢ Email files (.eml) will open in Outlook when double-clicked<br>
                    ‚Ä¢ All recipients from the Excel file will be in the "To:" field
                </div>
            </div>

            <!-- Tab 3: Google Sheets Sync -->
            <div class="tab-content" id="gsync">
                <div class="info-box">
                    <strong>üîÑ Excel to Google Sheets Sync:</strong> Import specific columns from Excel to your Google
                    Sheet with custom column mapping
                </div>

                <!-- Web App URL Section -->
                <div class="section"
                    style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 20px; border-radius: 8px;">
                    <div class="section-title" style="color: white;">‚öôÔ∏è Google Apps Script Web App URL</div>
                    <p style="margin-bottom: 15px; opacity: 0.95; font-size: 14px; line-height: 1.5;">
                        This app uses a simple Google Apps Script to write to your sheets.
                        <strong style="color: white;">Need Setup Help?</strong>
                        <span style="text-decoration: underline; cursor: pointer; font-weight: 600;"
                            onclick="document.querySelector('.tab[data-tab=\'knowledge\']').click()">Check the Knowledge
                            Base</span>
                        for the "Google Sheets Sync ‚Äî Complete Setup Guide".
                    </p>
                    <input type="text" id="webAppUrl4" placeholder="Paste your Google Apps Script Web App URL here"
                        style="width: 100%; padding: 12px; border-radius: 6px; border: none; font-size: 14px;">
                    <p style="font-size: 12px; margin-top: 8px; opacity: 0.9;">
                        The URL looks like: <code
                            style="background: rgba(255,255,255,0.25); padding: 4px 8px; border-radius: 4px; font-family: 'Consolas', monospace; user-select: all;">https://script.google.com/macros/s/AKfycbwLdXzVaj.../exec</code>
                    </p>
                </div>

                <!-- Google Sheets Configuration -->
                <div class="section">
                    <div class="section-title">üìä Google Sheets Configuration</div>

                    <label for="sheetsUrl4">Google Sheets URL or ID:</label>
                    <input type="text" id="sheetsUrl4"
                        placeholder="Paste the full Google Sheets URL or just the spreadsheet ID">

                    <label for="sheetName4">Sheet Name (tab name within the spreadsheet):</label>
                    <input type="text" id="sheetName4" placeholder="e.g., My Data, Sheet1, Import Data" value="Sheet1">
                </div>

                <!-- Excel File Upload (Compact) -->
                <div class="section">
                    <div class="upload-area compact" id="uploadArea4">
                        <div class="upload-icon">üìÇ</div>
                        <div style="flex-grow: 1;">
                            <p style="color: #334155; font-weight: 500;"><strong>Click to upload Excel file</strong></p>
                            <p style="font-size: 13px; color: #64748b;">.xlsx files only</p>
                        </div>
                        <input type="file" id="fileInput4" accept=".xlsx">
                    </div>

                    <div class="file-info" id="fileInfo4" style="margin-top: 10px; margin-bottom: 0;">
                        <div class="file-name" id="fileName4"></div>
                        <div class="file-details" id="fileDetails4"></div>
                    </div>

                    <div id="sheetSelector4Container" class="hidden"
                        style="margin-top: 15px; border-top: 1px dashed var(--border-light); padding-top: 15px;">
                        <label for="excelSheetSelect4"
                            style="font-weight: 600; font-size: 14px; margin-bottom: 8px; display: block;">üìë Select
                            Excel Sheet</label>
                        <select id="excelSheetSelect4"
                            style="width: 100%; padding: 10px; font-size: 14px; margin-bottom: 0;">
                            <!-- Options populated by JS -->
                        </select>
                        <p style="font-size: 11px; color: var(--text-secondary); margin-top: 5px;">Choose the sheet from
                            your workbook that contains the data you wish to sync.</p>
                    </div>
                </div>

                <!-- Sync Mode & Options -->
                <div class="section hidden" id="modeSection4">
                    <div class="section-title">‚úèÔ∏è Import Configuration</div>

                    <div class="mode-selection-grid" style="margin-bottom: 20px;">
                        <label class="mode-card selected">
                            <input type="radio" name="importMode4" id="modeAppend4" value="append" checked>
                            <div class="mode-icon">‚ûï</div>
                            <div class="mode-details">
                                <span class="mode-title">Append</span>
                                <span class="mode-desc">Add after existing data</span>
                            </div>
                        </label>

                        <label class="mode-card">
                            <input type="radio" name="importMode4" id="modeOverwrite4" value="overwrite">
                            <div class="mode-icon">üîÑ</div>
                            <div class="mode-details">
                                <span class="mode-title">Overwrite</span>
                                <span class="mode-desc">Replace existing data</span>
                            </div>
                        </label>
                    </div>

                    <div
                        style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; background: rgba(0,0,0,0.02); padding: 15px; border-radius: 12px; border: 1px solid var(--border-light);">
                        <div>
                            <label for="startRow4"
                                style="font-weight: 600; font-size: 14px; margin-bottom: 8px; display: block;">üìç Start
                                Row (Optional)</label>
                            <input type="number" id="startRow4" placeholder="Auto-detect" min="1"
                                style="margin-bottom: 0; padding: 10px;">
                            <p style="font-size: 11px; color: var(--text-secondary); margin-top: 5px;">Leave empty to
                                append at bottom or overwrite from top.</p>
                        </div>
                        <div style="display: flex; flex-direction: column; justify-content: flex-start;">
                            <label style="font-weight: 600; font-size: 14px; margin-bottom: 12px; display: block;">üìÑ
                                Data Handling</label>
                            <label
                                style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 14px;">
                                <input type="checkbox" id="includeHeaders4" checked
                                    style="width: 18px; height: 18px; margin: 0;">
                                Include Excel Headers?
                            </label>
                            <p style="font-size: 11px; color: var(--text-secondary); margin-top: 5px;">Uncheck to sync
                                data only (skips row 1 of Excel).</p>
                        </div>
                    </div>
                </div>

                <!-- Column Mapping -->
                <div class="section hidden" id="mappingSection4">
                    <div class="section-title">üîó Column Mapping</div>
                    <p style="color: #666; margin-bottom: 15px;">Map Excel columns to Google Sheets columns. Use column
                        letters (A, B, C...) for Google Sheets destination.</p>

                    <div class="column-mapping-container">
                        <div class="mapping-header">
                            <span>üìó Excel Column</span>
                            <span></span>
                            <span>üìä Google Sheets Column</span>
                            <span></span>
                        </div>
                        <div id="mappingRows4">
                            <!-- Mapping rows will be added here -->
                        </div>
                        <button class="add-mapping-btn" id="addMapping4">+ Add Column Mapping</button>
                    </div>
                </div>

                <!-- Sync Button -->
                <button class="btn success hidden" id="syncBtn4">üöÄ Sync to Google Sheets</button>

                <div class="progress" id="progress4">
                    <p style="margin-bottom: 10px; color: #666;">Syncing data...</p>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill4">0%</div>
                    </div>
                </div>

                <div class="status" id="status4"></div>

                <div class="note">
                    <strong>üí° Need Setup Help?</strong> check the <strong>Knowledge Base</strong> (Tab 4) for the
                    "Google Sheets Sync ‚Äî Complete Setup Guide".
                </div>
            </div>

            <!-- Tab 4: Knowledge Base -->
            <div class="tab-content" id="knowledge">
                <div class="info-box">
                    <strong>üìö Knowledge Base:</strong> Browse guides and documentation for using this app
                </div>

                <div class="kb-search">
                    <input type="text" id="kbSearch" placeholder="üîç Search topics...">
                </div>

                <div id="kbTopics">
                    <!-- Topics will be generated here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============= KNOWLEDGE BASE DATA =============
        // To add a new topic, simply copy one of the objects below and modify it
        const knowledgeBaseTopics = [
            {
                icon: "‚úÇÔ∏è",
                title: "Excel Splitter ‚Äî User Guide",
                content: `
                    <h3>üìã Overview</h3>
                    <p>The <strong>Excel Splitter</strong> (Tab 1) takes a large "Master File" and breaks it into smaller, separate Excel files based on a column you choose (e.g., splitting a Sales Report by "Manager" or "Region").</p>

                    <h3>üìù Step-by-Step Instructions</h3>
                    <ol>
                        <li><strong>Select Master File:</strong> Click the folder icon to choose your main Excel file.</li>
                        <li><strong>Choose Split Column:</strong> The app will read your headers. Select the specific column you want to group by (e.g., "Department").
                            <ul>
                                <li><em>Example:</em> If you choose "Department", you will get files like <code>Department_HR.xlsx</code>, <code>Department_IT.xlsx</code>.</li>
                            </ul>
                        </li>
                        <li><strong>Select Output Folder:</strong> Click to choose where to save the new files.
                            <ul>
                                <li><em>Note:</em> Using the Folder Picker requires permission. If your computer blocks it, the app may default to a generic download or ZIP mode.</li>
                            </ul>
                        </li>
                        <li><strong>Generate:</strong> Click <strong>Split Files</strong>. The progress bar will show the status.</li>
                    </ol>

                    <h3>üí° Pro Tips</h3>
                    <ul>
                        <li><strong>Formatted Tables:</strong> The app tries to preserve your original table styles and headers.</li>
                        <li><strong>Large Files:</strong> For very large files, give the app a moment to process. It handles thousands of rows in seconds.</li>
                    </ul>
                `
            },
            {
                icon: "üìß",
                title: "Excel Emailer ‚Äî User Guide",
                content: `
                    <h3>üìã Overview</h3>
                    <p>The <strong>Excel Emailer</strong> (Tab 2) generates ready-to-send Outlook email files (<code>.eml</code>) for each Excel file in a folder. It's perfect for distributing the split reports you just created!</p>

                    <h3>üìù Step-by-Step Instructions</h3>
                    <ol>
                        <li><strong>Select Input Files:</strong>
                            <ul>
                                <li><strong>Option A (Folder):</strong> Click "Select Input Folder" to load all Excel files from a directory.</li>
                                <li><strong>Option B (Legacy/Files):</strong> Use the "Or select individual files" option if you can't select a folder (common on work PCs).</li>
                            </ul>
                        </li>
                        <li><strong>Choose Email Column:</strong> Select the column inside your Excel files that contains the recipient's email address.
                            <ul>
                                <li>The app looks inside <em>each file</em> to find who to send it to.</li>
                            </ul>
                        </li>
                        <li><strong>Configure Template:</b>
                            <ul>
                                <li><strong>Subject:</strong> Enter your email subject line. Use <code>{{filename}}</code> to automatically insert the file's name.</li>
                                <li><strong>Body:</strong> Type your message.</li>
                                <li><strong>CC:</strong> Optional. Add a CC address for all emails.</li>
                            </ul>
                        </li>
                        <li><strong>Select Output:</strong> Choose a folder to save drafts.
                            <ul>
                                <li><strong>‚ö†Ô∏è Fallback Mode:</strong> If you don't select a folder (or can't), the app will automatically zip all emails into a <code>generated_emails.zip</code> file for you to download.</li>
                            </ul>
                        </li>
                        <li><strong>Generate:</strong> Click <strong>Generate Emails</strong>.</li>
                    </ol>

                    <h3>üí° Key Features</h3>
                    <ul>
                        <li><strong>Attachments:</strong> The Excel file itself is automatically attached to the email.</li>
                        <li><strong>Multiple Recipients:</strong> If a file contains multiple unique email addresses in the column, the email will be sent to all of them.</li>
                    </ul>
                `
            },
            {
                icon: "‚ö°",
                title: "Ultimate Excel Power Query Guide ‚Äî Fully Detailed & Commercial Ready",
                content: `
                    <h3>1Ô∏è‚É£ Open a new workbook</h3>
                    <ol>
                        <li>Open <strong>Excel</strong></li>
                        <li>Click <strong>Blank Workbook</strong></li>
                    </ol>
                    
                    <h3>2Ô∏è‚É£ Load all files from a folder</h3>
                    <ol>
                        <li>Top menu ‚Üí <strong>Data</strong> tab</li>
                        <li>Click <strong>Get Data ‚Üí From File ‚Üí From Folder</strong></li>
                        <li>In the popup ‚Üí <strong>Browse</strong>, select your folder ‚Üí <strong>OK</strong></li>
                        <li>Folder dialog shows all files ‚Üí click <strong>Combine ‚Üí Combine & Transform Data</strong></li>
                        <li>Power Query Editor opens automatically</li>
                    </ol>
                    <p><em>You now have your "sample file" and the "combined query" (<code>Export</code>) in the left panel.</em></p>
                    
                    <h3>3Ô∏è‚É£ Stop automatic type guessing</h3>
                    <ol>
                        <li>Left panel ‚Üí click <strong>Export</strong> (final combined query)</li>
                        <li>Right panel ‚Üí <strong>Applied Steps ‚Üí find "Changed Type" ‚Üí click ‚ùå</strong></li>
                    </ol>
                    <p><em>This prevents decimals from being corrupted (e.g., <code>0,1</code> ‚Üí <code>1</code>).</em></p>
                    
                    <h3>4Ô∏è‚É£ Fix decimal numbers (optional)</h3>
                    <ol>
                        <li>Click the header of columns you want to fix (e.g., <code>m</code> and <code>n</code>)</li>
                        <li>Top menu ‚Üí <strong>Transform tab ‚Üí Replace Values</strong>
                            <ul>
                                <li>Value to Find: <code>,</code></li>
                                <li>Replace With: <code>.</code></li>
                                <li>Click <strong>OK</strong></li>
                            </ul>
                        </li>
                        <li>With the same columns selected ‚Üí <strong>Transform tab ‚Üí Data Type ‚Üí Decimal Number</strong></li>
                    </ol>
                    <p><em>Numbers like <code>0,1</code> ‚Üí <code>0.1</code> and <code>0,13</code> ‚Üí <code>0.13</code>.</em></p>
                    
                    <h3>5Ô∏è‚É£ Add calculated/validation columns</h3>
                    <p><strong>A) Check if N &lt; M</strong></p>
                    <ol>
                        <li>Top menu ‚Üí <strong>Add Column tab ‚Üí Custom Column</strong></li>
                        <li>Popup opens:
                            <ul>
                                <li><strong>New column name:</strong> <code>Check_N_lt_M</code></li>
                                <li><strong>Custom column formula:</strong><br>
                                <code>if [N] = null or [M] = null then "Missing" else if [N] &lt; [M] then "Yes" else "No"</code></li>
                            </ul>
                        </li>
                        <li>Click <strong>OK</strong></li>
                        <li>Drag column <strong>after N</strong> (or right-click ‚Üí Move ‚Üí Left/Right)</li>
                    </ol>
                    
                    <p><strong>B) Sum of E + F</strong></p>
                    <ol>
                        <li>Add Column tab ‚Üí <strong>Custom Column</strong></li>
                        <li>Name: <code>Sum_EF</code></li>
                        <li>Formula:<br>
                        <code>(if [E] = null then 0 else [E]) + (if [F] = null then 0 else [F])</code></li>
                        <li>Click <strong>OK</strong></li>
                        <li>Drag the column <strong>after F</strong></li>
                    </ol>
                    <p><em>Formulas now handle blanks safely.</em></p>
                    
                    <h3>6Ô∏è‚É£ Grouping / Aggregation ‚Äî Average Price per Seller</h3>
                    <ol>
                        <li>Ensure your <strong>Price column</strong> is numeric: select ‚Üí <strong>Transform tab ‚Üí Data Type ‚Üí Decimal Number</strong></li>
                        <li>Select the column identifying the seller (e.g., <code>Seller</code>)</li>
                        <li>Top menu ‚Üí <strong>Transform tab ‚Üí Group By</strong></li>
                        <li>In the <strong>Group By</strong> dialog:
                            <ul>
                                <li><strong>Group by:</strong> <code>Seller</code></li>
                                <li><strong>Operation:</strong> <strong>Average</strong></li>
                                <li><strong>Column:</strong> <code>Price</code></li>
                                <li><strong>New column name:</strong> <code>AveragePrice</code></li>
                            </ul>
                        </li>
                        <li>Click <strong>OK</strong></li>
                        <li>Optional: add other aggregates like <strong>Count of Products</strong>, <strong>Max/Min Price</strong></li>
                    </ol>
                    <p><em>PQ creates one row per seller with the average price of all their products.</em></p>
                    
                    <h3>7Ô∏è‚É£ Arrange columns visually</h3>
                    <ul>
                        <li>Drag-and-drop headers in the main table to reorder</li>
                        <li>OR Home tab ‚Üí <strong>Manage Columns ‚Üí Choose Columns</strong> ‚Üí drag to reorder ‚Üí <strong>OK</strong></li>
                        <li>Formulas remain intact because PQ references <strong>column names</strong>, not positions.</li>
                    </ul>
                    
                    <h3>8Ô∏è‚É£ Load final table into Excel</h3>
                    <ol>
                        <li>Top menu ‚Üí <strong>Home tab ‚Üí Close & Load ‚Üí Close & Load To‚Ä¶</strong></li>
                        <li>Choose where to place your table (e.g., existing worksheet or new worksheet) ‚Üí <strong>OK</strong></li>
                        <li>Excel now shows:
                            <ul>
                                <li>Original columns with decimals preserved</li>
                                <li><code>Check_N_lt_M</code> after <code>N</code></li>
                                <li><code>Sum_EF</code> after <code>F</code></li>
                                <li>Optional grouped summary per seller</li>
                            </ul>
                        </li>
                    </ol>
                    
                    <h3>9Ô∏è‚É£ Set up a reusable "template" query</h3>
                    <ol>
                        <li>Keep this workbook saved as a template</li>
                        <li>Optional: rename query ‚Üí <code>Combined_Files_Template</code></li>
                        <li>When adding new files:
                            <ul>
                                <li>Save new Excel files <strong>in the same folder</strong></li>
                                <li>Open template workbook ‚Üí click anywhere in the table ‚Üí <strong>Right-click ‚Üí Refresh</strong></li>
                            </ul>
                        </li>
                        <li>PQ automatically:
                            <ul>
                                <li>Includes new files</li>
                                <li>Applies decimal fixes</li>
                                <li>Adds <code>Check_N_lt_M</code> and <code>Sum_EF</code></li>
                                <li>Maintains column order</li>
                                <li>Recalculates grouped averages</li>
                            </ul>
                        </li>
                    </ol>
                `
            },

            {
                icon: "‚ö°",
                title: "Power Query ‚Äî Automating Combined Reports",
                content: `
                    <h3>üìã Overview</h3>
                    <p>Learn how to combine multiple Excel files (from the Splitter) into one master report using Power Query. This setup updates automatically when you add new files!</p>
                `
            },

            {
                icon: "üîÑ",
                title: "Google Sheets Sync ‚Äî Complete Setup Guide",
                content: `
                    <h3>üìã Overview</h3>
                    <p>The <strong>Sheets Sync</strong> feature allows you to import specific columns from Excel files directly into your Google Sheets. You can map individual columns to different positions, choose to append or overwrite data, and work with shared spreadsheets.</p>
                    
                    <h3>üîß Part 1: Setting Up Google Apps Script (One-Time Setup)</h3>
                    <p>To bypass complex authentication, we'll create a tiny "helper script" attached to your Google Sheet. this takes about 2 minutes.</p>
                    
                    <h3>Step 1: Open Your Google Sheet</h3>
                    <ol>
                        <li>Open the Google Sheet you want to write to.</li>
                        <li>In the top menu, click <strong>Extensions</strong> > <strong>Apps Script</strong>.</li>
                        <li>A new tab will open with a code editor.</li>
                    </ol>
                    
                    <h3>Step 2: Paste the Helper Script</h3>
                    <ol>
                        <li>Delete any code currently in the editor (like <code>function myFunction()...</code>).</li>
                        <li>Copy and paste the following code exactly:</li>
                    </ol>
                    <pre style="background: #f4f4f4; padding: 10px; font-size: 11px; overflow-x: auto; border-radius: 4px;"><code>/**
 * v5.0 - Ultimate Intelligent Sync Script
 * 1. Find last row based only on columns being mapped.
 * 2. Comply with manual Start Row if provided.
 * 3. Preserve existing Sheet headers.
 */
function doPost(e) {
  try {
    const params = JSON.parse(e.postData.contents);
    const ss = SpreadsheetApp.openById(params.spreadsheetId);
    let sheet = ss.getSheetByName(params.sheetName);
    
    if (!sheet) throw new Error("Sheet '" + params.sheetName + "' not found. Check for spaces!");

    const mappings = params.mappings;
    const dataRows = params.data; 
    const mode = params.mode;
    let startRow = params.startRow; 

    // Helper: Column Letter to Index (A=1)
    const colToIndex = (char) => {
      let code = 0;
      for (let i = 0; i < char.length; i++) {
        code = code * 26 + char.charCodeAt(i) - 64;
      }
      return code;
    };

    // INTELLIGENT ROW FINDER
    // If no startRow provided, find the real bottom of the data in the target columns
    if (!startRow || startRow < 1) {
      if (mode === 'overwrite') {
        startRow = 1;
      } else {
        // Append mode: Find last row by checking the first mapped column
        const firstColIndex = colToIndex(mappings[0].sheetsCol);
        const lastRowInCol = sheet.getRange(1, firstColIndex).getNextDataCell(SpreadsheetApp.Direction.DOWN).getRow();
        
        // Safety: If column is empty or getNextDataCell fails (returns sheet limit/1)
        if (lastRowInCol === sheet.getMaxRows() || lastRowInCol === 1) {
           // Fallback to standard getLastRow
           startRow = sheet.getLastRow() + 1;
        } else {
           startRow = lastRowInCol + 1;
        }
        
        if (startRow <= 1) startRow = 2; // Usually skip row 1 (headers)
      }
    }

    const numRows = dataRows.length;
    if (numRows === 0) return reply({ result: 'success', info: 'No data to write' });

    // Write column by column
    mappings.forEach(m => {
      const targetCol = colToIndex(m.sheetsCol);
      const colValues = dataRows.map(row => [row[m.excelCol] !== undefined ? row[m.excelCol] : ""]);
      
      // If Overwrite, clear existing column data from startRow down to prevent "leftover" data
      if (mode === 'overwrite') {
        const lastPossibleRow = sheet.getMaxRows();
        if (lastPossibleRow >= startRow) {
          sheet.getRange(startRow, targetCol, lastPossibleRow - startRow + 1, 1).clearContent();
        }
      }
      
      sheet.getRange(startRow, targetCol, colValues.length, 1).setValues(colValues);
    });

    SpreadsheetApp.flush();
    return reply({ result: 'success', startRowUsed: startRow, rowsSent: numRows });

  } catch (err) {
    return reply({ result: 'error', message: err.message });
  }
}

function reply(obj) {
  return ContentService.createTextOutput(JSON.stringify(obj)).setMimeType(ContentService.MimeType.JSON);
}

</code></pre>
                    <p><em>(Copy the code above. Note: Use the "Copy" button if available or select all and copy)</em></p>

                    <h3>Step 3: Deploy as Web App</h3>
                    <ol>
                        <li>Click the blue <strong>Deploy</strong> button (top right) > <strong>New deployment</strong>.</li>
                        <li>Click the "Select type" gear icon > <strong>Web app</strong>.</li>
                        <li>Description: "Excel Sync".</li>
                        <li>Execute as: <strong>Me</strong> (your email).</li>
                        <li>Who has access: <strong>Anyone</strong> (IMPORTANT! This allows the app to send data without login).</li>
                        <li>Click <strong>Deploy</strong>.</li>
                        <li>Authorize access if prompted (Click Review permissions > Select account > Advanced > Go to (unsafe) > Allow).</li>
                    </ol>

                    <h3>Step 4: Get Your Web App URL</h3>
                    <ol>
                        <li>Copy the <strong>Web App URL</strong> provided (ends in <code>/exec</code>).</li>
                        <li>Keep this URL safe!</li>
                    </ol>

                    <h3>üöÄ Part 2: Using the Sheets Sync Feature</h3>
                    
                    <h3>Step 1: Enter Web App URL</h3>
                    <ol>
                        <li>In the app, paste the URL into the green "Google Apps Script Web App URL" box.</li>
                    </ol>
                    
                    <h3>Step 2: Configure & Sync</h3>
                    <ol>
                        <li>Enter your Google Sheet URL/ID and Tab Name.</li>
                        <li>Upload Excel file.</li>
                        <li>Map columns and click Sync!</li>
                    </ol>
                    
                    <h3>üìä Part 2: Prepare Your Google Sheet</h3>
                    
                    <h3>Step 1: Open or Create Your Google Sheet</h3>
                    <ol>
                        <li>Go to <a href="https://sheets.google.com" target="_blank"><strong>sheets.google.com</strong></a></li>
                        <li>Open your existing spreadsheet or create a new one</li>
                        <li>Note the <strong>sheet tab name</strong> at the bottom (e.g., "Sheet1", "My Data", "Import")</li>
                    </ol>
                    
                    <h3>Step 2: Get the Spreadsheet URL or ID</h3>
                    <ol>
                        <li>Look at your browser's address bar</li>
                        <li>The URL looks like: <code>https://docs.google.com/spreadsheets/d/ABC123xyz789/edit</code></li>
                        <li>The part between <code>/d/</code> and <code>/edit</code> is your <strong>Spreadsheet ID</strong></li>
                        <li>You can copy either the full URL or just the ID ‚Äî the app accepts both!</li>
                    </ol>
                    <p><em>Note: With this Web App method, your sheet remains private! Only the script (running as you) can access it.</em></p>
                    
                    <h3>üöÄ Part 3: Using the Sheets Sync Feature</h3>
                    
                    <h3>Step 1: Enter Web App URL</h3>
                    <ol>
                        <li>Go to the <strong>"Sheets Sync"</strong> tab in this app.</li>
                        <li>Paste your <strong>Google Apps Script Web App URL</strong> into the green input box.</li>
                    </ol>
                    
                    <h3>Step 2: Configure & Sync</h3>
                    <ol>
                        <li>Enter your <strong>Google Sheets URL or ID</strong> in the next field.</li>
                        <li>Enter the <strong>Sheet Name</strong> (tab name) exactly as it appears.</li>
                        <li>Upload your Excel file and map the columns.</li>
                        <li>Click <strong>"üöÄ Sync to Google Sheets"</strong>.</li>
                    </ol>
                    
                    <h3>‚ùì Troubleshooting Common Issues</h3>
                    
                    <p><strong>Error: "Invalid URL" or Sync fails immediately</strong></p>
                    <ul>
                        <li>Make sure the URL starts with <code>https://script.google.com/macros/s/...</code></li>
                        <li>Ensure it ends with <code>/exec</code> (not /dev).</li>
                        <li>Did you deploy as "Who has access: <strong>Anyone</strong>"? This is required.</li>
                    </ul>
                    
                    <p><strong>Error: "Sheet not found"</strong></p>
                    <ul>
                        <li>Verify the sheet tab name matches exactly (case-sensitive!).</li>
                        <li>Check for extra spaces in the name (e.g., "Sheet1 " vs "Sheet1").</li>
                    </ul>
                    
                    <p><strong>Data not appearing?</strong></p>
                    <ul>
                        <li>Check if you have "Overwrite" selected (this clears previous data).</li>
                        <li>If "Append", scroll down to find the new rows.</li>
                    </ul>
                    
                    <p><strong>Data appears in wrong columns</strong></p>
                    <ul>
                        <li>Double-check your column letter mappings</li>
                        <li>Remember: A=1, B=2, C=3, etc.</li>
                        <li>Column letters are case-insensitive (a = A)</li>
                    </ul>
                    
                    <h3>üí° Pro Tips</h3>
                    <ul>
                        <li>Save your Web App URL in a secure place ‚Äî you'll need it each time</li>
                        <li>The Web App URL acts like a password for writing to your sheet, so don't share it publicly</li>
                        <li>Test with a small Excel file first before syncing large datasets</li>
                        <li>The app skips the first row of Excel (assumes it's a header row)</li>
                        <li>Empty cells in Excel are transferred as empty cells in Google Sheets</li>
                        <li>You can sync to any column position ‚Äî they don't need to be consecutive</li>
                    </ul>
                `
            },

            // TO ADD A NEW TOPIC: Copy the template below, uncomment it, and fill in your content
            /*
            {
                icon: "üéØ",  // Choose an emoji icon
                title: "Your Topic Title Here",
                content: `
                    <h3>Section Heading</h3>
                    <p>Your paragraph text here.</p>
                    
                    <h3>Another Section</h3>
                    <ul>
                        <li>List item 1</li>
                        <li>List item 2</li>
                    </ul>
                    
                    <p>Use <code>code tags</code> for technical terms.</p>
                `
            },
            */
        ];

        // ============= KNOWLEDGE BASE FUNCTIONS =============
        function renderKnowledgeBase() {
            const container = document.getElementById('kbTopics');
            container.innerHTML = '';

            knowledgeBaseTopics.forEach((topic, index) => {
                const topicDiv = document.createElement('div');
                topicDiv.className = 'kb-topic';
                topicDiv.dataset.index = index;

                topicDiv.innerHTML = `
                    <div class="kb-topic-header">
                        <div class="kb-topic-title">
                            <span class="kb-topic-icon">${topic.icon}</span>
                            <span>${topic.title}</span>
                        </div>
                        <!-- Arrow removed, handled by CSS ::after -->
                    </div>
                    <div class="kb-topic-content">
                        <div class="kb-topic-body">
                            ${topic.content}
                        </div>
                    </div>
                `;

                topicDiv.querySelector('.kb-topic-header').addEventListener('click', () => {
                    topicDiv.classList.toggle('open');
                });

                container.appendChild(topicDiv);
            });
        }

        // Background Toggle Logic
        function toggleBackground() {
            const isHidden = document.body.classList.toggle('no-bg');
            localStorage.setItem('eve_bg_hidden', isHidden);
            updateToggleUI(isHidden);
        }

        function updateToggleUI(isHidden) {
            const btn = document.getElementById('bgToggle');
            const icon = btn.querySelector('.icon');
            const text = btn.querySelector('.text');

            if (isHidden) {
                icon.src = 'images/favicon_munke.png';
                icon.classList.remove('large-scale');
                text.textContent = 'Show monkeys!';
            } else {
                icon.src = 'images/no_monkey_icon.png';
                icon.classList.add('large-scale');
                text.textContent = 'Hide monkeys!';
            }
        }

        // Initialize Everything
        document.addEventListener('DOMContentLoaded', () => {
            renderKnowledgeBase();

            // Init Background
            const bgHidden = localStorage.getItem('eve_bg_hidden') === 'true';
            if (bgHidden) {
                document.body.classList.add('no-bg');
            }
            updateToggleUI(bgHidden);

            document.getElementById('bgToggle').addEventListener('click', toggleBackground);

            const searchInput = document.getElementById('kbSearch');
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const topics = document.querySelectorAll('.kb-topic');

                topics.forEach(topic => {
                    const title = topic.querySelector('.kb-topic-title').textContent.toLowerCase();
                    const content = topic.querySelector('.kb-topic-body').textContent.toLowerCase();

                    if (title.includes(searchTerm) || content.includes(searchTerm)) {
                        topic.style.display = 'block';
                        if (searchTerm.length > 2) {
                            topic.classList.add('open');
                        }
                    } else {
                        topic.style.display = 'none';
                    }
                });

                if (searchTerm === '') {
                    topics.forEach(topic => {
                        topic.style.display = 'block';
                        topic.classList.remove('open');
                    });
                }
            });
        });

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const targetTab = tab.dataset.tab;

                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                tab.classList.add('active');
                document.getElementById(targetTab).classList.add('active');
            });
        });

        // ============= TAB 1: EXCEL SPLITTER =============
        let workbook1 = null;
        let data1 = null;
        let outputHandle1 = null;
        const supportsFS = 'showDirectoryPicker' in window;

        const uploadArea1 = document.getElementById('uploadArea1');
        const fileInput1 = document.getElementById('fileInput1');
        const fileInfo1 = document.getElementById('fileInfo1');
        const fileName1 = document.getElementById('fileName1');
        const fileDetails1 = document.getElementById('fileDetails1');
        const columnSection1 = document.getElementById('columnSection1');
        const splitColumn1 = document.getElementById('splitColumn1');
        const outputSection1 = document.getElementById('outputSection1');
        const selectFolder1 = document.getElementById('selectFolder1');
        const folderName1 = document.getElementById('folderName1');
        const buttonGroup1 = document.getElementById('buttonGroup1');
        const processFolder1 = document.getElementById('processFolder1');
        const processZip1 = document.getElementById('processZip1');
        const progress1 = document.getElementById('progress1');
        const progressFill1 = document.getElementById('progressFill1');
        const status1 = document.getElementById('status1');
        const sheetSelector1Container = document.getElementById('sheetSelector1Container');
        const excelSheetSelect1 = document.getElementById('excelSheetSelect1');

        uploadArea1.addEventListener('click', () => fileInput1.click());

        uploadArea1.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea1.classList.add('dragover');
        });

        uploadArea1.addEventListener('dragleave', () => {
            uploadArea1.classList.remove('dragover');
        });

        uploadArea1.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea1.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                handleFile1(e.dataTransfer.files[0]);
            }
        });

        fileInput1.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile1(e.target.files[0]);
            }
        });

        splitColumn1.addEventListener('change', () => {
            if (splitColumn1.value !== '') {
                if (supportsFS) {
                    outputSection1.classList.remove('hidden');
                } else {
                    buttonGroup1.classList.remove('hidden');
                    processZip1.style.display = 'block';
                }
            }
        });

        selectFolder1.addEventListener('click', selectOutputFolder1);
        processFolder1.addEventListener('click', () => processSplit1('folder'));
        processZip1.addEventListener('click', () => processSplit1('zip'));

        function handleFile1(file) {
            if (!file.name.endsWith('.xlsx')) {
                showStatus1('Please select an Excel file (.xlsx)', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    workbook1 = XLSX.read(e.target.result, { type: 'binary' });

                    // Populate sheet selector
                    excelSheetSelect1.innerHTML = '';
                    workbook1.SheetNames.forEach((name) => {
                        const option = document.createElement('option');
                        option.value = name;
                        option.textContent = name;
                        excelSheetSelect1.appendChild(option);
                    });

                    if (workbook1.SheetNames.length > 1) {
                        sheetSelector1Container.classList.remove('hidden');
                    } else {
                        sheetSelector1Container.classList.add('hidden');
                    }

                    // Process the first sheet by default
                    processWorksheet1(workbook1.SheetNames[0]);

                    fileName1.textContent = file.name;
                    fileInfo1.classList.add('show');
                    status1.classList.remove('show');
                } catch (error) {
                    showStatus1('Error reading file: ' + error.message, 'error');
                }
            };
            reader.readAsBinaryString(file);
        }

        // Handle sheet change in Excel Splitter
        excelSheetSelect1.addEventListener('change', (e) => {
            if (workbook1) {
                processWorksheet1(e.target.value);
            }
        });

        function processWorksheet1(sheetName) {
            try {
                const worksheet = workbook1.Sheets[sheetName];
                if (!worksheet) return;

                data1 = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                if (data1.length === 0) {
                    showStatus1(`The sheet "${sheetName}" is empty!`, 'warning');
                    return;
                }

                const headers = data1[0];
                fileDetails1.textContent = `${data1.length - 1} rows, ${headers.length} columns`;

                splitColumn1.innerHTML = '<option value="">-- Select a column --</option>';
                headers.forEach((header, index) => {
                    const colLetter = getColumnLetter(index);
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = `${colLetter}: ${header || `Column ${index + 1}`}`;
                    splitColumn1.appendChild(option);
                });

                columnSection1.classList.remove('hidden');

                // Reset output sections if switching sheets
                outputSection1.classList.add('hidden');
                buttonGroup1.classList.add('hidden');
                folderName1.textContent = '';

                showStatus1(`Sheet "${sheetName}" loaded! Found ${headers.length} columns. Choose a column to split by.`, 'success');
            } catch (error) {
                showStatus1('Error processing sheet: ' + error.message, 'error');
            }
        }

        async function selectOutputFolder1() {
            if (!('showDirectoryPicker' in window)) {
                showStatus1('Folder selection is not supported in this browser. Use ZIP mode instead.', 'warning');
                buttonGroup1.classList.remove('hidden');
                processFolder1.style.display = 'none';
                processZip1.style.display = 'block';
                return;
            }

            try {
                outputHandle1 = await window.showDirectoryPicker();
                folderName1.textContent = `‚úì Selected: ${outputHandle1.name}`;
                buttonGroup1.classList.remove('hidden');
                processFolder1.style.display = 'block';
                processZip1.style.display = 'block';
            } catch (error) {
                if (error.name !== 'AbortError') {
                    showStatus1('Folder selection unavailable. Use ZIP mode instead. (' + error.message + ')', 'warning');
                    buttonGroup1.classList.remove('hidden');
                    processFolder1.style.display = 'none';
                    processZip1.style.display = 'block';
                }
            }
        }

        function sanitizeFilename(name) {
            if (!name || name.trim() === '') return null;
            let sanitized = String(name).trim()
                .replace(/[<>:"\/\\|?*]/g, '_')
                .replace(/^[.\s]+|[.\s]+$/g, '');
            if (sanitized.length > 200) {
                sanitized = sanitized.substring(0, 200);
            }
            return sanitized || null;
        }

        async function processSplit1(mode) {
            const columnIndex = parseInt(splitColumn1.value);

            if (isNaN(columnIndex)) {
                showStatus1('Please select a split column first', 'error');
                return;
            }

            if (mode === 'folder' && !outputHandle1) {
                showStatus1('Please select an output folder first', 'error');
                return;
            }

            showStatus1('Processing...', 'info');
            processFolder1.disabled = true;
            processZip1.disabled = true;
            progress1.classList.add('show');

            try {
                const headers = data1[0];
                const rows = data1.slice(1);
                const groups = {};
                let skippedRows = 0;

                rows.forEach(row => {
                    const criteriaValue = row[columnIndex];
                    const sanitized = sanitizeFilename(criteriaValue);

                    if (!sanitized) {
                        skippedRows++;
                        return;
                    }

                    if (!groups[sanitized]) {
                        groups[sanitized] = [];
                    }
                    groups[sanitized].push(row);
                });

                const uniqueValues = Object.keys(groups);

                if (mode === 'folder') {
                    await processToFolder1(uniqueValues, groups, headers);
                } else {
                    await processToZip1(uniqueValues, groups, headers);
                }

                let message = `‚úì Successfully created ${uniqueValues.length} file(s)`;
                if (skippedRows > 0) {
                    message += ` (${skippedRows} rows with empty values were skipped)`;
                }

                showStatus1(message, 'success');
                progress1.classList.remove('show');
            } catch (error) {
                showStatus1('Error processing file: ' + error.message, 'error');
                progress1.classList.remove('show');
            }

            processFolder1.disabled = false;
            processZip1.disabled = false;
        }

        async function processToFolder1(uniqueValues, groups, headers) {
            let processed = 0;

            for (const value of uniqueValues) {
                const valueRows = groups[value];
                const rowCount = valueRows.length;
                const newData = [headers, ...valueRows];
                const newWorksheet = XLSX.utils.aoa_to_sheet(newData);
                const newWorkbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(newWorkbook, newWorksheet, 'Sheet1');

                const filename = `${value}_${rowCount}.xlsx`;
                const wbout = XLSX.write(newWorkbook, { bookType: 'xlsx', type: 'array' });

                const fileHandle = await outputHandle1.getFileHandle(filename, { create: true });
                const writable = await fileHandle.createWritable();
                await writable.write(wbout);
                await writable.close();

                processed++;
                const percent = Math.round((processed / uniqueValues.length) * 100);
                progressFill1.style.width = percent + '%';
                progressFill1.textContent = percent + '%';
            }
        }

        async function processToZip1(uniqueValues, groups, headers) {
            const zip = new JSZip();
            let processed = 0;

            for (const value of uniqueValues) {
                const valueRows = groups[value];
                const rowCount = valueRows.length;
                const newData = [headers, ...valueRows];
                const newWorksheet = XLSX.utils.aoa_to_sheet(newData);
                const newWorkbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(newWorkbook, newWorksheet, 'Sheet1');

                const filename = `${value}_${rowCount}.xlsx`;
                const wbout = XLSX.write(newWorkbook, { bookType: 'xlsx', type: 'array' });
                zip.file(filename, wbout);

                processed++;
                const percent = Math.round((processed / uniqueValues.length) * 100);
                progressFill1.style.width = percent + '%';
                progressFill1.textContent = percent + '%';

                await new Promise(resolve => setTimeout(resolve, 10));
            }

            const zipBlob = await zip.generateAsync({ type: 'blob' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(zipBlob);
            link.download = 'split_files.zip';
            link.click();
        }

        function showStatus1(message, type) {
            status1.textContent = message;
            status1.className = 'status show ' + type;
        }

        // ============= TAB 2: EMAIL GENERATOR =============
        let inputHandle2 = null;
        let outputHandle2 = null;
        let excelFiles2 = [];
        let useFallbackMode2 = false; // Tracks if we are using the fallback (no FS API)

        const selectInput2 = document.getElementById('selectInput2');
        const fallbackInput2 = document.getElementById('fallbackInput2');
        const inputFolder2 = document.getElementById('inputFolder2');
        const fileList2 = document.getElementById('fileList2');
        const emailConfig2 = document.getElementById('emailConfig2');
        const columnSection2 = document.getElementById('columnSection2');
        const emailColumn2 = document.getElementById('emailColumn2');
        const outputSection2 = document.getElementById('outputSection2');
        const selectOutput2 = document.getElementById('selectOutput2');
        const outputFolder2 = document.getElementById('outputFolder2');
        const generate2 = document.getElementById('generate2');
        const progress2 = document.getElementById('progress2');
        const progressFill2 = document.getElementById('progressFill2');
        const status2 = document.getElementById('status2');

        selectInput2.addEventListener('click', selectInputFolder2);
        fallbackInput2.addEventListener('change', handleFallbackFiles2);
        selectOutput2.addEventListener('click', selectOutputFolder2);
        generate2.addEventListener('click', generateEmails2);

        emailColumn2.addEventListener('change', () => {
            if (emailColumn2.value !== '') {
                // In fallback mode, we don't need output handle immediately (will zip)
                if (useFallbackMode2 || outputHandle2) {
                    generate2.disabled = false;
                }
            }
        });

        async function selectInputFolder2() {
            // Reset fallback mode
            useFallbackMode2 = false;

            if ('showDirectoryPicker' in window) {
                try {
                    inputHandle2 = await window.showDirectoryPicker();
                    inputFolder2.textContent = `‚úì Selected: ${inputHandle2.name}`;
                    await loadExcelFiles2();
                } catch (error) {
                    if (error.name === 'AbortError') return;
                    // If some other error or user cancels, or restricted?
                    // Fallback to input click if it seems like a permission/support issue?
                    // Usually AbortError is just cancel. 
                    // Let's assume explicit error means "try fallback" or show error.
                    // For now, if showDirectoryPicker fails/user denies, we could suggest fallback.
                    // But simpler: just try-catch and if error is not abort, maybe fallback?
                    // Actually, safest is: if API exists, try it. If it throws "SecurityError" etc, try fallback.
                    console.warn("Directory Picker failed/cancelled, checking legacy input...", error);
                    // Force fallback if error was not abort? 
                    // Let's just encourage user to use the fallback if they prefer.
                    // Actually, improving robustness: prompt user? 
                    // No, let's keep it simple: If API calls fail, we can't easily auto-switch to file input click (trusted event).
                    // We'll rely on the user. 
                    // WAIT: User said "work pc where there might be some permission issues".
                    // Code below handles the flow where we switch to fallback if desired.
                    fallbackInput2.click();
                }
            } else {
                // API not supported
                fallbackInput2.click();
            }
        }

        function handleFallbackFiles2(e) {
            const files = Array.from(e.target.files);
            if (files.length > 0) {
                useFallbackMode2 = true;
                inputFolder2.textContent = `‚úì Selected: ${files.length} file(s)`;

                // Wrap files to look like handles
                excelFiles2 = files.map(f => ({
                    kind: 'file',
                    name: f.name,
                    getFile: async () => f
                }));

                processLoadedFiles2();
            }
        }

        async function loadExcelFiles2() {
            excelFiles2 = [];
            fileList2.innerHTML = '';

            try {
                for await (const entry of inputHandle2.values()) {
                    if (entry.kind === 'file' && entry.name.endsWith('.xlsx')) {
                        excelFiles2.push(entry);
                    }
                }
                processLoadedFiles2();
            } catch (error) {
                showStatus2('Error reading folder: ' + error.message, 'error');
                // Try fallback?
                fallbackInput2.click();
            }
        }

        async function processLoadedFiles2() {
            fileList2.innerHTML = '';

            // Sort alphabetically
            excelFiles2.sort((a, b) => a.name.localeCompare(b.name));

            if (excelFiles2.length === 0) {
                showStatus2('No Excel files found', 'error');
                return;
            }

            excelFiles2.forEach(entry => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.textContent = `üìÑ ${entry.name}`;
                fileList2.appendChild(fileItem);
            });

            showStatus2(`Found ${excelFiles2.length} Excel file(s)`, 'success');
            await loadColumnNames2();
            emailConfig2.classList.remove('hidden');
            outputSection2.classList.remove('hidden');
            generate2.classList.remove('hidden');

            // Adjust UI for fallback
            if (useFallbackMode2) {
                const outBtn = document.getElementById('selectOutput2');
                outBtn.textContent = "(Optional) Select Output Folder";
                // Update help text
                document.getElementById('outputFolder2').innerHTML = "<em>If no folder selected, files will download as ZIP.</em>";
            }
        }

        async function loadColumnNames2() {
            try {
                const firstFile = excelFiles2[0];
                const file = await firstFile.getFile();
                const arrayBuffer = await file.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const data = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                if (data.length > 0) {
                    const headers = data[0];
                    emailColumn2.innerHTML = '<option value="">-- Select a column --</option>';
                    headers.forEach((header, index) => {
                        const option = document.createElement('option');
                        option.value = index;
                        option.textContent = header || `Column ${index + 1}`;
                        emailColumn2.appendChild(option);
                    });
                    columnSection2.classList.remove('hidden');
                }
            } catch (error) {
                showStatus2('Error reading Excel file: ' + error.message, 'error');
            }
        }

        async function selectOutputFolder2() {
            if (!('showDirectoryPicker' in window)) {
                useFallbackMode2 = true;
                outputHandle2 = null;
                const outBtn = document.getElementById('selectOutput2');
                outBtn.textContent = "(Optional) Select Output Folder";
                outputFolder2.innerHTML = "<em>Folder selection is not supported. Files will download as ZIP.</em>";
                showStatus2('Folder selection is not supported. ZIP mode will be used.', 'warning');
                if (emailColumn2.value !== '') {
                    generate2.disabled = false;
                }
                return;
            }

            try {
                outputHandle2 = await window.showDirectoryPicker();
                outputFolder2.textContent = `‚úì Selected: ${outputHandle2.name}`;
                if (emailColumn2.value !== '') {
                    generate2.disabled = false;
                }
            } catch (error) {
                if (error.name !== 'AbortError') {
                    useFallbackMode2 = true;
                    outputHandle2 = null;
                    const outBtn = document.getElementById('selectOutput2');
                    outBtn.textContent = "(Optional) Select Output Folder";
                    outputFolder2.innerHTML = "<em>Folder selection is unavailable. Files will download as ZIP.</em>";
                    showStatus2('Folder selection unavailable. ZIP mode will be used. (' + error.message + ')', 'warning');
                }
                // If fallback mode, we can proceed without output folder (Zip mode)
                if (useFallbackMode2) {
                    if (emailColumn2.value !== '') {
                        generate2.disabled = false;
                    }
                }
            }
        }

        async function generateEmails2() {
            const emailColumnIndex = parseInt(emailColumn2.value);

            if (isNaN(emailColumnIndex)) {
                showStatus2('Please select an email column', 'error');
                return;
            }

            if (!outputHandle2 && !useFallbackMode2) {
                // In normal mode, require folder. In fallback, we'll zip.
                // Actually, let's allow Zip even in normal mode if no folder selected?
                // For now, strict check unless fallback mode, or just ask user?
                // Let's assume if handle is null, do zip.
            }

            // If no output handle, we defaults to ZIP
            const isZipMode = !outputHandle2;

            generate2.disabled = true;
            showStatus2(isZipMode ? 'Generating ZIP...' : 'Generating email files...', 'info');
            progress2.classList.add('show');

            try {
                let processed = 0;
                let filesProcessed = 0;
                let skippedFiles = 0;
                const subject = document.getElementById('emailSubject2').value || 'Report';
                const body = document.getElementById('emailBody2').value || '';
                const cc = document.getElementById('ccEmail2').value || '';

                const zip = isZipMode ? new JSZip() : null;

                for (const fileEntry of excelFiles2) {
                    const file = await fileEntry.getFile();
                    const arrayBuffer = await file.arrayBuffer();
                    const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const data = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                    const emails = [];
                    for (let i = 1; i < data.length; i++) {
                        const email = data[i][emailColumnIndex];
                        if (email && email.toString().includes('@')) {
                            emails.push(email.toString().trim());
                        }
                    }

                    const uniqueEmails = [...new Set(emails)];

                    if (uniqueEmails.length === 0) {
                        console.warn(`No valid emails found in ${file.name}`);
                        skippedFiles++;
                        filesProcessed++;
                        const percent = Math.round((filesProcessed / excelFiles2.length) * 100);
                        progressFill2.style.width = percent + '%';
                        progressFill2.textContent = percent + '%';
                        continue;
                    }

                    const attachmentFile = await fileEntry.getFile();
                    const attachmentBuffer = await attachmentFile.arrayBuffer();

                    const emailFileName = file.name.replace('.xlsx', '.eml');
                    const emailSubject = subject.replace('{{filename}}', file.name.replace('.xlsx', ''));

                    const emlContent = await createEMLFile(
                        uniqueEmails.join(', '),
                        cc,
                        emailSubject,
                        body,
                        attachmentBuffer,
                        file.name
                    );

                    if (isZipMode) {
                        zip.file(emailFileName, emlContent);
                    } else {
                        const emlFileHandle = await outputHandle2.getFileHandle(emailFileName, { create: true });
                        const writable = await emlFileHandle.createWritable();
                        await writable.write(emlContent);
                        await writable.close();
                    }

                    processed++;
                    filesProcessed++;
                    const percent = Math.round((filesProcessed / excelFiles2.length) * 100);
                    progressFill2.style.width = percent + '%';
                    progressFill2.textContent = percent + '%';
                }

                if (isZipMode && processed > 0) {
                    showStatus2('Zipping files...', 'info');
                    const zipBlob = await zip.generateAsync({ type: 'blob' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(zipBlob);
                    link.download = 'generated_emails.zip';
                    link.click();
                }

                let message = `‚úì Successfully created ${processed} email file(s)${isZipMode ? ' (ZIP)' : ''}`;
                if (skippedFiles > 0) {
                    message += ` (${skippedFiles} file(s) skipped due to missing emails)`;
                }
                showStatus2(message, 'success');
                progress2.classList.remove('show');
            } catch (error) {
                showStatus2('Error generating emails: ' + error.message, 'error');
                progress2.classList.remove('show');
            }

            generate2.disabled = false;
        }

        async function createEMLFile(to, cc, subject, body, attachmentBuffer, attachmentName) {
            const boundary = '----=_NextPart_' + Date.now();
            const attachmentData = arrayBufferToBase64(attachmentBuffer);

            const normalizedBody = body.replace(/\r?\n/g, '\r\n');

            let eml = 'From: <your.email@example.com>\r\n';
            eml += 'To: ' + to + '\r\n';

            if (cc) {
                eml += 'Cc: ' + cc + '\r\n';
            }

            eml += 'Subject: ' + subject + '\r\n';
            eml += 'MIME-Version: 1.0\r\n';
            eml += 'Content-Type: multipart/mixed; boundary="' + boundary + '"\r\n';
            eml += '\r\n';

            eml += '--' + boundary + '\r\n';
            eml += 'Content-Type: text/plain; charset="UTF-8"\r\n';
            eml += 'Content-Transfer-Encoding: 7bit\r\n';
            eml += '\r\n';
            eml += normalizedBody + '\r\n';

            eml += '--' + boundary + '\r\n';
            eml += 'Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet; name="' + attachmentName + '"\r\n';
            eml += 'Content-Transfer-Encoding: base64\r\n';
            eml += 'Content-Disposition: attachment; filename="' + attachmentName + '"\r\n';
            eml += '\r\n';
            eml += attachmentData + '\r\n';

            eml += '--' + boundary + '--\r\n';

            return eml;
        }

        function arrayBufferToBase64(buffer) {
            let binary = '';
            const bytes = new Uint8Array(buffer);
            const len = bytes.byteLength;
            for (let i = 0; i < len; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            const base64 = btoa(binary);
            const lines = base64.match(/.{1,76}/g) || [];
            return lines.join('\r\n');
        }

        function showStatus2(message, type) {
            status2.textContent = message;
            status2.className = 'status show ' + type;
        }

        // ============= TAB 4: GOOGLE SHEETS SYNC =============
        let workbook4 = null;
        let data4 = null;
        let headers4 = [];
        let columnMappings4 = [];

        // DOM Elements
        const uploadArea4 = document.getElementById('uploadArea4');
        const fileInput4 = document.getElementById('fileInput4');
        const fileInfo4 = document.getElementById('fileInfo4');
        const fileName4 = document.getElementById('fileName4');
        const fileDetails4 = document.getElementById('fileDetails4');
        const modeSection4 = document.getElementById('modeSection4');
        const mappingSection4 = document.getElementById('mappingSection4');
        const mappingRows4 = document.getElementById('mappingRows4');
        const addMapping4 = document.getElementById('addMapping4');
        const syncBtn4 = document.getElementById('syncBtn4');
        const progress4 = document.getElementById('progress4');
        const progressFill4 = document.getElementById('progressFill4');
        const status4 = document.getElementById('status4');
        const webAppUrl4 = document.getElementById('webAppUrl4');
        const sheetsUrl4 = document.getElementById('sheetsUrl4');
        const sheetName4 = document.getElementById('sheetName4');
        const startRow4 = document.getElementById('startRow4');
        const sheetSelector4Container = document.getElementById('sheetSelector4Container');
        const excelSheetSelect4 = document.getElementById('excelSheetSelect4');

        // Radio button styling (Updated for Card UI)
        document.querySelectorAll('input[name="importMode4"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                document.querySelectorAll('.mode-card').forEach(opt => opt.classList.remove('selected'));
                e.target.closest('.mode-card').classList.add('selected');
            });
        });

        // Load saved settings from localStorage
        window.addEventListener('load', () => {
            const savedWebAppUrl = localStorage.getItem('eve_webAppUrl');
            const savedSheetsUrl = localStorage.getItem('eve_sheetsUrl');
            const savedSheetName = localStorage.getItem('eve_sheetName');

            if (savedWebAppUrl) webAppUrl4.value = savedWebAppUrl;
            if (savedSheetsUrl) sheetsUrl4.value = savedSheetsUrl;
            if (savedSheetName) sheetName4.value = savedSheetName;
        });

        // File upload handlers
        uploadArea4.addEventListener('click', () => fileInput4.click());

        uploadArea4.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea4.classList.add('dragover');
        });

        uploadArea4.addEventListener('dragleave', () => {
            uploadArea4.classList.remove('dragover');
        });

        uploadArea4.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea4.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                handleFile4(e.dataTransfer.files[0]);
            }
        });

        fileInput4.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile4(e.target.files[0]);
            }
        });

        function handleFile4(file) {
            if (!file.name.endsWith('.xlsx')) {
                showStatus4('Please select an Excel file (.xlsx)', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    workbook4 = XLSX.read(e.target.result, { type: 'binary' });

                    // Populate sheet selector
                    excelSheetSelect4.innerHTML = '';
                    workbook4.SheetNames.forEach((name, index) => {
                        const option = document.createElement('option');
                        option.value = name;
                        option.textContent = name;
                        excelSheetSelect4.appendChild(option);
                    });

                    if (workbook4.SheetNames.length > 1) {
                        sheetSelector4Container.classList.remove('hidden');
                    } else {
                        sheetSelector4Container.classList.add('hidden');
                    }

                    // Process the first sheet by default
                    processWorksheet4(workbook4.SheetNames[0]);

                    fileName4.textContent = file.name;
                    fileInfo4.classList.add('show');

                    // Show configuration sections
                    modeSection4.classList.remove('hidden');
                    mappingSection4.classList.remove('hidden');
                    syncBtn4.classList.remove('hidden');

                } catch (error) {
                    showStatus4('Error reading file: ' + error.message, 'error');
                }
            };
            reader.readAsBinaryString(file);
        }

        // Handle sheet change in Excel
        excelSheetSelect4.addEventListener('change', (e) => {
            if (workbook4) {
                processWorksheet4(e.target.value);
            }
        });

        function processWorksheet4(sheetName) {
            try {
                const worksheet = workbook4.Sheets[sheetName];
                if (!worksheet) return;

                // Get the actual range of the worksheet to find all columns
                const range = XLSX.utils.decode_range(worksheet['!ref'] || 'A1');
                const totalColumns = range.e.c + 1; // End column index + 1

                // Read data with defval to preserve empty cells
                data4 = XLSX.utils.sheet_to_json(worksheet, {
                    header: 1,
                    defval: '',  // Use empty string for empty cells
                    blankrows: true  // Include blank rows
                });

                if (data4.length === 0) {
                    showStatus4(`The sheet "${sheetName}" is empty!`, 'warning');
                    return;
                }

                // Get headers from first row, ensuring we have all columns
                const firstRow = data4[0] || [];
                headers4 = [];

                // Create headers array with proper length, filling in missing headers
                for (let i = 0; i < totalColumns; i++) {
                    headers4[i] = firstRow[i] !== undefined && firstRow[i] !== ''
                        ? firstRow[i]
                        : `(Column ${getColumnLetter(i)})`;
                }

                fileDetails4.textContent = `${data4.length - 1} rows, ${totalColumns} columns (A to ${getColumnLetter(totalColumns - 1)})`;

                // Clear previous mappings and add one default mapping
                mappingRows4.innerHTML = '';
                columnMappings4 = [];
                addMappingRow4();

                showStatus4(`Sheet "${sheetName}" loaded! Found ${totalColumns} columns. Configure column mappings below.`, 'success');
            } catch (error) {
                showStatus4('Error processing sheet: ' + error.message, 'error');
            }
        }

        // Add mapping button handler
        addMapping4.addEventListener('click', addMappingRow4);

        function addMappingRow4() {
            const rowIndex = columnMappings4.length;
            const mappingId = 'mapping_' + Date.now() + '_' + rowIndex;

            columnMappings4.push({ excelCol: 0, sheetsCol: 'A' });

            const row = document.createElement('div');
            row.className = 'mapping-row';
            row.id = mappingId;

            // Build options using DOM to properly escape text
            const selectEl = document.createElement('select');
            selectEl.className = 'excel-select';
            selectEl.onchange = function () { updateMapping4(mappingId, 'excel', this.value); };

            headers4.forEach((header, index) => {
                const colLetter = getColumnLetter(index);
                const option = document.createElement('option');
                option.value = index;
                // Sanitize header: convert to string, trim, remove newlines/special chars
                let headerText = String(header || '').trim();
                headerText = headerText.replace(/[\r\n\t]+/g, ' '); // Replace newlines/tabs with space
                headerText = headerText.replace(/\s+/g, ' '); // Collapse multiple spaces
                if (!headerText) {
                    headerText = '(empty)';
                }
                option.textContent = `${colLetter}: ${headerText}`;
                selectEl.appendChild(option);
            });

            // Build the row structure using DOM manipulation
            const excelColDiv = document.createElement('div');
            excelColDiv.className = 'excel-col';
            excelColDiv.appendChild(selectEl);

            const arrowDiv = document.createElement('div');
            arrowDiv.className = 'arrow';
            arrowDiv.textContent = '‚Üí';

            const sheetsInput = document.createElement('input');
            sheetsInput.type = 'text';
            sheetsInput.className = 'column-letter-input sheets-input';
            sheetsInput.value = getColumnLetter(rowIndex);
            sheetsInput.placeholder = 'A';
            sheetsInput.maxLength = 3;
            sheetsInput.onchange = function () { updateMapping4(mappingId, 'sheets', this.value); };

            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-mapping';
            removeBtn.textContent = '‚úï';
            removeBtn.onclick = function () { removeMappingRow4(mappingId); };

            row.appendChild(excelColDiv);
            row.appendChild(arrowDiv);
            row.appendChild(sheetsInput);
            row.appendChild(removeBtn);

            mappingRows4.appendChild(row);
            columnMappings4[columnMappings4.length - 1].sheetsCol = getColumnLetter(rowIndex);
        }

        function updateMapping4(mappingId, type, value) {
            const rows = Array.from(mappingRows4.children);
            const index = rows.findIndex(r => r.id === mappingId);
            if (index !== -1) {
                if (type === 'excel') {
                    columnMappings4[index].excelCol = parseInt(value);
                } else {
                    columnMappings4[index].sheetsCol = value.toUpperCase();
                }
            }
        }

        function removeMappingRow4(mappingId) {
            const rows = Array.from(mappingRows4.children);
            const index = rows.findIndex(r => r.id === mappingId);
            if (index !== -1) {
                rows[index].remove();
                columnMappings4.splice(index, 1);
            }
        }

        function getColumnLetter(index) {
            let letter = '';
            while (index >= 0) {
                letter = String.fromCharCode((index % 26) + 65) + letter;
                index = Math.floor(index / 26) - 1;
            }
            return letter;
        }

        function columnLetterToIndex(letter) {
            let index = 0;
            for (let i = 0; i < letter.length; i++) {
                index = index * 26 + letter.charCodeAt(i) - 64;
            }
            return index - 1;
        }

        function extractSpreadsheetId(input) {
            // Handle full URLs
            const urlMatch = input.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
            if (urlMatch) {
                return urlMatch[1];
            }
            // Assume it's already an ID
            return input.trim();
        }

        // Sync button handler
        syncBtn4.addEventListener('click', syncToGoogleSheets);

        async function syncToGoogleSheets() {
            const webAppUrl = webAppUrl4.value.trim();
            const sheetsInput = sheetsUrl4.value.trim();
            const targetSheetName = sheetName4.value.trim() || 'Sheet1';

            // Robust Configuration Detection
            const isAppend = document.getElementById('modeAppend4').checked;
            const importMode = isAppend ? 'append' : 'overwrite';
            const includeHeaders = document.getElementById('includeHeaders4').checked;
            const customStartRow = startRow4.value.trim();

            let dataRows = data4;
            let rowOverride = null;

            // Slicing & StartRow Logic:
            if (isAppend) {
                // Append Mode: Always skip row 1 of Excel
                dataRows = data4.slice(1);
            } else {
                // Overwrite Mode
                if (!includeHeaders) {
                    // Skip row 1 of Excel
                    dataRows = data4.slice(1);
                    // Default to Row 2 of Sheet to preserve existing headers
                    if (!customStartRow) rowOverride = 2;
                }
            }

            // Validation
            if (!webAppUrl) {
                showStatus4('Please enter your Google Apps Script Web App URL', 'error');
                return;
            }

            if (!webAppUrl.includes('script.google.com')) {
                showStatus4('Invalid URL. The URL should start with https://script.google.com/...', 'error');
                return;
            }

            if (!sheetsInput) {
                showStatus4('Please enter the Google Sheets URL or ID', 'error');
                return;
            }

            if (columnMappings4.length === 0) {
                showStatus4('Please add at least one column mapping', 'error');
                return;
            }

            const spreadsheetId = extractSpreadsheetId(sheetsInput);

            syncBtn4.disabled = true;
            const finalStartRow = customStartRow ? parseInt(customStartRow) : (rowOverride || null);
            const modeText = importMode === 'append' ? 'Appending' : 'Overwriting';
            const rowText = finalStartRow ? `(starting row ${finalStartRow})` : '(auto-detect row)';

            showStatus4(`Preparing to Sync (${modeText} ${rowText})...`, 'info');
            progress4.classList.add('show');
            progressFill4.style.width = '10%';
            progressFill4.textContent = '10%';

            try {
                // Create column mapping info for the Apps Script
                const mappings = columnMappings4.map(m => ({
                    excelCol: m.excelCol,
                    sheetsCol: m.sheetsCol
                }));

                // Prepare the data to send
                const payload = {
                    spreadsheetId: spreadsheetId,
                    sheetName: targetSheetName,
                    mode: importMode,
                    startRow: finalStartRow,
                    mappings: mappings,
                    data: dataRows
                };

                // Warn about large data size
                if (dataRows.length > 5000) {
                    const proceed = confirm(`‚ö†Ô∏è Large Dataset Detected (${dataRows.length} rows)\n\nGoogle Apps Script may timeout with this much data (>5000 rows). It's recommended to split your data or sync in smaller batches.\n\nDo you want to try anyway?`);
                    if (!proceed) {
                        syncBtn4.disabled = false;
                        progress4.classList.remove('show');
                        return;
                    }
                }

                progressFill4.style.width = '30%';
                progressFill4.textContent = '30%';
                showStatus4('Sending data to Google Sheets...', 'info');

                progressFill4.style.width = '50%';
                progressFill4.textContent = '50%';

                // Send data to the Web App
                const response = await fetch(webAppUrl, {
                    method: 'POST',
                    mode: 'no-cors', // Required for Apps Script
                    headers: {
                        'Content-Type': 'text/plain',
                    },
                    body: JSON.stringify(payload)
                });

                progressFill4.style.width = '90%';
                progressFill4.textContent = '90%';

                // Note: with no-cors, we can't read the response, so we assume success
                // The user can check the sheet to verify

                progressFill4.style.width = '100%';
                progressFill4.textContent = '100%';

                showStatus4(`‚úì Data sent to Google Sheets!\n\nMode: ${modeText}\nSheet: ${targetSheetName}\nRows sent: ${dataRows.length}`, 'success');

                // SAVE SETTINGS TO LOCAL STORAGE ON SUCCESS
                localStorage.setItem('eve_webAppUrl', webAppUrl);
                localStorage.setItem('eve_sheetsUrl', sheetsInput);
                localStorage.setItem('eve_sheetName', targetSheetName);

                setTimeout(() => {
                    progress4.classList.remove('show');
                }, 2000);

            } catch (error) {
                showStatus4('Error: ' + error.message, 'error');
                progress4.classList.remove('show');
            }

            syncBtn4.disabled = false;
        }

        function showStatus4(message, type) {
            status4.textContent = message;
            status4.className = 'status show ' + type;
            status4.style.whiteSpace = 'pre-line';
        }
    </script>
</body>

</html>
